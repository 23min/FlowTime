@using FlowTime.UI.Services
@using System.Globalization
@using Microsoft.JSInterop
@inject ISimResultsService SimResults
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject FeatureFlagService FeatureFlags

<MudStack Spacing="4">
    @if (Result != null)
    {
        <MudCard Outlined="true">
            <MudCardContent>
                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">Simulation Results</MudText>
                    <MudChip T="string" Color="@GetStatusColor(Result.Status)" Size="Size.Small">
                        @Result.Status.ToUpperInvariant()
                    </MudChip>
                </MudStack>
                
                <MudGrid>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption">Run ID</MudText>
                        <MudText Typo="Typo.body2" Class="font-weight-bold">@Result.RunId</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption">Duration</MudText>
                        <MudText Typo="Typo.body2" Class="font-weight-bold">
                            @(Result.EndTime?.Subtract(Result.StartTime).TotalSeconds.ToString("F1") ?? "N/A") seconds
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption">Started</MudText>
                        <MudText Typo="Typo.body2" Class="font-weight-bold">
                            @Result.StartTime.ToString("HH:mm:ss")
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption">Completed</MudText>
                        <MudText Typo="Typo.body2" Class="font-weight-bold">
                            @(Result.EndTime?.ToString("HH:mm:ss") ?? "N/A")
                        </MudText>
                    </MudItem>
                </MudGrid>

                @if (!string.IsNullOrEmpty(Result.ErrorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-3">
                        <MudText Typo="Typo.subtitle2">Error</MudText>
                        <MudText Typo="Typo.body2">@Result.ErrorMessage</MudText>
                    </MudAlert>
                }
                else if (Result.Status == "completed" && !string.IsNullOrEmpty(Result.ResultsUrl))
                {
                    <MudStack Row Spacing="2" Class="mt-3">
                        <MudButton Variant="Variant.Filled" 
                                 Color="Color.Primary" 
                                 StartIcon="@Icons.Material.Filled.Visibility"
                                 OnClick="ViewResults"
                                 Disabled="@isLoadingResults">
                            @if (isLoadingResults)
                            {
                                <MudProgressCircular Size="@Size.Small" Indeterminate="true" />
                                <span class="ml-2">Loading...</span>
                            }
                            else
                            {
                                @(hasLoadedResults ? "Refresh Data" : "View Results")
                            }
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" 
                                 Color="Color.Primary" 
                                 StartIcon="@Icons.Material.Filled.Download"
                                 OnClick="DownloadResults"
                                 Disabled="@(!hasLoadedResults)">
                            Download Data
                        </MudButton>
                    </MudStack>
                }

                @* Show actual series data when loaded (artifact-first pattern) *@
                @if (simulationData != null)
                {
                    <MudExpansionPanels Class="mt-3">
                        <MudExpansionPanel>
                            <TitleContent>
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.BarChart" class="mr-3" />
                                    <MudText Typo="Typo.subtitle2">Time Series Data (@simulationData.Series.Count series, @simulationData.Bins bins)</MudText>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                <MudSimpleTable Striped="true" Dense="true">
                                    <thead>
                                        <tr>
                                            <th>Series ID</th>
                                            <th>Min</th>
                                            <th>Max</th>
                                            <th>Average</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var series in simulationData.Series)
                                        {
                                            <tr>
                                                <td><strong>@series.Key</strong></td>
                                                <td>@series.Value.Min().ToString("F2")</td>
                                                <td>@series.Value.Max().ToString("F2")</td>
                                                <td>@series.Value.Average().ToString("F2")</td>
                                                <td>@series.Value.Sum().ToString("F2")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </MudSimpleTable>
                            </ChildContent>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                }

                @* Show minimal metadata (artifact-first - metadata is not authoritative) *@
                @if (Result.Metadata.Any())
                {
                    <MudExpansionPanels Class="mt-3">
                        <MudExpansionPanel>
                            <TitleContent>
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" class="mr-3" />
                                    <MudText Typo="Typo.subtitle2">Run Metadata</MudText>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                @if (IsSimMode())
                                {
                                    <MudAlert Severity="Severity.Info" Class="mb-2">
                                        <MudText Typo="Typo.caption">
                                            Metadata shown here is not authoritative. Actual series data is loaded from artifacts above.
                                        </MudText>
                                    </MudAlert>
                                }
                                else
                                {
                                    <MudAlert Severity="Severity.Success" Class="mb-2">
                                        <MudText Typo="Typo.caption">
                                            Rich simulation metadata generated from FlowTime API. This includes model analysis and performance insights.
                                        </MudText>
                                    </MudAlert>
                                }
                                <MudSimpleTable Striped="true" Dense="true">
                                    <tbody>
                                        @foreach (var item in Result.Metadata.Where(m => IsDisplayableMetadata(m.Key)))
                                        {
                                            <tr>
                                                <td><strong>@FormatMetadataKey(item.Key)</strong></td>
                                                <td>@FormatMetadataValue(item.Value)</td>
                                            </tr>
                                        }
                                    </tbody>
                                </MudSimpleTable>
                            </ChildContent>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                }
            </MudCardContent>
        </MudCard>
    }
</MudStack>

@code {
    [Parameter] public SimulationRunResult? Result { get; set; }
    [Parameter] public EventCallback OnViewResults { get; set; }
    [Parameter] public EventCallback OnDownloadResults { get; set; }

    private bool isLoadingResults;
    private bool hasLoadedResults;
    private SimResultData? simulationData;

    private Color GetStatusColor(string status)
    {
        return status.ToLowerInvariant() switch
        {
            "completed" => Color.Success,
            "failed" => Color.Error,
            "running" => Color.Warning,
            "pending" => Color.Info,
            _ => Color.Default
        };
    }

    private async Task ViewResults()
    {
        if (Result?.RunId == null)
            return;

        isLoadingResults = true;
        StateHasChanged();

        try
        {
            // Load results using artifact-first pattern
            var result = await SimResults.GetSimulationResultsAsync(Result.RunId);
            
            if (result.Success && result.Value != null)
            {
                simulationData = result.Value;
                hasLoadedResults = true;
                Snackbar.Add($"Loaded {simulationData.Series.Count} series from simulation artifacts", Severity.Success);
                
                // Also trigger the parent callback
                await OnViewResults.InvokeAsync();
            }
            else
            {
                Snackbar.Add($"Failed to load simulation data: {result.Error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading simulation results: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoadingResults = false;
            StateHasChanged();
        }
    }

    private async Task DownloadResults()
    {
        if (Result?.RunId == null || simulationData == null || !hasLoadedResults)
        {
            Snackbar.Add("No data available to download", Severity.Warning);
            return;
        }

        // Check for mode mismatch
        var resultSource = Result?.Metadata.GetValueOrDefault("source")?.ToString();
        var currentlyInSimMode = FeatureFlags.UseSimulation;
        
        if (resultSource == "sim" && !currentlyInSimMode)
        {
            Snackbar.Add("This result was created in SIM mode, but you're currently in API mode. Turn on 'Use Simulation' to download SIM results.", Severity.Warning);
            return;
        }
        else if (resultSource != "sim" && currentlyInSimMode)
        {
            Snackbar.Add("This result was created in API mode, but you're currently in SIM mode. Turn off 'Use Simulation' to download API results.", Severity.Warning);
            return;
        }

        try
        {
            var downloadedCount = 0;
            var totalSeries = simulationData.Series.Count;
            
            // Trigger download through parent callback
            await OnDownloadResults.InvokeAsync();
            
            // Download each series CSV file
            foreach (var seriesId in simulationData.Series.Keys)
            {
                try
                {
                    // Determine the appropriate download URL based on current feature flag
                    string downloadUrl;
                    if (FeatureFlags.UseSimulation)
                    {
                        // SIM mode: Use full URL to FlowTime-Sim API on port 5279
                        downloadUrl = $"http://localhost:5279/sim/runs/{Result.RunId}/series/{seriesId}";
                    }
                    else
                    {
                        // API mode: Use full URL to FlowTime API on port 8080
                        downloadUrl = $"http://localhost:8080/runs/{Result.RunId}/series/{seriesId}";
                    }
                    
                    // Open download URL in new tab to trigger browser download
                    await JSRuntime.InvokeVoidAsync("window.open", downloadUrl, "_blank");
                    downloadedCount++;
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to download series {seriesId}: {ex.Message}");
                }
            }
            
            if (downloadedCount > 0)
            {
                Snackbar.Add($"Initiated download for {downloadedCount} of {totalSeries} series files", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to initiate any downloads", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error downloading results: {ex.Message}", Severity.Error);
        }
    }

    private string FormatMetadataValue(object value)
    {
        return value switch
        {
            Dictionary<string, object> dict => string.Join(", ", dict.Select(kvp => $"{kvp.Key}: {FormatNestedValue(kvp.Value)}")),
            string str => str,
            IEnumerable<object> list => string.Join(", ", list.Select(FormatNestedValue)),
            _ => value?.ToString() ?? string.Empty
        };
    }

    private string FormatNestedValue(object value)
    {
        return value switch
        {
            double d => d.ToString("F2", CultureInfo.InvariantCulture),
            float f => f.ToString("F2", CultureInfo.InvariantCulture),
            decimal m => m.ToString("F2", CultureInfo.InvariantCulture),
            _ => value?.ToString() ?? string.Empty
        };
    }

    private string FormatMetadataKey(string key)
    {
        // Convert camelCase to Title Case for better display
        return System.Text.RegularExpressions.Regex.Replace(key, @"([A-Z])", " $1").Trim()
            .Replace("Id", "ID")
            .Replace("Url", "URL")
            .Replace("Api", "API");
    }

    private static bool IsDisplayableMetadata(string key)
    {
        // For Sim mode: Only show basic metadata - artifacts are authoritative for actual data
        // For API mode: Show all rich metadata
        return key is not ("source"); // Hide internal source field
    }

    private bool IsSimMode()
    {
        // Check current feature flag setting rather than just result metadata
        // This ensures downloads use the correct service based on current mode
        return FeatureFlags.UseSimulation;
    }

    protected override void OnParametersSet()
    {
        // Reset state when Result changes
        if (Result?.RunId != simulationData?.GetHashCode().ToString())
        {
            hasLoadedResults = false;
            simulationData = null;
        }
    }
}
