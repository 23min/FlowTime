@using FlowTime.UI.Services
@inject ITemplateService TemplateService
@inject ISnackbar Snackbar
@inject FeatureFlagService FeatureFlags
@implements IDisposable

<MudStack Spacing="2">
    @if (templates == null)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Small" />
        <MudText Typo="Typo.body2">Loading templates...</MudText>
    }
    else if (!templates.Any())
    {
        <MudAlert Severity="Severity.Info">No templates available</MudAlert>
    }
    else
    {
        @foreach (var template in templates)
        {
            <MudCard Class="@GetCardClass(template)" Style="cursor: pointer;" 
                     @onclick="() => SelectTemplate(template)">
                <MudCardContent>
                    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start" Class="mb-2">
                        <MudText Typo="Typo.h6">@template.Name</MudText>
                        <MudChip T="string" Size="Size.Small" 
                                Color="@(FeatureFlags.UseSimulation ? Color.Warning : Color.Success)"
                                Variant="Variant.Filled">
                            @(FeatureFlags.UseSimulation ? "SIM" : "API")
                        </MudChip>
                    </MudStack>
                    <MudText Typo="Typo.body2" Class="mb-2">@template.Description</MudText>
                    <MudChip T="string" Size="Size.Small" Color="@GetCategoryColor(template.Category)">
                        @template.Category
                    </MudChip>
                    @if (template.Tags.Any())
                    {
                        <div class="mt-2">
                            @foreach (var tag in template.Tags)
                            {
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Class="mr-1">
                                    @tag
                                </MudChip>
                            }
                        </div>
                    }
                </MudCardContent>
            </MudCard>
        }
    }
</MudStack>

@code {
    [Parameter] public EventCallback<TemplateInfo> OnTemplateSelected { get; set; }
    
    private List<TemplateInfo>? templates;
    private string? selectedTemplateId;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to mode changes
        FeatureFlags.Changed += OnModeChanged;
    await LoadTemplatesAsync();
    }

    private async void OnModeChanged()
    {
        await LoadTemplatesAsync();
        // Clear selection since templates changed
        selectedTemplateId = null;
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadTemplatesAsync()
    {
        try
        {
            await FeatureFlags.EnsureLoadedAsync();
            templates = await TemplateService.GetTemplatesAsync();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load templates: {ex.Message}", Severity.Error);
        }
    }

    public void Dispose()
    {
        FeatureFlags.Changed -= OnModeChanged;
    }

    private async Task SelectTemplate(TemplateInfo template)
    {
        selectedTemplateId = template.Id;
        await OnTemplateSelected.InvokeAsync(template);
        StateHasChanged();
    }

    private string GetCardClass(TemplateInfo template)
    {
        var baseClass = "mb-2";
        if (template.Id == selectedTemplateId)
        {
            baseClass += " mud-theme-primary";
        }
        return baseClass;
    }

    private Color GetCategoryColor(string category)
    {
        return category.ToLowerInvariant() switch
        {
            "transportation" => Color.Primary,
            "supply-chain" => Color.Secondary,
            "manufacturing" => Color.Tertiary,
            "network" => Color.Info,
            "finance" => Color.Success,
            _ => Color.Default
        };
    }
}
