@page "/time-travel/artifacts"
@using FlowTime.UI.Components.Artifacts
@using FlowTime.UI.Components.Dialogs
@using FlowTime.UI.Services
@using MudBlazor

@inject IRunDiscoveryService RunDiscovery
@inject IFlowTimeApiClient ApiClient
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject INotificationService NotificationService
@inject IDialogService DialogService
@inject ILogger<ArtifactList> Logger

<PageTitle>Artifacts</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-2">
    <MudStack Spacing="3">
        <MudPaper Class="artifact-paper" Elevation="2">
            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack>
                    <MudText Typo="Typo.h5">Artifacts</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary">
                        Review captured runs, open dashboards, and manage telemetry bundles.
                    </MudText>
                </MudStack>
                <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                    <MudButtonGroup Variant="Variant.Text" Class="artifact-view-toggle">
                        <MudButton StartIcon="@Icons.Material.Filled.ViewModule"
                                   Variant="@(_viewMode == ArtifactViewMode.Cards ? Variant.Filled : Variant.Outlined)"
                                   Color="Color.Primary"
                                   data-testid="artifact-view-cards"
                                   OnClick="() => SetViewMode(ArtifactViewMode.Cards)">
                            Cards
                        </MudButton>
                        <MudButton StartIcon="@Icons.Material.Filled.TableRows"
                                   Variant="@(_viewMode == ArtifactViewMode.List ? Variant.Filled : Variant.Outlined)"
                                   Color="Color.Primary"
                                   data-testid="artifact-view-list"
                                   OnClick="() => SetViewMode(ArtifactViewMode.List)">
                            List
                        </MudButton>
                    </MudButtonGroup>
                    <MudChip T="string"
                             Variant="Variant.Outlined"
                             Color="Color.Primary"
                             Icon="@Icons.Material.Filled.Folder">
                        @($"{TotalRuns} runs")
                    </MudChip>
                    <MudButton Variant="Variant.Outlined"
                               Disabled="@_isLoading"
                               OnClick="RefreshAsync"
                               StartIcon="@Icons.Material.Filled.Refresh">
                        Refresh
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>

        <MudPaper Class="artifact-paper" Elevation="1">
            <MudGrid Spacing="2">
                <MudItem xs="12" md="7">
                    <MudStack Spacing="2">
                        <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.subtitle2">Mode</MudText>
                            <MudStack Row Spacing="1" Wrap="Wrap.Wrap">
                                <MudChip T="string"
                                         Variant="Variant.Outlined"
                                         Size="Size.Small"
                                         Color="Color.Secondary"
                                         Selected="@(!_state.SelectedModes.Any() && _state.TelemetryFilter == ArtifactTelemetryFilter.All)"
                                         data-testid="filter-mode-all"
                                         OnClick="@(() => SetModeFilterAsync(null))">
                                    All (@_runs.Count)
                                </MudChip>
                                <MudChip T="string"
                                         Variant="Variant.Outlined"
                                         Size="Size.Small"
                                         Color="Color.Secondary"
                                         Selected="@_state.IsModeSelected("simulation")"
                                         data-testid="filter-mode-simulation"
                                         OnClick="@(() => SetModeFilterAsync("simulation"))">
                                    Simulation (@_simulationModeCount)
                                </MudChip>
                                <MudChip T="string"
                                         Variant="Variant.Outlined"
                                         Size="Size.Small"
                                         Color="Color.Secondary"
                                         Selected="@(_state.TelemetryFilter == ArtifactTelemetryFilter.Available)"
                                         data-testid="filter-mode-telemetry"
                                         OnClick="@(() => SetModeFilterAsync("telemetry-available"))">
                                    Telemetry (@_telemetryAvailable)
                                </MudChip>
                            </MudStack>
                        </MudStack>

                        <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.subtitle2">Warnings</MudText>
                            <MudStack Row Spacing="1" Wrap="Wrap.Wrap">
                                <MudChip T="string"
                                         Variant="Variant.Outlined"
                                         Size="Size.Small"
                                         Color="Color.Info"
                                         Selected="@(_state.WarningFilter == ArtifactWarningFilter.All)"
                                         data-testid="filter-warnings-all"
                                         OnClick="@(() => SetWarningFilterAsync(ArtifactWarningFilter.All))">
                                    All
                                </MudChip>
                                <MudChip T="string"
                                         Variant="Variant.Outlined"
                                         Size="Size.Small"
                                         Color="Color.Warning"
                                         Selected="@(_state.WarningFilter == ArtifactWarningFilter.HasWarnings)"
                                         data-testid="filter-warnings-present"
                                         OnClick="@(() => SetWarningFilterAsync(ArtifactWarningFilter.HasWarnings))">
                                    Warnings (@_warningsWithIssues)
                                </MudChip>
                                <MudChip T="string"
                                         Variant="Variant.Outlined"
                                         Size="Size.Small"
                                         Color="Color.Success"
                                         Selected="@(_state.WarningFilter == ArtifactWarningFilter.NoWarnings)"
                                         data-testid="filter-warnings-none"
                                         OnClick="@(() => SetWarningFilterAsync(ArtifactWarningFilter.NoWarnings))">
                                    None (@_warningsClear)
                                </MudChip>
                            </MudStack>
                        </MudStack>

                        @if (_viewMode == ArtifactViewMode.Cards)
                        {
                            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.subtitle2">Sort By</MudText>
                                <MudStack Row Spacing="1" Wrap="Wrap.Wrap">
                                    <MudChip T="ArtifactSortOption"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Color="Color.Primary"
                                             Selected="@(_state.SortOption == ArtifactSortOption.Created)"
                                             data-testid="sort-created"
                                             OnClick="@(async () => await OnSortChanged(ArtifactSortOption.Created))">
                                        Created
                                    </MudChip>
                                    <MudChip T="ArtifactSortOption"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Color="Color.Primary"
                                             Selected="@(_state.SortOption == ArtifactSortOption.Status)"
                                             data-testid="sort-status"
                                             OnClick="@(async () => await OnSortChanged(ArtifactSortOption.Status))">
                                        Status
                                    </MudChip>
                                    <MudChip T="ArtifactSortOption"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Color="Color.Primary"
                                             Selected="@(_state.SortOption == ArtifactSortOption.Template)"
                                             data-testid="sort-template"
                                             OnClick="@(async () => await OnSortChanged(ArtifactSortOption.Template))">
                                        Template
                                    </MudChip>
                                </MudStack>
                            </MudStack>
                        }
                    </MudStack>
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudStack Spacing="1">
                        <MudTextField Value="_searchInput"
                                      ValueChanged="@(async (string value) => await OnSearchChanged(value))"
                                      Label="Search"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      AdornmentColor="Color.Secondary"
                                      FullWidth="true" />
                    </MudStack>
                </MudItem>

                <MudItem xs="12" md="1" Class="artifact-filter-actions">
                    <MudTooltip Text="Reset filters">
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                       Color="Color.Secondary"
                                       Disabled="@(!_hasActiveFilters)"
                                       OnClick="ResetFiltersAsync"
                                       @attributes=@GetAriaLabelAttributes("Reset filters") />
                    </MudTooltip>
                </MudItem>
            </MudGrid>
        </MudPaper>

        @if (_discoveryDiagnostics.Count > 0)
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Info">
                <MudText Typo="Typo.subtitle2">Diagnostics</MudText>
                <MudList T="RunDiagnostic" Dense="true">
                    @foreach (var diagnostic in _discoveryDiagnostics)
                    {
                        <MudListItem T="RunDiagnostic" Value="diagnostic">
                            <MudText Typo="Typo.body2">@($"{diagnostic.RunId}: {diagnostic.Message}")</MudText>
                        </MudListItem>
                    }
                </MudList>
            </MudAlert>
        }

        @if (_discoveryDiagnostics.Count > 0)
                {
                    <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Info">
                        <MudText Typo="Typo.subtitle2">Diagnostics</MudText>
                        <MudList T="RunDiagnostic" Dense="true">
                            @foreach (var diagnostic in _discoveryDiagnostics)
                            {
                                <MudListItem T="RunDiagnostic" Value="diagnostic">
                                    <MudText Typo="Typo.body2">@($"{diagnostic.RunId}: {diagnostic.Message}")</MudText>
                                </MudListItem>
                            }
                        </MudList>
                    </MudAlert>
                }

                @if (_isLoading)
                {
                    <MudPaper Class="pa-6" Elevation="1">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                            <MudText Typo="Typo.body2">Loading runsâ€¦</MudText>
                        </MudStack>
                    </MudPaper>
                }
                else if (!string.IsNullOrWhiteSpace(_errorMessage))
                {
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.ErrorOutline">
                            <MudText Typo="Typo.subtitle1">Unable to load runs</MudText>
                            <MudText Typo="Typo.body2">@_errorMessage</MudText>
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Refresh"
                                       OnClick="RefreshAsync">
                                Retry
                            </MudButton>
                        </MudAlert>
                    </MudPaper>
                }
                else if (_view.TotalItems == 0)
                {
                    <MudPaper Class="pa-6" Elevation="1">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Inbox" Color="Color.Secondary" Size="Size.Large" />
                            <MudText Typo="Typo.subtitle1">No runs match your filters</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
                                Adjust filters or refresh to discover new runs.
                            </MudText>
                        </MudStack>
                    </MudPaper>
                }
                else
                {
                    <MudStack Row Class="artifact-content-row" Spacing="2">
                    <MudStack Class="artifact-list-column" Spacing="2">
                        @if (_viewMode == ArtifactViewMode.Cards)
                        {
                            <MudPaper Class="artifact-paper" Elevation="1">
                                <div class="artifact-cards-grid">
                                    @foreach (var run in _view.Items)
                                    {
                                        <RunCard Run="run"
                                                 Status="@ArtifactListState.DetermineStatus(run)"
                                                 OnActivate="@(async () => await OpenDrawerAsync(run))"
                                                 OnDashboard="@(async () => await NavigateToDashboardAsync(run))"
                                                 OnTopology="@(async () => await NavigateToTopologyAsync(run))"
                                                 IsSelected="@IsSelected(run)" />
                                    }
                                </div>
                            </MudPaper>
                        }
                        else
                        {
                            <div class="artifact-list-surface">
                                <MudStack Spacing="1">
                                    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="artifact-list-toolbar">
                                        <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                            <MudButton Variant="Variant.Filled"
                                                       Color="Color.Error"
                                                       StartIcon="@Icons.Material.Filled.Delete"
                                                       Disabled="@(!_selectedRunIds.Any() || _isDeletingArtifacts)"
                                                       data-testid="artifact-delete-button"
                                                       OnClick="DeleteSelectedAsync">
                                                @if (_isDeletingArtifacts)
                                                {
                                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                }
                                                Delete
                                            </MudButton>
                                            <MudText Typo="Typo.caption"
                                                     Color="Color.Secondary"
                                                     data-testid="artifact-selection-summary">
                                                @SelectionSummary
                                            </MudText>
                                        </MudStack>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Rows open details</MudText>
                                    </MudStack>
                                    <div class="artifact-grid-container">
                                            <div class="artifact-grid-row artifact-grid-header">
                                        <div class="artifact-checkbox-cell artifact-grid-checkbox-header">
                                                <MudCheckBox T="bool?"
                                                             Class="artifact-grid-checkbox"
                                                             TriState="true"
                                                             Ripple="false"
                                                             Value="@SelectAllTriState"
                                                             ValueChanged="@(EventCallback.Factory.Create<bool?>(this, OnSelectAllStateChanged))"
                                                             Color="Color.Primary" />
                                            </div>
                                            <div class="artifact-grid-cell artifact-grid-header-cell"
                                                 role="button"
                                                 tabindex="0"
                                                 aria-label="Sort by template"
                                                 @onclick="async () => await ToggleColumnSortAsync(ArtifactSortOption.Template)"
                                                 @onkeydown="async args => await OnHeaderKeyDown(args, ArtifactSortOption.Template)">
                                                <span>Template</span>
                                                @if (IsSortedBy(ArtifactSortOption.Template))
                                                {
                                                    <MudIcon Icon="@GetSortIcon()" Class="artifact-sort-icon" />
                                                }
                                            </div>
                                            <div class="artifact-grid-cell artifact-grid-header-cell"
                                                 role="button"
                                                 tabindex="0"
                                                 aria-label="Sort by run"
                                                 @onclick="async () => await ToggleColumnSortAsync(ArtifactSortOption.RunId)"
                                                 @onkeydown="async args => await OnHeaderKeyDown(args, ArtifactSortOption.RunId)">
                                                <span>Run</span>
                                                @if (IsSortedBy(ArtifactSortOption.RunId))
                                                {
                                                    <MudIcon Icon="@GetSortIcon()" Class="artifact-sort-icon" />
                                                }
                                            </div>
                                            <div class="artifact-grid-cell artifact-grid-header-cell"
                                                 role="button"
                                                 tabindex="0"
                                                 aria-label="Sort by created date"
                                                 @onclick="async () => await ToggleColumnSortAsync(ArtifactSortOption.Created)"
                                                 @onkeydown="async args => await OnHeaderKeyDown(args, ArtifactSortOption.Created)">
                                                <span>Created (UTC)</span>
                                                @if (IsSortedBy(ArtifactSortOption.Created))
                                                {
                                                    <MudIcon Icon="@GetSortIcon()" Class="artifact-sort-icon" />
                                                }
                                            </div>
                                            <div class="artifact-grid-cell artifact-grid-header-cell"
                                                 role="button"
                                                 tabindex="0"
                                                 aria-label="Sort by grid"
                                                 @onclick="async () => await ToggleColumnSortAsync(ArtifactSortOption.Grid)"
                                                 @onkeydown="async args => await OnHeaderKeyDown(args, ArtifactSortOption.Grid)">
                                                <span>Grid</span>
                                                @if (IsSortedBy(ArtifactSortOption.Grid))
                                                {
                                                    <MudIcon Icon="@GetSortIcon()" Class="artifact-sort-icon" />
                                                }
                                            </div>
                                            <div class="artifact-grid-cell artifact-grid-header-cell"
                                                 role="button"
                                                 tabindex="0"
                                                 aria-label="Sort by mode"
                                                 @onclick="async () => await ToggleColumnSortAsync(ArtifactSortOption.Telemetry)"
                                                 @onkeydown="async args => await OnHeaderKeyDown(args, ArtifactSortOption.Telemetry)">
                                                <span>Mode</span>
                                                @if (IsSortedBy(ArtifactSortOption.Telemetry))
                                                {
                                                    <MudIcon Icon="@GetSortIcon()" Class="artifact-sort-icon" />
                                                }
                                            </div>
                                            <div class="artifact-grid-cell artifact-grid-header-cell artifact-grid-actions-header">
                                                <span>Open</span>
                                            </div>
                                        </div>
                                        @foreach (var run in _view.Items)
                                        {
                                            <div class="@GetRowClass(run) artifact-grid-row"
                                                 role="button"
                                                 tabindex="0"
                                                 @onclick="() => OnRowClickedAsync(run)">
                                                <div class="artifact-checkbox-cell">
                                                    <div @onclick:stopPropagation>
                                                        <MudCheckBox T="bool"
                                                                     Class="artifact-grid-checkbox"
                                                                     Ripple="false"
                                                                     Value="@IsRowSelected(run)"
                                                                     ValueChanged="@(EventCallback.Factory.Create<bool>(this, value => OnRowSelectionChanged(run, value)))"
                                                                     Color="Color.Primary" />
                                                    </div>
                                                </div>
                                                <div>
                                                    <MudText Typo="Typo.subtitle2" Class="artifact-table-template">@FormatTemplateTitle(run)</MudText>
                                                </div>
                                                <div>
                                                    <MudStack Row Spacing="0" AlignItems="AlignItems.Center" Class="artifact-inline-gap">
                                                        <MudText Typo="Typo.subtitle2" Class="artifact-table-runid">@GetShortRunId(run.RunId)</MudText>
                                                        @if (run.WarningCount > 0)
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.WarningAmber" Color="Color.Warning" Size="Size.Small" />
                                                        }
                                                    </MudStack>
                                                </div>
                                                <div>@FormatCreated(run)</div>
                                                <div>@FormatGrid(run.Grid)</div>
                                                <div>
                                                    <MudText Typo="Typo.body2">
                                                        @(run.Telemetry?.Available == true ? "Telemetry" : "Simulation")
                                                    </MudText>
                                                </div>
                                                <div class="artifact-grid-actions-cell" @onclick:stopPropagation>
                                                    @{
                                                        var telemetryQuickActions = run.Telemetry?.Available == true && run.CanReplay;
                                                    }
                                                    <MudTooltip Text="Open dashboard">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Dashboard"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Small"
                                                                       data-testid="artifact-action-dashboard"
                                                                       Disabled="@(!run.CanOpen)"
                                                                       OnClick="@(EventCallback.Factory.Create(this, async () => await NavigateToDashboardAsync(run)))"
                                                                       @attributes=@GetAriaLabelAttributes("Open dashboard") />
                                                    </MudTooltip>
                                                    @if (telemetryQuickActions)
                                                    {
                                                        <MudTooltip Text="Open dashboard (telemetry)">
                                                            <div class="artifact-card-telemetry-icon">
                                                                <MudIconButton Icon="@Icons.Material.Filled.Dashboard"
                                                                               Color="Color.Primary"
                                                                               Size="Size.Small"
                                                                               data-testid="artifact-action-dashboard-telemetry"
                                                                               Disabled="@(!run.CanOpen)"
                                                                               OnClick="@(EventCallback.Factory.Create(this, async () => await NavigateToTelemetryDashboardAsync(run)))"
                                                                               @attributes=@GetAriaLabelAttributes("Open telemetry dashboard") />
                                                                <span class="artifact-card-telemetry-dot"></span>
                                                            </div>
                                                        </MudTooltip>
                                                    }
                                                    <MudTooltip Text="Open topology">
                                                        <MudIconButton Icon="@Icons.Material.Filled.AccountTree"
                                                                       Color="Color.Secondary"
                                                                       Size="Size.Small"
                                                                       data-testid="artifact-action-topology"
                                                                       Disabled="@(!run.CanOpen)"
                                                                       OnClick="@(EventCallback.Factory.Create(this, async () => await NavigateToTopologyAsync(run)))"
                                                                       @attributes=@GetAriaLabelAttributes("Open topology") />
                                                    </MudTooltip>
                                                    @if (telemetryQuickActions)
                                                    {
                                                        <MudTooltip Text="Open topology (telemetry)">
                                                            <div class="artifact-card-telemetry-icon">
                                                                <MudIconButton Icon="@Icons.Material.Filled.AccountTree"
                                                                               Color="Color.Secondary"
                                                                               Size="Size.Small"
                                                                               data-testid="artifact-action-topology-telemetry"
                                                                               Disabled="@(!run.CanOpen)"
                                                                               OnClick="@(EventCallback.Factory.Create(this, async () => await NavigateToTelemetryTopologyAsync(run)))"
                                                                               @attributes=@GetAriaLabelAttributes("Open telemetry topology") />
                                                                <span class="artifact-card-telemetry-dot"></span>
                                                            </div>
                                                        </MudTooltip>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </MudStack>
                            </div>
                        }


                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Showing @_view.Items.Count of @_view.TotalItems runs (page @_view.PageIndex / @_view.TotalPages)
                            </MudText>
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIconButton Icon="@Icons.Material.Filled.NavigateBefore"
                                                   Disabled="@(_state.PageIndex <= 1)"
                                                   OnClick="PreviousPageAsync"
                                                   @attributes=@GetAriaLabelAttributes("Previous page") />
                                    <MudText Typo="Typo.body2">@_view.PageIndex</MudText>
                                    <MudIconButton Icon="@Icons.Material.Filled.NavigateNext"
                                                   Disabled="@(_view.PageIndex >= _view.TotalPages)"
                                                   OnClick="NextPageAsync"
                                                   @attributes=@GetAriaLabelAttributes("Next page") />
                                </MudStack>
                            </MudStack>
                        </MudStack>

                        <RunDetailsDrawer Open="_isDrawerOpen"
                                          Run="_selectedRun"
                                          Detail="_selectedDetail"
                                          IsLoading="_isDetailLoading"
                                          IsGeneratingTelemetry="_isGeneratingTelemetry"
                                          ErrorMessage="@_detailError"
                                          LastCaptureSummary="_captureSummary"
                                          OverwriteTelemetry="_overwriteCapture"
                                          OverwriteTelemetryChanged="OnOverwriteChanged"
                                          CanLoadModel="CanLoadModel"
                                          CanLoadTelemetry="CanLoadTelemetry"
                                          OnLoad="LoadRun"
                                          OnClose="CloseDrawerAsync"
                                          OnReload="ReloadDetailAsync"
                                          OnGenerateTelemetry="GenerateTelemetryAsync" />
                    </MudStack>
                }
            </MudStack>
</MudContainer>
