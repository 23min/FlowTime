@page "/artifacts"
@page "/time-travel/artifacts"
@using FlowTime.UI.Services
@inject IRunDiscoveryService RunDiscovery
@inject NavigationManager Navigation
@inject ILogger<Artifacts> Logger

<PageTitle>Artifacts</PageTitle>

<MudContainer MaxWidth="MaxWidth.False">
    <MudStack Spacing="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack>
                    <MudText Typo="Typo.h4">Artifacts</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary">
                        Browse local runs and open them in the Time-Travel workspace.
                    </MudText>
                </MudStack>
                <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                    <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Folder">
                        @(_result?.TotalCount ?? 0) runs
                    </MudChip>
                    <MudButton Variant="Variant.Outlined"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="ReloadAsync"
                               Disabled="_isLoading">
                        Refresh
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>

        <MudPaper Class="pa-4" Elevation="1">
            @if (_isLoading)
            {
                <MudStack AlignItems="AlignItems.Center" Spacing="2">
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                    <MudText Typo="Typo.body2">Scanning runs…</MudText>
                </MudStack>
            }
            else if (!string.IsNullOrWhiteSpace(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Icon="@Icons.Material.Filled.ErrorOutline">
                    <MudText Typo="Typo.subtitle1">Unable to load runs</MudText>
                    <MudText Typo="Typo.body2">@_errorMessage</MudText>
                    <MudButton Variant="Variant.Text"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="ReloadAsync">
                        Retry
                    </MudButton>
                </MudAlert>
            }
            else if (_result?.Runs.Count is > 0)
            {
                <MudTable Items="_result.Runs" Hover="true" Dense="true">
                    <HeaderContent>
                        <MudTh>Run</MudTh>
                        <MudTh>Template</MudTh>
                        <MudTh>Source</MudTh>
                        <MudTh>Created (UTC)</MudTh>
                        <MudTh>Grid</MudTh>
                        <MudTh>Telemetry</MudTh>
                        <MudTh>Artifacts</MudTh>
                        <MudTh>Warnings</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Run">
                        <MudText Typo="Typo.subtitle2">@context.RunId</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @context.TemplateId
                        </MudText>
                        @if (context.WarningCount > 0)
                        {
                            <MudChip T="string"
                                     Size="Size.Small"
                                     Color="Color.Warning"
                                     Variant="Variant.Outlined"
                                     Icon="@Icons.Material.Filled.WarningAmber">
                                Partial
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Template">
                            <MudText Typo="Typo.body2">
                                @(!string.IsNullOrWhiteSpace(context.TemplateTitle) ? context.TemplateTitle : "—")
                            </MudText>
                            @if (!string.IsNullOrWhiteSpace(context.TemplateVersion))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @($"v{context.TemplateVersion}")
                                </MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Source">
                            <MudChip T="string"
                                     Size="Size.Small"
                                     Color="@(context.WarningCount > 0 ? Color.Warning : Color.Info)"
                                     Variant="Variant.Outlined">
                                @context.Source.ToUpperInvariant()
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Created (UTC)">
                            <MudText Typo="Typo.body2">
                                @FormatTimestamp(context.CreatedUtc)
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="Grid">
                            @if (context.Grid.IsAvailable)
                            {
                                <MudChip T="string"
                                         Size="Size.Small"
                                         Color="Color.Success"
                                         Variant="Variant.Outlined"
                                         Icon="@Icons.Material.Filled.Timeline">
                                    @($"{context.Grid.Bins} bins · {context.Grid.BinMinutes} min")
                                </MudChip>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">n/a</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Telemetry">
                            @if (context.Telemetry?.Available == true)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.CheckCircle">
                                    Yes
                                </MudChip>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">No</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Artifacts">
                            <MudStack Row Spacing="1">
                                <MudChip T="string"
                                         Size="Size.Small"
                                         Variant="Variant.Outlined"
                                         Color="@(context.Presence.HasModel ? Color.Success : Color.Warning)">
                                    Model
                                </MudChip>
                                <MudChip T="string"
                                         Size="Size.Small"
                                         Variant="Variant.Outlined"
                                         Color="@(context.Presence.HasManifest ? Color.Success : Color.Warning)">
                                    Manifest
                                </MudChip>
                                <MudChip T="string"
                                         Size="Size.Small"
                                         Variant="Variant.Outlined"
                                         Color="@(context.Presence.HasIndex ? Color.Success : Color.Warning)">
                                    Index
                                </MudChip>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="Warnings">
                            @if (context.WarningCount > 0)
                            {
                                <MudTooltip Text="@BuildWarningTooltip(context)">
                                    <MudChip T="string"
                                             Size="Size.Small"
                                             Color="Color.Warning"
                                             Variant="Variant.Outlined"
                                             Icon="@Icons.Material.Filled.WarningAmber">
                                        @($"Partial ({context.WarningCount})")
                                    </MudChip>
                                </MudTooltip>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">None</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Actions" align="@Align.Right">
                            <MudTooltip Text="@GetOpenTooltip(context)">
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.OpenInNew"
                                           Disabled="!context.CanOpen"
                                           OnClick="@(() => OpenRun(context.RunId))">
                                    Open
                                </MudButton>
                            </MudTooltip>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudStack AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Inbox" Color="Color.Secondary" Size="Size.Large" />
                    <MudText Typo="Typo.subtitle1">No runs found</MudText>
                    <MudText Typo="Typo.body2" Align="@Align.Center" Color="Color.Secondary">
                        Generate runs with the CLI or simulation tools, then refresh this page.
                    </MudText>
                </MudStack>
            }
        </MudPaper>

        @if (!_isLoading && _result is { Diagnostics.Count: > 0 })
        {
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.subtitle1" Class="mb-2">
                    Diagnostics
                </MudText>
                <MudStack Spacing="1">
                    @foreach (var diag in _result.Diagnostics)
                    {
                        <MudPaper Class="pa-2" Elevation="0" Outlined="true">
                            <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.ReportProblem" Color="Color.Warning" />
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.subtitle2">@diag.RunId</MudText>
                                    <MudText Typo="Typo.caption">@diag.Message</MudText>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>
            </MudPaper>
        }
    </MudStack>
</MudContainer>

@code {
    private RunDiscoveryResult? _result;
    private bool _isLoading = true;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await ReloadCoreAsync();
    }

    private async Task ReloadAsync()
    {
        await ReloadCoreAsync();
    }

    private async Task ReloadCoreAsync()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            StateHasChanged();

            var result = await RunDiscovery.LoadRunsAsync();
            if (!result.Success)
            {
                _errorMessage = result.ErrorMessage ?? "Unknown error occurred.";
                _result = null;
            }
            else
            {
                _result = result;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading runs");
            _errorMessage = ex.Message;
            _result = null;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private static string FormatTimestamp(DateTimeOffset? timestamp) =>
        timestamp.HasValue ? timestamp.Value.ToString("yyyy-MM-dd HH:mm:ss") : "—";

    private void OpenRun(string runId)
    {
        var target = $"/time-travel/artifacts/{Uri.EscapeDataString(runId)}";
        Navigation.NavigateTo(target);
    }

    private static string BuildWarningTooltip(RunListEntry entry)
    {
        if (entry.Warnings.Count == 0)
        {
            return "Warnings not available.";
        }

        return string.Join(Environment.NewLine, entry.Warnings.Select(w => $"{w.Code}: {w.Message}"));
    }

    private static string GetOpenTooltip(RunListEntry entry)
    {
        return entry.CanOpen
            ? "Open this run in Time-Travel"
            : "Run is missing required artifacts. Resolve diagnostics before opening.";
    }
}
