@using System.Collections.Generic
@using System.Globalization
@using FlowTime.UI.Services
@using FlowTime.UI.Pages.TimeTravel
@using MudBlazor

<div class="@ContainerClass" aria-hidden="@(!Open)" data-testid="run-details-container">
    <MudPaper Elevation="1"
              Class="artifact-details-drawer"
              data-testid="run-details-drawer"
              @onkeydown="HandleKeyDown">
<MudStack Spacing="3" Class="pa-4 artifact-details-scroll" @attributes="tabbableStackAttributes">
            @if (Open && renderRun is not null)
            {
                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start" Class="artifact-details-header">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.h6" Class="artifact-details-title" Id="@TitleId">@RunTitle</MudText>
                        @if (!string.IsNullOrWhiteSpace(StatusLabel))
                        {
                            <MudChip T="string"
                                     Variant="Variant.Outlined"
                                     Size="Size.Small"
                                     Color="@StatusColor">
                                @StatusLabel
                            </MudChip>
                        }
                    </MudStack>
                    <MudStack Row Spacing="1" AlignItems="AlignItems.Start">
                        <MudTooltip Text="Refresh details">
                            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           Disabled="IsLoading"
                                           AriaLabel="Refresh details"
                                           OnClick="RetryAsync" />
                        </MudTooltip>
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                       Color="Color.Secondary"
                                       Size="Size.Small"
                                       AriaLabel="Close details"
                                       OnClick="CloseAsync" />
                    </MudStack>
                </MudStack>
            }

            @if (!Open)
            {
                <MudStack Class="artifact-details-empty" AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Secondary" />
                    <MudText Typo="Typo.body2">Select a run to view its details.</MudText>
                </MudStack>
            }
            else if (IsLoading)
            {
                <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="py-6" Spacing="2">
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                    <MudText Typo="Typo.body2">Loading run detailsâ€¦</MudText>
                </MudStack>
            }
            else if (renderRun is not null)
            {
                <MudStack Spacing="3">
                    @if (!string.IsNullOrWhiteSpace(ErrorMessage))
                    {
                        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Info">
                            <MudText Typo="Typo.subtitle2">Latest details unavailable</MudText>
                            <MudText Typo="Typo.body2">@ErrorMessage</MudText>
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Refresh"
                                       OnClick="RetryAsync">
                                Retry
                            </MudButton>
                        </MudAlert>
                    }

                    <MudPaper Elevation="0" Class="pa-0 artifact-details-section">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle1">Run Summary</MudText>
                            <div class="artifact-details-table">
                                <div class="artifact-details-row">
                                    <span class="artifact-details-label">Run ID</span>
                                    <MudTooltip Text="@renderRun.RunId">
                                        <span class="artifact-details-value">@renderRun.RunId</span>
                                    </MudTooltip>
                                </div>
                                <div class="artifact-details-row">
                                    <span class="artifact-details-label">Template</span>
                                    <MudTooltip Text="@(renderRun.TemplateTitle ?? renderRun.TemplateId)">
                                        <span class="artifact-details-value">@(renderRun.TemplateTitle ?? renderRun.TemplateId)</span>
                                    </MudTooltip>
                                </div>
                                <div class="artifact-details-row">
                                    <span class="artifact-details-label">Created (UTC)</span>
                                    <span class="artifact-details-value">@FormatDate(renderRun.CreatedUtc)</span>
                                </div>
                                <div class="artifact-details-row">
                                    <span class="artifact-details-label">Mode</span>
                                    <span class="artifact-details-value">@RunSourceLabel</span>
                                </div>
                                <div class="artifact-details-row">
                                    <span class="artifact-details-label">Telemetry bundle</span>
                                    <span class="artifact-details-value">@TelemetrySummaryText</span>
                                </div>
                                @if (!string.IsNullOrWhiteSpace(TelemetryGeneratedAtText))
                                {
                                    <div class="artifact-details-row">
                                        <span class="artifact-details-label">Generated</span>
                                        <span class="artifact-details-value">@TelemetryGeneratedAtText</span>
                                    </div>
                                }
                                @if (!string.IsNullOrWhiteSpace(TelemetryWarningText))
                                {
                                    <div class="artifact-details-row">
                                        <span class="artifact-details-label">Capture warnings</span>
                                        <span class="artifact-details-value">@TelemetryWarningText</span>
                                    </div>
                                }
                            </div>

                            <MudStack Spacing="1">
                                <MudText Typo="Typo.subtitle2">Artifacts</MudText>
                                <MudStack Row Spacing="1" Class="artifact-details-presence">
                                    @{
                                        var presence = renderRun.Presence;
                                        var hasModel = presence?.HasModel == true;
                                        var hasManifest = presence?.HasManifest == true;
                                        var hasIndex = presence?.HasIndex == true;
                                        var hasSeries = presence?.HasSeries == true;
                                    }
                                    <MudChip T="string"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Color="@(hasModel ? Color.Success : Color.Warning)">
                                        Model @(hasModel ? "available" : "missing")
                                    </MudChip>
                                    <MudChip T="string"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Color="@(hasManifest ? Color.Success : Color.Warning)">
                                        Manifest @(hasManifest ? "available" : "missing")
                                    </MudChip>
                                    <MudChip T="string"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Color="@(hasIndex ? Color.Success : Color.Warning)">
                                        Index @(hasIndex ? "available" : "missing")
                                    </MudChip>
                                    <MudChip T="string"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Color="@(hasSeries ? Color.Success : Color.Warning)">
                                        Series @(hasSeries ? "available" : "missing")
                                    </MudChip>
                                </MudStack>
                            </MudStack>
                        </MudStack>
                    </MudPaper>

                    @if (renderDetail is not null || (renderRun?.Warnings?.Count ?? 0) > 0)
                    {
                        <MudDivider Class="artifact-details-divider" />
                    }

                    @if (renderDetail is not null)
                    {
                        if (renderDetail.Metadata is { } metadata)
                        {
                            <MudPaper Elevation="0" Class="pa-0 artifact-details-section">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.subtitle1">Template & Metadata</MudText>
                                    <div class="artifact-details-table">
                                        <div class="artifact-details-row">
                                            <span class="artifact-details-label">Template version</span>
                                            <span class="artifact-details-value">@(metadata.TemplateVersion ?? "Not reported")</span>
                                        </div>
                                        <div class="artifact-details-row">
                                            <span class="artifact-details-label">Provenance hash</span>
                                            <MudTooltip Text="@(metadata.ProvenanceHash ?? "Not reported")">
                                                <span class="artifact-details-value">@(metadata.ProvenanceHash ?? "Not reported")</span>
                                            </MudTooltip>
                                        </div>
                                <div class="artifact-details-row">
                                    <span class="artifact-details-label">Schema</span>
                                    <span class="artifact-details-value">@FormatSchemaDisplay(metadata.Schema)</span>
                                </div>
                                        <div class="artifact-details-row">
                                            <span class="artifact-details-label">Telemetry sources</span>
                                            <span class="artifact-details-value">
                                                @(metadata.TelemetrySourcesResolved ? "Resolved" : "Pending resolution")
                                            </span>
                                        </div>
                                        <div class="artifact-details-row">
                                            <span class="artifact-details-label">RNG</span>
                                            <span class="artifact-details-value">
                                                @(metadata.Rng is { } rng
                                                    ? $"{rng.Kind} (seed {rng.Seed})"
                                                    : "Not configured")
                                            </span>
                                        </div>
                                    </div>
                                </MudStack>
                            </MudPaper>
                        }

                        <MudDivider Class="artifact-details-divider" />

                        <MudPaper Elevation="0" Class="pa-0 artifact-details-section">
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.subtitle1">Telemetry Generation</MudText>
                                <MudText Typo="Typo.caption">
                                    Generate or refresh telemetry bundles for this run. Overwrite is off by default.
                                </MudText>

                                <MudSwitch T="bool"
                                           @bind-Checked="OverwriteTelemetry"
                                           Disabled="IsGeneratingTelemetry"
                                           Color="Color.Primary"
                                           Label="Overwrite existing bundle" />

                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           Disabled="IsGeneratingTelemetry"
                                           StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                           OnClick="GenerateTelemetryAsync">
                                    @TelemetryActionLabel
                                </MudButton>

                                @if (LastCaptureSummary is not null)
                                {
                                    <MudAlert Severity="@(LastCaptureSummary.Generated ? Severity.Success : Severity.Info)"
                                              Variant="Variant.Outlined"
                                              Icon="@(LastCaptureSummary.Generated ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Info)">
                                        <MudText Typo="Typo.body2">
                                            @(LastCaptureSummary.Generated
                                                ? "Telemetry bundle generated successfully."
                                                : "Telemetry bundle already existed. Enable overwrite to regenerate.")
                                        </MudText>
                                    </MudAlert>

                                    if (LastCaptureSummary.Warnings is { Count: > 0 })
                                    {
                                        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.WarningAmber">
                                            <MudText Typo="Typo.subtitle2">Warnings during capture</MudText>
                                            <MudList T="StateWarningDto" Dense="true">
                                                @foreach (var warning in LastCaptureSummary.Warnings)
                                                {
                                                    <MudListItem>
                                                        <MudStack>
                                                            <MudText Typo="Typo.body2">@($"{warning.Code}: {warning.Message}")</MudText>
                                                            @if (!string.IsNullOrWhiteSpace(warning.NodeId))
                                                            {
                                                                <MudText Class="mud-typography-caption artifact-details-label">Node: @warning.NodeId</MudText>
                                                            }
                                                        </MudStack>
                                                    </MudListItem>
                                                }
                                            </MudList>
                                        </MudAlert>
                                    }
                                }

                                <MudStack Row Spacing="1">
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Secondary"
                                               Disabled="!(CanLoadModel && !IsGeneratingTelemetry)"
                                               StartIcon="@Icons.Material.Filled.Dataset"
                                               OnClick="@(() => LoadAsync(OrchestrationMode.Simulation))">
                                        Load model results
                                    </MudButton>
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Success"
                                               Disabled="!(CanLoadTelemetry && !IsGeneratingTelemetry)"
                                               StartIcon="@Icons.Material.Filled.CloudDownload"
                                               OnClick="@(() => LoadAsync(OrchestrationMode.Telemetry))">
                                        Load telemetry results
                                    </MudButton>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    }

                    @if ((renderRun?.Warnings?.Count ?? 0) > 0)
                    {
                        <MudPaper Elevation="0" Class="pa-0">
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.subtitle1">Run Warnings</MudText>
                                <MudList T="RunWarningInfo" Dense="true">
                                    @foreach (var warning in renderRun?.Warnings ?? Array.Empty<RunWarningInfo>())
                                    {
                                        <MudListItem>
                                            <MudStack>
                                                <MudText Typo="Typo.body2">@($"{warning.Code}: {warning.Message}")</MudText>
                                                @if (!string.IsNullOrWhiteSpace(warning.NodeId))
                                                {
                                                    <MudText Class="mud-typography-caption artifact-details-label">Node: @warning.NodeId</MudText>
                                                }
                                            </MudStack>
                                        </MudListItem>
                                    }
                                </MudList>
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>
            }
        </MudStack>
    </MudPaper>
</div>

@code {
    [Parameter] public bool Open { get; set; }
    [Parameter] public RunListEntry? Run { get; set; }
    [Parameter] public RunCreateResponseDto? Detail { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public bool IsGeneratingTelemetry { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public TelemetryCaptureSummaryDto? LastCaptureSummary { get; set; }
    [Parameter] public bool OverwriteTelemetry { get; set; }
    [Parameter] public EventCallback<bool> OverwriteTelemetryChanged { get; set; }
    [Parameter] public bool CanLoadModel { get; set; }
    [Parameter] public bool CanLoadTelemetry { get; set; }
    [Parameter] public EventCallback<OrchestrationMode> OnLoad { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnReload { get; set; }
    [Parameter] public EventCallback OnGenerateTelemetry { get; set; }

    private static readonly IReadOnlyDictionary<string, object> tabbableStackAttributes =
        new Dictionary<string, object> { ["tabindex"] = 0 };

    private RunListEntry? renderRun;
    private RunCreateResponseDto? renderDetail;

    protected override void OnParametersSet()
    {
        if (Run is not null)
        {
            renderRun = Run;
        }

        if (Detail is not null)
        {
            renderDetail = Detail;
        }
    }

    private string ContainerClass => Open ? "artifact-details-container is-open" : "artifact-details-container";

    private string TitleId => $"artifact-drawer-title-{renderRun?.RunId ?? "none"}";

    private string RunTitle => renderRun?.TemplateTitle ?? renderRun?.TemplateId ?? "Run details";

    private string RunSourceLabel => string.IsNullOrWhiteSpace(renderRun?.Source) ? "Unknown" : renderRun.Source;

    private string StatusLabel
    {
        get
        {
            if (renderRun is null)
            {
                return string.Empty;
            }

            if (renderRun.WarningCount > 0)
            {
                return $"Warnings: {renderRun.WarningCount}";
            }

            if (TelemetryAvailable)
            {
                return "Telemetry ready";
            }

            return string.Empty;
        }
    }

    private Color StatusColor => renderRun is null ? Color.Default : renderRun.WarningCount switch
    {
        > 0 => Color.Warning,
        _ when TelemetryAvailable => Color.Success,
        _ => Color.Info
    };

    private bool TelemetryAvailable => renderRun?.Telemetry?.Available == true;

    private string TelemetrySummaryText => renderRun?.Telemetry?.Available switch
    {
        true => "Telemetry ready",
        false => "Not generated",
        _ => "Not generated"
    };

    private string TelemetryGeneratedAtText => renderRun?.Telemetry?.GeneratedAtUtc ?? string.Empty;

    private string TelemetrySourceRunText => renderRun?.Telemetry?.SourceRunId ?? string.Empty;

    private string TelemetryWarningText => renderRun?.Telemetry?.WarningCount switch
    {
        > 1 => $"{renderRun.Telemetry!.WarningCount} warnings",
        1 => "1 warning",
        _ => string.Empty
    };

    private string TelemetryActionLabel => renderRun?.Telemetry?.Available == true && !OverwriteTelemetry
        ? "Generate telemetry bundle"
        : OverwriteTelemetry ? "Regenerate telemetry bundle" : "Generate telemetry bundle";

    private async Task HandleKeyDown(KeyboardEventArgs args)
    {
        if (!Open)
        {
            return;
        }

        if (args.Key is "Escape")
        {
            await CloseAsync();
        }
    }

    private Task CloseAsync()
    {
        return OnClose.HasDelegate ? OnClose.InvokeAsync() : Task.CompletedTask;
    }

    private Task RetryAsync()
    {
        return OnReload.HasDelegate ? OnReload.InvokeAsync() : Task.CompletedTask;
    }

    private async Task GenerateTelemetryAsync()
    {
        if (IsGeneratingTelemetry)
        {
            return;
        }

        if (OnGenerateTelemetry.HasDelegate)
        {
            await OnGenerateTelemetry.InvokeAsync();
        }
    }

    private Task LoadAsync(OrchestrationMode mode)
        => OnLoad.HasDelegate ? OnLoad.InvokeAsync(mode) : Task.CompletedTask;

    private string FormatDate(DateTimeOffset? timestamp)
    {
        if (timestamp is null)
        {
            return "Unknown";
        }

        return timestamp.Value.ToString("yyyy-MM-dd HH:mm 'UTC'", CultureInfo.InvariantCulture);
    }

    private static string FormatSchemaDisplay(SchemaMetadataDto? schema)
    {
        if (schema is null)
        {
            return "Not reported";
        }

        var id = schema.Id?.Trim();
        var version = schema.Version?.Trim();

        if (string.IsNullOrWhiteSpace(id))
        {
            return string.IsNullOrWhiteSpace(version) ? "Not reported" : $"v{version}";
        }

        if (!string.IsNullOrWhiteSpace(version) &&
            id.Contains(version, StringComparison.OrdinalIgnoreCase) == false)
        {
            return $"{id} (v{version})";
        }

        return id;
    }
}
