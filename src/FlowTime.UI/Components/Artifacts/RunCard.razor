@using System.Collections.Generic
@using System.Globalization
@using Microsoft.AspNetCore.Components.Web
@using System.Text
@using System.Linq
@using FlowTime.UI.Pages.TimeTravel
@using FlowTime.UI.Services
@using MudBlazor
@inherits MudComponentBase

<MudPaper Class="@CssClass"
          Elevation="2"
          data-testid="artifact-card"
          @attributes="BuildCardAttributes()"
          @onclick="HandleClick"
          @onkeydown="HandleKeyDown">
    <div class="artifact-card-body">
        <div class="artifact-card-header">
            <div class="artifact-card-title">
                <MudAvatar Size="Size.Medium"
                           Class="@(string.IsNullOrWhiteSpace(TemplateIcon) ? "artifact-card-avatar artifact-card-avatar--initials" : "artifact-card-avatar")"
                           Color="@(string.IsNullOrWhiteSpace(TemplateIcon) ? AvatarColor : IconAvatarColor)">
                    @if (!string.IsNullOrWhiteSpace(TemplateIcon))
                    {
                        <MudIcon Icon="@TemplateIcon" />
                    }
                    else
                    {
                        <span class="artifact-avatar-text" style="@AvatarTextStyle">@AvatarLabel</span>
                    }
                </MudAvatar>
                <div class="artifact-card-title-texts">
                    <MudTooltip Text="@DisplayTitle">
                        <MudText Typo="Typo.subtitle2" Class="artifact-card-title-text">@DisplayTitle</MudText>
                    </MudTooltip>
                    <MudText Typo="Typo.caption" Class="artifact-card-meta">@MetadataText</MudText>
                </div>
            </div>
            <MudStack Spacing="1" Class="artifact-card-chips">
                <MudChip T="string"
                         Variant="Variant.Outlined"
                         Size="Size.Small"
                         Color="Color.Info"
                         Class="artifact-card-chip">
                    @ModeLabel
                </MudChip>
                @if (TelemetryAvailable)
                {
                    <MudChip T="string"
                             Variant="Variant.Outlined"
                             Size="Size.Small"
                             Color="Color.Success"
                             Class="artifact-card-chip">
                        @TelemetryStatusLabel
                    </MudChip>
                }
            </MudStack>
        </div>

        <div class="artifact-card-content">
            <MudStack Row Spacing="1" Class="artifact-card-gridchips">
                <MudChip T="string"
                         Variant="Variant.Outlined"
                         Size="Size.Small">
                    @($"{Run.Grid.Bins} bins")
                </MudChip>
                <MudChip T="string"
                         Variant="Variant.Outlined"
                         Size="Size.Small">
                    @($"{Run.Grid.BinMinutes} min")
                </MudChip>
            </MudStack>

            <MudText Typo="Typo.caption" Class="artifact-card-textline">@WarningsText</MudText>

            @if (!string.IsNullOrEmpty(TelemetryDetailLine))
            {
                <MudText Typo="Typo.caption" Class="artifact-card-textline">@TelemetryDetailLine</MudText>
            }
        </div>

        <div class="artifact-card-footer">
            <MudTooltip Text="@Run.RunId">
                <MudText Typo="Typo.caption" Class="artifact-card-runid">@Run.RunId</MudText>
            </MudTooltip>
            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                <MudStack Row Spacing="0" AlignItems="AlignItems.Center">
                    <MudTooltip Text="Open dashboard">
                        <span @onclick:stopPropagation="true">
                            <MudIconButton Icon="@Icons.Material.Filled.Dashboard"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="HandleDashboardIconClick"
                                           @attributes="dashboardAriaAttributes" />
                        </span>
                    </MudTooltip>
                    @if (TelemetryQuickActionsEnabled && TelemetryAvailable && CanReplay)
                    {
                        <MudTooltip Text="Open dashboard (telemetry)">
                            <div class="artifact-card-telemetry-icon" @onclick:stopPropagation="true">
                                <MudIconButton Icon="@Icons.Material.Filled.Dashboard"
                                               Color="Color.Primary"
                                               Size="Size.Small"
                                               Disabled="!TelemetryAvailable || !CanReplay"
                                               OnClick="HandleTelemetryDashboardIconClick"
                                               @attributes="dashboardTelemetryAriaAttributes" />
                                <span class="artifact-card-telemetry-dot"></span>
                            </div>
                        </MudTooltip>
                    }
                </MudStack>

                <MudStack Row Spacing="0" AlignItems="AlignItems.Center">
                    <MudTooltip Text="Open topology">
                        <span @onclick:stopPropagation="true">
                            <MudIconButton Icon="@Icons.Material.Filled.AccountTree"
                                           Color="Color.Secondary"
                                           Size="Size.Small"
                                           OnClick="HandleTopologyIconClick"
                                           @attributes="topologyAriaAttributes" />
                        </span>
                    </MudTooltip>
                    @if (TelemetryQuickActionsEnabled && TelemetryAvailable && CanReplay)
                    {
                        <MudTooltip Text="Open topology (telemetry)">
                            <div class="artifact-card-telemetry-icon" @onclick:stopPropagation="true">
                                <MudIconButton Icon="@Icons.Material.Filled.AccountTree"
                                               Color="Color.Secondary"
                                               Size="Size.Small"
                                               Disabled="!TelemetryAvailable || !CanReplay"
                                               OnClick="HandleTelemetryTopologyIconClick"
                                               @attributes="topologyTelemetryAriaAttributes" />
                                <span class="artifact-card-telemetry-dot"></span>
                            </div>
                        </MudTooltip>
                    }
                </MudStack>
            </MudStack>
        </div>
    </div>
</MudPaper>

@code {
    [Parameter] public RunListEntry Run { get; set; } = default!;
    [Parameter] public ArtifactRunStatus Status { get; set; }
    [Parameter] public EventCallback<RunListEntry> OnActivate { get; set; }
    [Parameter] public EventCallback<RunListEntry> OnDashboard { get; set; }
    [Parameter] public EventCallback<RunListEntry> OnTopology { get; set; }
    [Parameter] public bool TelemetryQuickActionsEnabled { get; set; } = true;
    [Parameter] public bool IsSelected { get; set; }
    [Parameter] public string? TemplateIcon { get; set; }

    private string CssClass => IsSelected ? "artifact-card artifact-card--active" : "artifact-card";

    private string DisplayTitle => string.IsNullOrWhiteSpace(Run.TemplateTitle) ? Run.TemplateId : Run.TemplateTitle!;

    private string CreatedShortLabel => Run.CreatedUtc is null
        ? "Unknown"
        : Run.CreatedUtc.Value.ToString("yyyy-MM-dd HH:mm", CultureInfo.InvariantCulture);

    private string ModeLabel => string.IsNullOrWhiteSpace(Run.Source)
        ? "UNKNOWN"
        : Run.Source.ToUpperInvariant();

    private string MetadataText => CreatedShortLabel;

    private string WarningsText => Run.WarningCount > 0
        ? $"Warnings: {Run.WarningCount}"
        : "Warnings: None";

    private bool TelemetryAvailable => Run.Telemetry?.Available == true;
    private bool CanReplay => Run.CanReplay;

    private string TelemetryStatusLabel => TelemetryAvailable ? "Telemetry ready" : string.Empty;

    private string TelemetryDetailLine
    {
        get
        {
            if (TelemetryAvailable)
            {
                return !string.IsNullOrWhiteSpace(Run.Telemetry!.GeneratedAtUtc)
                    ? $"Captured {Run.Telemetry.GeneratedAtUtc}"
                    : string.Empty;
            }

            return string.Empty;
        }
    }

    private static readonly Color[] AvatarPalette =
    {
        Color.Primary,
        Color.Info,
        Color.Success,
        Color.Secondary,
        Color.Tertiary,
        Color.Warning,
        Color.Dark,
        Color.Surface
    };

    private Color IconAvatarColor => Color.Primary;

    private Color AvatarColor
    {
        get
        {
            var key = Run.TemplateId ?? string.Empty;
            if (string.IsNullOrWhiteSpace(key))
            {
                key = Run.TemplateTitle ?? Run.RunId ?? "default";
            }

            var hash = 0;
            foreach (var ch in key)
            {
                hash = ((hash << 5) - hash) + ch;
            }

            var index = Math.Abs(hash) % AvatarPalette.Length;
            return AvatarPalette[index];
        }
    }

    private string AvatarLabel
    {
        get
        {
            var source = !string.IsNullOrWhiteSpace(Run.TemplateTitle)
                ? Run.TemplateTitle!
                : Run.TemplateId;

            if (string.IsNullOrWhiteSpace(source))
            {
                return string.IsNullOrWhiteSpace(Run.RunId)
                    ? "?"
                    : new string(Run.RunId.Trim().Take(2).ToArray()).ToUpperInvariant();
            }

            var separators = new[] { ' ', '-', '_', '.' };
            var parts = source.Split(separators, StringSplitOptions.RemoveEmptyEntries);

            if (parts.Length == 0)
            {
                return source[..Math.Min(2, source.Length)].ToUpperInvariant();
            }

            if (parts.Length == 1)
            {
                var segment = parts[0];
                return segment[..Math.Min(2, segment.Length)].ToUpperInvariant();
            }

            var initials = new[] { parts[0][0], parts[1][0] };
            return new string(initials).ToUpperInvariant();
        }
    }

    private string AvatarTextStyle => AvatarColor switch
    {
        Color.Warning or Color.Surface => "color: rgba(0, 0, 0, 0.8); font-weight:600;",
        _ => "color: rgba(255,255,255,0.95); font-weight:600;"
    };

    private IReadOnlyDictionary<string, object> BuildCardAttributes()
    {
        return new Dictionary<string, object>
        {
            ["role"] = "button",
            ["tabindex"] = 0,
            ["aria-label"] = BuildCardAriaLabel()
        };
    }

    private string BuildCardAriaLabel()
    {
        var builder = new StringBuilder();
        builder.Append(DisplayTitle);
        builder.Append(", run ");
        builder.Append(Run.RunId);
        builder.Append(". ");
        builder.Append("Mode ");
        builder.Append(ModeLabel);
        if (TelemetryAvailable)
        {
            builder.Append(". Telemetry ready.");
        }
        builder.Append(" ");
        builder.Append(WarningsText);

        return builder.ToString();
    }

    private async Task HandleClick()
    {
        if (OnActivate.HasDelegate)
        {
            await OnActivate.InvokeAsync(Run);
        }
    }

    private async Task HandleDashboardIconClick(MouseEventArgs args)
    {
        await HandleDashboard();
    }

    private async Task HandleDashboard()
    {
        if (OnDashboard.HasDelegate)
        {
            await OnDashboard.InvokeAsync(Run);
        }
    }

    private async Task HandleTelemetryDashboardIconClick(MouseEventArgs args)
    {
        await HandleTelemetryDashboard();
    }

    private async Task HandleTopology()
    {
        if (OnTopology.HasDelegate)
        {
            await OnTopology.InvokeAsync(Run);
        }
    }

    private async Task HandleTopologyIconClick(MouseEventArgs args)
    {
        await HandleTopology();
    }

    private async Task HandleTelemetryTopologyIconClick(MouseEventArgs args)
    {
        await HandleTelemetryTopology();
    }

    private static readonly IReadOnlyDictionary<string, object> dashboardAriaAttributes =
        new Dictionary<string, object> { ["aria-label"] = "Open dashboard" };

    private static readonly IReadOnlyDictionary<string, object> dashboardTelemetryAriaAttributes =
        new Dictionary<string, object> { ["aria-label"] = "Open dashboard telemetry" };

    private static readonly IReadOnlyDictionary<string, object> topologyAriaAttributes =
        new Dictionary<string, object> { ["aria-label"] = "Open topology" };

    private static readonly IReadOnlyDictionary<string, object> topologyTelemetryAriaAttributes =
        new Dictionary<string, object> { ["aria-label"] = "Open telemetry topology" };

    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private Task HandleTelemetryDashboard()
    {
        if (string.IsNullOrWhiteSpace(Run.RunId))
        {
            return Task.CompletedTask;
        }

        var uri = $"/time-travel/dashboard?runId={Uri.EscapeDataString(Run.RunId)}&mode=telemetry";
        Navigation.NavigateTo(uri);
        return Task.CompletedTask;
    }

    private Task HandleTelemetryTopology()
    {
        if (string.IsNullOrWhiteSpace(Run.RunId))
        {
            return Task.CompletedTask;
        }

        var uri = $"/time-travel/topology?runId={Uri.EscapeDataString(Run.RunId)}&mode=telemetry";
        Navigation.NavigateTo(uri);
        return Task.CompletedTask;
    }

    private async Task HandleKeyDown(KeyboardEventArgs args)
    {
        if (args.Key is "Enter" or " " or "Spacebar")
        {
            await HandleClick();
        }
    }
}
