@using MudBlazor
@using FlowTime.UI.Components.Topology

<MudStack Class="topology-feature-bar" Spacing="2">
    <MudStack Row="true" AlignItems="@AlignItems.Center" Justify="@Justify.SpaceBetween">
        <MudText Typo="Typo.subtitle2">Topology Features</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close"
                       Size="Size.Small"
                       AriaLabel="Close topology feature bar"
                       OnClick="Close" />
    </MudStack>

    <MudStack Spacing="2">
        <MudText Typo="Typo.caption" Class="mb-1">Overlays</MudText>
        <MudSwitch T="bool"
                   Value="@workingSettings.ShowLabels"
                   ValueChanged="OnShowLabelsChanged"
                   Color="Color.Primary"
                   Label="Show node labels" />
        <MudSwitch T="bool"
                   Value="@workingSettings.ShowEdgeArrows"
                   ValueChanged="OnShowEdgeArrowsChanged"
                   Color="Color.Primary"
                   Label="Show edge arrows" />
        <MudSwitch T="bool"
                   Value="@workingSettings.ShowEdgeShares"
                   ValueChanged="OnShowEdgeSharesChanged"
                   Color="Color.Primary"
                   Label="Show edge shares" />
        <MudSwitch T="bool"
                   Value="@workingSettings.ShowSparklines"
                   ValueChanged="OnShowSparklinesChanged"
                   Color="Color.Primary"
                   Label="Show sparklines" />
        <MudRadioGroup T="SparklineRenderMode"
                       Value="@workingSettings.SparklineMode"
                       ValueChanged="OnSparklineModeChanged"
                       Disabled="@(!workingSettings.ShowSparklines)"
                       Orientation="Orientation.Horizontal">
            <MudRadio T="SparklineRenderMode" Value="SparklineRenderMode.Line" Color="Color.Primary">Line</MudRadio>
            <MudRadio T="SparklineRenderMode" Value="SparklineRenderMode.Bar" Color="Color.Primary">Bars</MudRadio>
        </MudRadioGroup>
    </MudStack>

    <MudStack Spacing="2" Class="mt-2">
        <MudText Typo="Typo.caption" Class="mb-1">Topology</MudText>
        <MudSwitch T="bool"
                   Value="@workingSettings.EnableFullDag"
                   ValueChanged="OnEnableFullDagChanged"
                   Color="Color.Primary"
                   Label="Full DAG mode" />
        <MudCheckBox T="bool"
                     Value="@workingSettings.IncludeServiceNodes"
                     ValueChanged="OnIncludeServiceNodesChanged"
                     Color="Color.Primary"
                     Label="Include service nodes" />
        <MudCheckBox T="bool"
                     Value="@workingSettings.IncludeExpressionNodes"
                     ValueChanged="OnIncludeExpressionNodesChanged"
                     Color="Color.Primary"
                     Label="Include expression nodes" />
        <MudCheckBox T="bool"
                     Value="@workingSettings.IncludeConstNodes"
                     ValueChanged="OnIncludeConstNodesChanged"
                     Color="Color.Primary"
                     Label="Include constant nodes" />
        <MudCheckBox T="bool"
                     Value="@workingSettings.NeighborEmphasis"
                     ValueChanged="OnNeighborEmphasisChanged"
                     Color="Color.Primary"
                     Label="Neighbor emphasis on focus" />
    </MudStack>

    <MudStack Spacing="2" Class="mt-2">
        <MudText Typo="Typo.caption" Class="mb-1">Level of detail</MudText>
        <MudSwitch T="bool"
                   Value="@workingSettings.AutoLod"
                   ValueChanged="OnAutoLodChanged"
                   Color="Color.Primary"
                   Label="Auto adjust overlays by zoom" />
        <MudNumericField T="double"
                         Dense="true"
                         Variant="Variant.Outlined"
                         Value="@workingSettings.ZoomLowThreshold"
                         ValueChanged="OnZoomLowChanged"
                         Label="Labels appear at scale ≥"
                         Immediate="true"
                         Adornment="Adornment.End"
                         AdornmentText="x" />
        <MudNumericField T="double"
                         Dense="true"
                         Variant="Variant.Outlined"
                         Value="@workingSettings.ZoomMidThreshold"
                         ValueChanged="OnZoomMidChanged"
                         Label="Detail overlays at scale ≥"
                         Immediate="true"
                         Adornment="Adornment.End"
                         AdornmentText="x" />
    </MudStack>

    <MudStack Spacing="2" Class="mt-2">
        <MudText Typo="Typo.caption" Class="mb-1">Color basis</MudText>
        <MudRadioGroup T="TopologyColorBasis"
                       Value="@workingSettings.ColorBasis"
                       ValueChanged="OnColorBasisChanged">
            <MudRadio T="TopologyColorBasis" Value="TopologyColorBasis.Sla" Color="Color.Primary">SLA (success ratio)</MudRadio>
            <MudRadio T="TopologyColorBasis" Value="TopologyColorBasis.Utilization" Color="Color.Primary">Utilization</MudRadio>
            <MudRadio T="TopologyColorBasis" Value="TopologyColorBasis.Errors" Color="Color.Primary">Error rate</MudRadio>
            <MudRadio T="TopologyColorBasis" Value="TopologyColorBasis.Queue" Color="Color.Primary">Queue depth</MudRadio>
        </MudRadioGroup>

        <MudNumericField T="double"
                         Dense="true"
                         Variant="Variant.Outlined"
                         Value="@workingSettings.SlaWarningThreshold"
                         ValueChanged="OnSlaThresholdChanged"
                         Label="SLA warning ≥"
                         Immediate="true"
                         Adornment="Adornment.End"
                         AdornmentText="ratio" />
        <MudNumericField T="double"
                         Dense="true"
                         Variant="Variant.Outlined"
                         Value="@workingSettings.UtilizationWarningThreshold"
                         ValueChanged="OnUtilThresholdChanged"
                         Label="Utilization warn ≥"
                         Immediate="true"
                         Adornment="Adornment.End"
                         AdornmentText="ratio" />
        <MudNumericField T="double"
                         Dense="true"
                         Variant="Variant.Outlined"
                         Value="@workingSettings.ErrorRateAlertThreshold"
                         ValueChanged="OnErrorThresholdChanged"
                         Label="Error alert ≥"
                         Immediate="true"
                         Adornment="Adornment.End"
                         AdornmentText="ratio" />
    </MudStack>

    <MudStack Spacing="2" Class="mt-2">
        <MudText Typo="Typo.caption">
            Edge shares, sparklines, and full DAG filtering follow these settings. “Auto” picks sensible defaults based on zoom level.
        </MudText>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Secondary"
                   Size="Size.Small"
                   OnClick="ResetSettings">
            Reset to defaults
        </MudButton>
    </MudStack>
</MudStack>

@code {
    [Parameter]
    public TopologyOverlaySettings Settings { get; set; } = TopologyOverlaySettings.Default;

    [Parameter]
    public EventCallback<TopologyOverlaySettings> SettingsChanged { get; set; }

    [Parameter]
    public EventCallback CloseRequested { get; set; }

    private TopologyOverlaySettings workingSettings = TopologyOverlaySettings.Default;
    private TopologyOverlaySettings? lastReceivedSettings;

    protected override void OnParametersSet()
    {
        if (!ReferenceEquals(lastReceivedSettings, Settings))
        {
            workingSettings = Settings.Clone();
            lastReceivedSettings = Settings;
        }
    }

    private Task Close() => CloseRequested.InvokeAsync();

    private Task OnShowLabelsChanged(bool value)
    {
        if (workingSettings.ShowLabels == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowLabels = value;
        return NotifyChange();
    }

    private Task OnShowEdgeArrowsChanged(bool value)
    {
        if (workingSettings.ShowEdgeArrows == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowEdgeArrows = value;
        return NotifyChange();
    }

    private Task OnShowEdgeSharesChanged(bool value)
    {
        if (workingSettings.ShowEdgeShares == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowEdgeShares = value;
        return NotifyChange();
    }

    private Task OnShowSparklinesChanged(bool value)
    {
        if (workingSettings.ShowSparklines == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowSparklines = value;
        return NotifyChange();
    }

    private Task OnSparklineModeChanged(SparklineRenderMode value)
    {
        if (workingSettings.SparklineMode == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.SparklineMode = value;
        return NotifyChange();
    }

    private Task OnEnableFullDagChanged(bool value)
    {
        if (workingSettings.EnableFullDag == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.EnableFullDag = value;
        return NotifyChange();
    }

    private Task OnIncludeServiceNodesChanged(bool value)
    {
        if (workingSettings.IncludeServiceNodes == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.IncludeServiceNodes = value;
        return NotifyChange();
    }

    private Task OnIncludeExpressionNodesChanged(bool value)
    {
        if (workingSettings.IncludeExpressionNodes == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.IncludeExpressionNodes = value;
        return NotifyChange();
    }

    private Task OnIncludeConstNodesChanged(bool value)
    {
        if (workingSettings.IncludeConstNodes == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.IncludeConstNodes = value;
        return NotifyChange();
    }

    private Task OnNeighborEmphasisChanged(bool value)
    {
        if (workingSettings.NeighborEmphasis == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.NeighborEmphasis = value;
        return NotifyChange();
    }

    private Task OnAutoLodChanged(bool value)
    {
        if (workingSettings.AutoLod == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.AutoLod = value;
        return NotifyChange();
    }

    private Task OnZoomLowChanged(double value)
    {
        workingSettings.ZoomLowThreshold = value;
        return NotifyChange();
    }

    private Task OnZoomMidChanged(double value)
    {
        workingSettings.ZoomMidThreshold = value;
        return NotifyChange();
    }

    private Task OnColorBasisChanged(TopologyColorBasis value)
    {
        workingSettings.ColorBasis = value;
        return NotifyChange();
    }

    private Task OnSlaThresholdChanged(double value)
    {
        workingSettings.SlaWarningThreshold = value;
        return NotifyChange();
    }

    private Task OnUtilThresholdChanged(double value)
    {
        workingSettings.UtilizationWarningThreshold = value;
        return NotifyChange();
    }

    private Task OnErrorThresholdChanged(double value)
    {
        workingSettings.ErrorRateAlertThreshold = value;
        return NotifyChange();
    }

    private Task ResetSettings()
    {
        workingSettings = TopologyOverlaySettings.Default.Clone();
        return NotifyChange();
    }

    private async Task NotifyChange()
    {
        await SettingsChanged.InvokeAsync(workingSettings.Clone());
        StateHasChanged();
    }
}
