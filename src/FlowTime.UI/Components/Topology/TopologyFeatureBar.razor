@using MudBlazor
@using FlowTime.UI.Components.Topology
@using System
@using System.Globalization

<MudStack Class="topology-feature-bar" Spacing="1">
    <MudStack Row="true" AlignItems="@AlignItems.Center" Justify="@Justify.SpaceBetween">
        <MudText Typo="Typo.body1">Topology Features</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close"
                       Size="Size.Small"
                       AriaLabel="Close topology feature bar"
                       OnClick="Close" />
    </MudStack>

    <MudStack Spacing="1" Class="mt-2">
        <MudText Typo="Typo.caption" Class="topology-section-title">Dependency edges</MudText>
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.ShowArrivalsDependencies"
                   ValueChanged="OnShowArrivalsDependenciesChanged"
                   Color="Color.Primary"
                   Label="Arrivals" />
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.ShowServedDependencies"
                   ValueChanged="OnShowServedDependenciesChanged"
                   Color="Color.Primary"
                   Label="Served" />
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.ShowErrorsDependencies"
                   ValueChanged="OnShowErrorsDependenciesChanged"
                   Color="Color.Primary"
                   Label="Errors" />
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.ShowQueueDependencies"
                   ValueChanged="OnShowQueueDependenciesChanged"
                   Color="Color.Primary"
                   Label="Queue" />
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.ShowCapacityDependencies"
                   ValueChanged="OnShowCapacityDependenciesChanged"
                   Color="Color.Primary"
                   Label="Capacity" />
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.ShowExpressionDependencies"
                   ValueChanged="OnShowExpressionDependenciesChanged"
                   Color="Color.Primary"
                   Label="Expression inputs" />
        <MudDivider Class="topology-divider" />
    </MudStack>

    <MudStack Spacing="1">
        <MudText Typo="Typo.caption" Class="topology-section-title">Overlays</MudText>
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.ShowLabels"
                   ValueChanged="OnShowLabelsChanged"
                   Color="Color.Primary"
                   Label="Show node labels" />
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.ShowEdgeArrows"
                   ValueChanged="OnShowEdgeArrowsChanged"
                   Color="Color.Primary"
                   Label="Show edge arrows" />
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.ShowEdgeShares"
                   ValueChanged="OnShowEdgeSharesChanged"
                   Color="Color.Primary"
                   Label="Show edge shares" />
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.ShowSparklines"
                   ValueChanged="OnShowSparklinesChanged"
                   Color="Color.Primary"
                   Label="Show sparklines" />
        <MudRadioGroup T="SparklineRenderMode"
                       Value="@workingSettings.SparklineMode"
                       ValueChanged="OnSparklineModeChanged"
                       Disabled="@(!workingSettings.ShowSparklines)"
                       Orientation="Orientation.Horizontal"
                       Dense="true"
                       Class="topology-dense-control">
            <MudRadio T="SparklineRenderMode" Value="SparklineRenderMode.Line" Color="Color.Primary">Line</MudRadio>
            <MudRadio T="SparklineRenderMode" Value="SparklineRenderMode.Bar" Color="Color.Primary">Bars</MudRadio>
        </MudRadioGroup>
        <MudDivider Class="topology-divider" />
    </MudStack>

    <MudStack Spacing="1" Class="mt-2">
        <MudText Typo="Typo.caption" Class="topology-section-title">Edge routing</MudText>
        <MudRadioGroup T="EdgeRenderMode"
                       Value="@workingSettings.EdgeStyle"
                       ValueChanged="OnEdgeStyleChanged"
                       Orientation="Orientation.Horizontal"
                       Dense="true"
                       Class="topology-dense-control">
            <MudRadio T="EdgeRenderMode" Value="EdgeRenderMode.Orthogonal" Color="Color.Primary">Orthogonal</MudRadio>
            <MudRadio T="EdgeRenderMode" Value="EdgeRenderMode.Bezier" Color="Color.Primary">Bezier</MudRadio>
        </MudRadioGroup>
        <MudDivider Class="topology-divider" />
    </MudStack>

    <MudStack Spacing="1" Class="mt-2">
        <MudText Typo="Typo.caption" Class="topology-section-title">Topology</MudText>
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.EnableFullDag"
                   ValueChanged="OnEnableFullDagChanged"
                   Color="Color.Primary"
                   Label="Full DAG mode" />
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.RespectUiPositions"
                   ValueChanged="OnRespectUiPositionsChanged"
                   Color="Color.Primary"
                   Label="Use template positions" />
        <MudSwitch T="bool"
                   Dense="true"
                   Class="topology-dense-control"
                   Value="@workingSettings.ShowComputeNodes"
                   ValueChanged="OnShowComputeNodesChanged"
                   Color="Color.Primary"
                   Disabled="@(!workingSettings.EnableFullDag)"
                   Label="Show compute nodes" />

        <MudText Typo="Typo.caption" Class="mt-2">Layout mode</MudText>
        <MudRadioGroup T="LayoutMode"
                       Value="@workingSettings.Layout"
                       ValueChanged="OnLayoutModeChanged"
                       Orientation="Orientation.Horizontal"
                       Dense="true"
                       Class="topology-dense-control">
            <MudRadio T="LayoutMode" Value="LayoutMode.Layered" Color="Color.Primary">Layered</MudRadio>
            <MudRadio T="LayoutMode" Value="LayoutMode.HappyPath" Color="Color.Primary">Happy Path (beta)</MudRadio>
        </MudRadioGroup>
        <MudCheckBox T="bool"
                     Dense="true"
                     Class="topology-dense-control"
                     Value="@workingSettings.IncludeServiceNodes"
                     ValueChanged="OnIncludeServiceNodesChanged"
                     Color="Color.Primary"
                     Label="Include service nodes" />
        <MudCheckBox T="bool"
                     Dense="true"
                     Class="topology-dense-control"
                     Value="@workingSettings.IncludeExpressionNodes"
                     ValueChanged="OnIncludeExpressionNodesChanged"
                     Disabled="@(!workingSettings.EnableFullDag)"
                     Color="Color.Primary"
                     Label="Include expression nodes" />
        <MudCheckBox T="bool"
                     Dense="true"
                     Class="topology-dense-control"
                     Value="@workingSettings.IncludeConstNodes"
                     ValueChanged="OnIncludeConstNodesChanged"
                     Disabled="@(!workingSettings.EnableFullDag)"
                     Color="Color.Primary"
                     Label="Include constant nodes" />
        <MudCheckBox T="bool"
                     Dense="true"
                     Class="topology-dense-control"
                     Value="@workingSettings.NeighborEmphasis"
                     ValueChanged="OnNeighborEmphasisChanged"
                     Color="Color.Primary"
                     Label="Neighbor emphasis on focus" />
        <MudDivider Class="topology-divider" />
    </MudStack>

    <MudStack Spacing="1" Class="mt-2">
        <MudText Typo="Typo.caption" Class="topology-section-title">Canvas zoom</MudText>
        <MudStack Row="true" AlignItems="@AlignItems.Center" Spacing="1">
            <MudSlider T="double"
                       Class="flex-grow-1"
                       Value="@workingSettings.ZoomPercent"
                       ValueChanged="OnZoomPercentChanged"
                       Min="30"
                       Max="400"
                       Step="5"
                       Immediate="true"
                       Size="Size.Small"
                       ValueLabel="false" />
            <MudText Typo="Typo.caption">@workingSettings.ZoomPercent.ToString("0")%</MudText>
        </MudStack>
        <MudDivider Class="topology-divider" />
    </MudStack>

    <MudStack Spacing="1" Class="mt-2">
        <MudText Typo="Typo.caption" Class="topology-section-title">Color basis</MudText>
        <MudRadioGroup T="TopologyColorBasis"
                       Value="@workingSettings.ColorBasis"
                       ValueChanged="OnColorBasisChanged"
                       Dense="true"
                       Class="topology-dense-control">
            <MudRadio T="TopologyColorBasis" Value="TopologyColorBasis.Sla" Color="Color.Primary" Dense="true">SLA (success ratio)</MudRadio>
            <MudRadio T="TopologyColorBasis" Value="TopologyColorBasis.Utilization" Color="Color.Primary" Dense="true">Utilization</MudRadio>
            <MudRadio T="TopologyColorBasis" Value="TopologyColorBasis.Errors" Color="Color.Primary" Dense="true">Error rate</MudRadio>
            <MudRadio T="TopologyColorBasis" Value="TopologyColorBasis.Queue" Color="Color.Primary" Dense="true">Queue depth</MudRadio>
        </MudRadioGroup>

        <MudText Typo="Typo.caption">SLA warning threshold</MudText>
        <MudStack Row="true" AlignItems="@AlignItems.Center" Spacing="1">
            <MudSlider T="double"
                       Class="flex-grow-1"
                       Value="@workingSettings.SlaWarningThreshold"
                       ValueChanged="OnSlaThresholdChanged"
                       Min="0"
                       Max="1"
                       Step="0.01"
                       Immediate="true"
                       Size="Size.Small"
                       ValueLabel="false" />
            <MudText Typo="Typo.caption">@workingSettings.SlaWarningThreshold.ToString("0%", CultureInfo.InvariantCulture)</MudText>
        </MudStack>

        <MudText Typo="Typo.caption">Utilization warning threshold</MudText>
        <MudStack Row="true" AlignItems="@AlignItems.Center" Spacing="1">
            <MudSlider T="double"
                       Class="flex-grow-1"
                       Value="@workingSettings.UtilizationWarningThreshold"
                       ValueChanged="OnUtilThresholdChanged"
                       Min="0"
                       Max="1"
                       Step="0.01"
                       Immediate="true"
                       Size="Size.Small"
                       ValueLabel="false" />
            <MudText Typo="Typo.caption">@workingSettings.UtilizationWarningThreshold.ToString("0%", CultureInfo.InvariantCulture)</MudText>
        </MudStack>

        <MudText Typo="Typo.caption">Error alert threshold</MudText>
        <MudStack Row="true" AlignItems="@AlignItems.Center" Spacing="1">
            <MudSlider T="double"
                       Class="flex-grow-1"
                       Value="@workingSettings.ErrorRateAlertThreshold"
                       ValueChanged="OnErrorThresholdChanged"
                       Min="0"
                       Max="0.5"
                       Step="0.01"
                       Immediate="true"
                       Size="Size.Small"
                       ValueLabel="false" />
            <MudText Typo="Typo.caption">@workingSettings.ErrorRateAlertThreshold.ToString("0.0%", CultureInfo.InvariantCulture)</MudText>
        </MudStack>
        <MudDivider Class="topology-divider" />
    </MudStack>

    <MudStack Spacing="1" Class="mt-2">
        <MudText Typo="Typo.caption">
            Edge shares, sparklines, and full DAG filtering follow these settings. “Auto” picks sensible defaults based on zoom level.
        </MudText>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Secondary"
                   Size="Size.Small"
                   OnClick="ResetSettings">
            Reset to defaults
        </MudButton>
    </MudStack>
</MudStack>

@code {
    [Parameter]
    public TopologyOverlaySettings Settings { get; set; } = TopologyOverlaySettings.Default;

    [Parameter]
    public EventCallback<TopologyOverlaySettings> SettingsChanged { get; set; }

    [Parameter]
    public EventCallback CloseRequested { get; set; }

    private TopologyOverlaySettings workingSettings = TopologyOverlaySettings.Default;
    private TopologyOverlaySettings? lastReceivedSettings;

    protected override void OnParametersSet()
    {
        if (!ReferenceEquals(lastReceivedSettings, Settings))
        {
            workingSettings = Settings.Clone();
            lastReceivedSettings = Settings;
        }
    }

    private Task Close() => CloseRequested.InvokeAsync();

    private Task OnShowLabelsChanged(bool value)
    {
        if (workingSettings.ShowLabels == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowLabels = value;
        return NotifyChange();
    }

    private Task OnShowEdgeArrowsChanged(bool value)
    {
        if (workingSettings.ShowEdgeArrows == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowEdgeArrows = value;
        return NotifyChange();
    }

    private Task OnShowEdgeSharesChanged(bool value)
    {
        if (workingSettings.ShowEdgeShares == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowEdgeShares = value;
        return NotifyChange();
    }

    private Task OnShowSparklinesChanged(bool value)
    {
        if (workingSettings.ShowSparklines == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowSparklines = value;
        return NotifyChange();
    }

    private Task OnSparklineModeChanged(SparklineRenderMode value)
    {
        if (workingSettings.SparklineMode == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.SparklineMode = value;
        return NotifyChange();
    }

    private Task OnEdgeStyleChanged(EdgeRenderMode value)
    {
        if (workingSettings.EdgeStyle == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.EdgeStyle = value;
        return NotifyChange();
    }

    private Task OnEnableFullDagChanged(bool value)
    {
        if (workingSettings.EnableFullDag == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.EnableFullDag = value;

        if (value && !workingSettings.IncludeExpressionNodes && !workingSettings.IncludeConstNodes)
        {
            workingSettings.IncludeExpressionNodes = true;
            workingSettings.IncludeConstNodes = true;
        }

        return NotifyChange();
    }

    private Task OnRespectUiPositionsChanged(bool value)
    {
        if (workingSettings.RespectUiPositions == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.RespectUiPositions = value;
        return NotifyChange();
    }

    private Task OnLayoutModeChanged(LayoutMode value)
    {
        if (workingSettings.Layout == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.Layout = value;
        return NotifyChange();
    }

    private Task OnShowComputeNodesChanged(bool value)
    {
        if (workingSettings.ShowComputeNodes == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowComputeNodes = value;
        return NotifyChange();
    }

    private Task OnIncludeServiceNodesChanged(bool value)
    {
        if (workingSettings.IncludeServiceNodes == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.IncludeServiceNodes = value;
        return NotifyChange();
    }

    private Task OnIncludeExpressionNodesChanged(bool value)
    {
        if (workingSettings.IncludeExpressionNodes == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.IncludeExpressionNodes = value;
        return NotifyChange();
    }

    private Task OnIncludeConstNodesChanged(bool value)
    {
        if (workingSettings.IncludeConstNodes == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.IncludeConstNodes = value;
        return NotifyChange();
    }

    private Task OnShowArrivalsDependenciesChanged(bool value)
    {
        if (workingSettings.ShowArrivalsDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowArrivalsDependencies = value;
        return NotifyChange();
    }

    private Task OnShowServedDependenciesChanged(bool value)
    {
        if (workingSettings.ShowServedDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowServedDependencies = value;
        return NotifyChange();
    }

    private Task OnShowErrorsDependenciesChanged(bool value)
    {
        if (workingSettings.ShowErrorsDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowErrorsDependencies = value;
        return NotifyChange();
    }

    private Task OnShowQueueDependenciesChanged(bool value)
    {
        if (workingSettings.ShowQueueDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowQueueDependencies = value;
        return NotifyChange();
    }

    private Task OnShowCapacityDependenciesChanged(bool value)
    {
        if (workingSettings.ShowCapacityDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowCapacityDependencies = value;
        return NotifyChange();
    }

    private Task OnShowExpressionDependenciesChanged(bool value)
    {
        if (workingSettings.ShowExpressionDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowExpressionDependencies = value;
        return NotifyChange();
    }

    private Task OnNeighborEmphasisChanged(bool value)
    {
        if (workingSettings.NeighborEmphasis == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.NeighborEmphasis = value;
        return NotifyChange();
    }

    private Task OnAutoLodChanged(bool value)
    {
        if (workingSettings.AutoLod == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.AutoLod = value;
        return NotifyChange();
    }

    private Task OnZoomLowChanged(double value)
    {
        var clamped = Math.Clamp(value, 0.1d, 4d);
        if (Math.Abs(workingSettings.ZoomLowThreshold - clamped) < 0.01d)
        {
            return Task.CompletedTask;
        }

        workingSettings.ZoomLowThreshold = clamped;
        return NotifyChange();
    }

    private Task OnZoomMidChanged(double value)
    {
        var clamped = Math.Clamp(value, 0.1d, 4d);
        if (Math.Abs(workingSettings.ZoomMidThreshold - clamped) < 0.01d)
        {
            return Task.CompletedTask;
        }

        workingSettings.ZoomMidThreshold = clamped;
        return NotifyChange();
    }

    private Task OnZoomPercentChanged(double value)
    {
        var clamped = Math.Clamp(value, 30d, 200d);
        if (Math.Abs(workingSettings.ZoomPercent - clamped) < 0.01d)
        {
            return Task.CompletedTask;
        }

        workingSettings.ZoomPercent = clamped;
        return NotifyChange();
    }

    private Task OnColorBasisChanged(TopologyColorBasis value)
    {
        workingSettings.ColorBasis = value;
        return NotifyChange();
    }

    private Task OnSlaThresholdChanged(double value)
    {
        var clamped = Math.Clamp(value, 0d, 1d);
        if (Math.Abs(workingSettings.SlaWarningThreshold - clamped) < 0.001d)
        {
            return Task.CompletedTask;
        }

        workingSettings.SlaWarningThreshold = clamped;
        return NotifyChange();
    }

    private Task OnUtilThresholdChanged(double value)
    {
        var clamped = Math.Clamp(value, 0d, 1d);
        if (Math.Abs(workingSettings.UtilizationWarningThreshold - clamped) < 0.001d)
        {
            return Task.CompletedTask;
        }

        workingSettings.UtilizationWarningThreshold = clamped;
        return NotifyChange();
    }

    private Task OnErrorThresholdChanged(double value)
    {
        var clamped = Math.Clamp(value, 0d, 0.5d);
        if (Math.Abs(workingSettings.ErrorRateAlertThreshold - clamped) < 0.001d)
        {
            return Task.CompletedTask;
        }

        workingSettings.ErrorRateAlertThreshold = clamped;
        return NotifyChange();
    }

    private Task ResetSettings()
    {
        workingSettings = TopologyOverlaySettings.Default.Clone();
        return NotifyChange();
    }

    private async Task NotifyChange()
    {
        await SettingsChanged.InvokeAsync(workingSettings.Clone());
        StateHasChanged();
    }
}
