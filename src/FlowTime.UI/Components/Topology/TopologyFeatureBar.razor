@using MudBlazor
@using FlowTime.UI.Components.Topology
@using System
@using System.Collections.Generic
@using System.Globalization

<MudStack Class="topology-feature-bar" Spacing="1">
    <MudStack Row="true" AlignItems="@AlignItems.Center" Justify="@Justify.SpaceBetween">
        <MudText Typo="Typo.body1">Topology Features</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close"
                       Size="Size.Small"
                       OnClick="Close"
                       @attributes="featureBarCloseButtonAttributes" />
    </MudStack>

    <div class="topology-feature-scroll">
        <MudExpansionPanels MultiExpansion="true" Class="topology-feature-panels">
            <MudExpansionPanel Text="Dependency edges"
                               Expanded="@IsExpanded(TopologyFeatureSection.DependencyEdges)"
                               ExpandedChanged="expanded => SetSectionExpanded(TopologyFeatureSection.DependencyEdges, expanded)">
                <MudStack Spacing="1" Class="topology-section-body">
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowArrivalsDependencies"
                               ValueChanged="OnShowArrivalsDependenciesChanged"
                               Color="Color.Primary"
                               Label="Arrivals" />
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowServedDependencies"
                               ValueChanged="OnShowServedDependenciesChanged"
                               Color="Color.Primary"
                               Label="Served" />
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowErrorsDependencies"
                               ValueChanged="OnShowErrorsDependenciesChanged"
                               Color="Color.Primary"
                               Label="Errors" />
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowQueueDependencies"
                               ValueChanged="OnShowQueueDependenciesChanged"
                               Color="Color.Primary"
                               Label="Queue" />
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowCapacityDependencies"
                               ValueChanged="OnShowCapacityDependenciesChanged"
                               Color="Color.Primary"
                               Label="Capacity" />
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowExpressionDependencies"
                               ValueChanged="OnShowExpressionDependenciesChanged"
                               Color="Color.Primary"
                               Label="Expression inputs" />
                </MudStack>
            </MudExpansionPanel>

            <MudExpansionPanel Text="Overlays"
                               Expanded="@IsExpanded(TopologyFeatureSection.Overlays)"
                               ExpandedChanged="expanded => SetSectionExpanded(TopologyFeatureSection.Overlays, expanded)">
                <MudStack Spacing="1" Class="topology-section-body">
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowLabels"
                               ValueChanged="OnShowLabelsChanged"
                               Color="Color.Primary"
                               Label="Show node labels" />
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowEdgeArrows"
                               ValueChanged="OnShowEdgeArrowsChanged"
                               Color="Color.Primary"
                               Label="Show edge arrows" />
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowEdgeShares"
                               ValueChanged="OnShowEdgeSharesChanged"
                               Color="Color.Primary"
                               Label="Show edge shares" />
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowEdgeMultipliers"
                               ValueChanged="OnShowEdgeMultipliersChanged"
                               Color="Color.Primary"
                               Label="Show edge multipliers" />
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowSparklines"
                               ValueChanged="OnShowSparklinesChanged"
                               Color="Color.Primary"
                               Label="Show sparklines" />
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowRetryMetrics"
                               ValueChanged="OnShowRetryMetricsChanged"
                               Color="Color.Primary"
                               Label="Show retry chips" />
                    <MudRadioGroup T="SparklineRenderMode"
                                   Value="@workingSettings.SparklineMode"
                                   ValueChanged="OnSparklineModeChanged"
                                   Disabled="@(!workingSettings.ShowSparklines)"
                                   Class="topology-dense-control"
                                   InputClass="topology-radio-row">
                        <MudRadio T="SparklineRenderMode" Value="SparklineRenderMode.Line" Color="Color.Primary">Line</MudRadio>
                        <MudRadio T="SparklineRenderMode" Value="SparklineRenderMode.Bar" Color="Color.Primary">Bars</MudRadio>
                    </MudRadioGroup>
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowRetryMetrics"
                               ValueChanged="OnShowRetryMetricsChanged"
                               Color="Color.Primary"
                               Label="Retry chips" />
                </MudStack>
            </MudExpansionPanel>

            <MudExpansionPanel Text="Inspector overview"
                               Expanded="@IsExpanded(TopologyFeatureSection.InspectorOverview)"
                               ExpandedChanged="expanded => SetSectionExpanded(TopologyFeatureSection.InspectorOverview, expanded)">
                <MudStack Spacing="1" Class="topology-section-body">
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.ShowInspectorOverview"
                               ValueChanged="OnShowInspectorOverviewChanged"
                               Color="Color.Primary"
                               Label="Show horizon under sparklines" />
                    <MudStack Row="true" AlignItems="@AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.caption">Bands</MudText>
                        <MudSlider T="int"
                                   Class="flex-grow-1"
                                   Value="@workingSettings.HorizonBands"
                                   ValueChanged="OnHorizonBandsChanged"
                                   Min="3"
                                   Max="5"
                                   Step="1"
                                   Immediate="true"
                                   Size="Size.Small"
                                   ValueLabel="false" />
                        <MudText Typo="Typo.caption">@workingSettings.HorizonBands</MudText>
                    </MudStack>
                    <MudCheckBox T="bool"
                                 Class="topology-dense-control"
                                 Value="@workingSettings.NormalizeInspectorHorizonCounts"
                                 ValueChanged="OnNormalizeHorizonChanged"
                                 Color="Color.Primary"
                                 Label="Normalize across nodes (use global cap)" />
                    <MudNumericField T="double?"
                                     Class="topology-dense-control"
                                     Label="Global cap (optional)"
                                     Culture="@CultureInfo.InvariantCulture"
                                     Value="@workingSettings.InspectorHorizonGlobalCap"
                                     ValueChanged="OnInspectorHorizonGlobalCapChanged"
                                     Disabled="@(!workingSettings.NormalizeInspectorHorizonCounts)"
                                     Min="0"
                                     Immediate="true" />
                </MudStack>
            </MudExpansionPanel>

            <MudExpansionPanel Text="Edge routing"
                               Expanded="@IsExpanded(TopologyFeatureSection.EdgeRouting)"
                               ExpandedChanged="expanded => SetSectionExpanded(TopologyFeatureSection.EdgeRouting, expanded)">
                <MudStack Spacing="1" Class="topology-section-body">
                    <MudRadioGroup T="EdgeRenderMode"
                                   Value="@workingSettings.EdgeStyle"
                                   ValueChanged="OnEdgeStyleChanged"
                                   Class="topology-dense-control"
                                   InputClass="topology-radio-row">
                        <MudRadio T="EdgeRenderMode" Value="EdgeRenderMode.Orthogonal" Color="Color.Primary">Orthogonal</MudRadio>
                        <MudRadio T="EdgeRenderMode" Value="EdgeRenderMode.Bezier" Color="Color.Primary">Bezier</MudRadio>
                    </MudRadioGroup>
                </MudStack>
            </MudExpansionPanel>

            <MudExpansionPanel Text="Topology"
                               Expanded="@IsExpanded(TopologyFeatureSection.Topology)"
                               ExpandedChanged="expanded => SetSectionExpanded(TopologyFeatureSection.Topology, expanded)">
                <MudStack Spacing="1" Class="topology-section-body">
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.EnableFullDag"
                               ValueChanged="OnEnableFullDagChanged"
                               Color="Color.Primary"
                               Label="Full DAG mode" />
                    <MudSwitch T="bool"
                               Class="topology-dense-control"
                               Value="@workingSettings.RespectUiPositions"
                               ValueChanged="OnRespectUiPositionsChanged"
                               Color="Color.Primary"
                               Label="Use template positions" />
                    <MudText Typo="Typo.caption">Layout mode</MudText>
                    <MudRadioGroup T="LayoutMode"
                                   Value="@workingSettings.Layout"
                                   ValueChanged="OnLayoutModeChanged"
                                   Class="topology-dense-control"
                                   InputClass="topology-radio-row">
                        <MudRadio T="LayoutMode" Value="LayoutMode.Layered" Color="Color.Primary">Layered</MudRadio>
                        <MudRadio T="LayoutMode" Value="LayoutMode.HappyPath" Color="Color.Primary">Happy Path (beta)</MudRadio>
                    </MudRadioGroup>
                    <MudCheckBox T="bool"
                                 Class="topology-dense-control"
                                 Value="@workingSettings.IncludeServiceNodes"
                                 ValueChanged="OnIncludeServiceNodesChanged"
                                 Color="Color.Primary"
                                 Label="Include service nodes" />
                    <MudCheckBox T="bool"
                                 Class="topology-dense-control"
                                 Value="@workingSettings.IncludeExpressionNodes"
                                 ValueChanged="OnIncludeExpressionNodesChanged"
                                 Disabled="@(!workingSettings.EnableFullDag)"
                                 Color="Color.Primary"
                                 Label="Include expression nodes" />
                    <MudCheckBox T="bool"
                                 Class="topology-dense-control"
                                 Value="@workingSettings.IncludeConstNodes"
                                 ValueChanged="OnIncludeConstNodesChanged"
                                 Disabled="@(!workingSettings.EnableFullDag)"
                                 Color="Color.Primary"
                                 Label="Include constant nodes" />
                    <MudCheckBox T="bool"
                                 Class="topology-dense-control"
                                 Value="@workingSettings.NeighborEmphasis"
                                 ValueChanged="OnNeighborEmphasisChanged"
                                 Color="Color.Primary"
                                 Label="Neighbor emphasis on focus" />
                </MudStack>
            </MudExpansionPanel>

            <MudExpansionPanel Text="Canvas zoom"
                               Expanded="@IsExpanded(TopologyFeatureSection.CanvasZoom)"
                               ExpandedChanged="expanded => SetSectionExpanded(TopologyFeatureSection.CanvasZoom, expanded)">
                <MudStack Spacing="1" Class="topology-section-body">
                    <MudStack Row="true" AlignItems="@AlignItems.Center" Spacing="1">
                        <MudSlider T="double"
                                   Class="flex-grow-1"
                                   Value="@workingSettings.ZoomPercent"
                                   ValueChanged="OnZoomPercentChanged"
                                   Min="25"
                                   Max="200"
                                   Step="5"
                                   Immediate="true"
                                   Size="Size.Small"
                                   ValueLabel="false" />
                        <MudText Typo="Typo.caption">@workingSettings.ZoomPercent.ToString("0")%</MudText>
                    </MudStack>
                </MudStack>
            </MudExpansionPanel>

            <MudExpansionPanel Text="Focus metric thresholds"
                               Expanded="@IsExpanded(TopologyFeatureSection.FocusThresholds)"
                               ExpandedChanged="expanded => SetSectionExpanded(TopologyFeatureSection.FocusThresholds, expanded)">
                <MudStack Spacing="1" Class="topology-section-body">
                    <MudText Typo="Typo.caption">SLA warning threshold</MudText>
                    <MudStack Row="true" AlignItems="@AlignItems.Center" Spacing="1">
                        <MudSlider T="double"
                                   Class="flex-grow-1"
                                   Value="@workingSettings.SlaWarningThreshold"
                                   ValueChanged="OnSlaThresholdChanged"
                                   Min="0"
                                   Max="1"
                                   Step="0.01"
                                   Immediate="true"
                                   Size="Size.Small"
                                   ValueLabel="false" />
                        <MudText Typo="Typo.caption">@workingSettings.SlaWarningThreshold.ToString("0%", CultureInfo.InvariantCulture)</MudText>
                    </MudStack>
                    <MudText Typo="Typo.caption">Utilization warning threshold</MudText>
                    <MudStack Row="true" AlignItems="@AlignItems.Center" Spacing="1">
                        <MudSlider T="double"
                                   Class="flex-grow-1"
                                   Value="@workingSettings.UtilizationWarningThreshold"
                                   ValueChanged="OnUtilThresholdChanged"
                                   Min="0"
                                   Max="1"
                                   Step="0.01"
                                   Immediate="true"
                                   Size="Size.Small"
                                   ValueLabel="false" />
                        <MudText Typo="Typo.caption">@workingSettings.UtilizationWarningThreshold.ToString("0%", CultureInfo.InvariantCulture)</MudText>
                    </MudStack>
                    <MudText Typo="Typo.caption">Error alert threshold</MudText>
                    <MudStack Row="true" AlignItems="@AlignItems.Center" Spacing="1">
                        <MudSlider T="double"
                                   Class="flex-grow-1"
                                   Value="@workingSettings.ErrorRateAlertThreshold"
                                   ValueChanged="OnErrorThresholdChanged"
                                   Min="0"
                                   Max="0.5"
                                   Step="0.01"
                                   Immediate="true"
                                   Size="Size.Small"
                                   ValueLabel="false" />
                        <MudText Typo="Typo.caption">@workingSettings.ErrorRateAlertThreshold.ToString("0.0%", CultureInfo.InvariantCulture)</MudText>
                    </MudStack>
                </MudStack>
            </MudExpansionPanel>
        </MudExpansionPanels>

        <MudStack Spacing="1" Class="topology-footnote">
            <MudText Typo="Typo.caption">
                Edge shares, sparklines, and full DAG filtering follow these settings. “Auto” picks sensible defaults based on zoom level.
            </MudText>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       Size="Size.Small"
                       OnClick="ResetSettings">
                Reset to defaults
            </MudButton>
        </MudStack>
    </div>
</MudStack>

@code {
    [Parameter]
    public TopologyOverlaySettings Settings { get; set; } = TopologyOverlaySettings.Default;

    [Parameter]
    public EventCallback<TopologyOverlaySettings> SettingsChanged { get; set; }

    [Parameter]
    public EventCallback CloseRequested { get; set; }

    [Parameter]
    public IReadOnlyDictionary<TopologyFeatureSection, bool>? ExpandedSections { get; set; }

    [Parameter]
    public EventCallback<SectionExpansionChangedArgs> SectionExpansionChanged { get; set; }

    private static readonly IReadOnlyDictionary<string, object> featureBarCloseButtonAttributes =
        new Dictionary<string, object> { ["aria-label"] = "Close topology feature bar" };

    private TopologyOverlaySettings workingSettings = TopologyOverlaySettings.Default;
    private TopologyOverlaySettings? lastReceivedSettings;
    private IReadOnlyDictionary<TopologyFeatureSection, bool>? lastExpandedSections;
    private Dictionary<TopologyFeatureSection, bool> sectionExpansion = new();

    protected override void OnParametersSet()
    {
        if (!ReferenceEquals(lastReceivedSettings, Settings))
        {
            workingSettings = Settings.Clone();
            lastReceivedSettings = Settings;
        }

        if (!ReferenceEquals(lastExpandedSections, ExpandedSections))
        {
            sectionExpansion = ExpandedSections is null
                ? new Dictionary<TopologyFeatureSection, bool>()
                : new Dictionary<TopologyFeatureSection, bool>(ExpandedSections);
            lastExpandedSections = ExpandedSections;
        }
    }

    private Task Close() => CloseRequested.InvokeAsync();

    private bool IsExpanded(TopologyFeatureSection section)
        => sectionExpansion.TryGetValue(section, out var expanded) ? expanded : true;

    private async Task SetSectionExpanded(TopologyFeatureSection section, bool expanded)
    {
        if (IsExpanded(section) == expanded)
        {
            return;
        }

        sectionExpansion[section] = expanded;
        StateHasChanged();
        if (SectionExpansionChanged.HasDelegate)
        {
            await SectionExpansionChanged.InvokeAsync(new SectionExpansionChangedArgs(section, expanded));
        }
    }

    private Task OnShowLabelsChanged(bool value)
    {
        if (workingSettings.ShowLabels == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowLabels = value;
        return NotifyChange();
    }

    private Task OnShowEdgeArrowsChanged(bool value)
    {
        if (workingSettings.ShowEdgeArrows == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowEdgeArrows = value;
        return NotifyChange();
    }

    private Task OnShowEdgeSharesChanged(bool value)
    {
        if (workingSettings.ShowEdgeShares == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowEdgeShares = value;
        return NotifyChange();
    }

    private Task OnShowEdgeMultipliersChanged(bool value)
    {
        if (workingSettings.ShowEdgeMultipliers == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowEdgeMultipliers = value;
        return NotifyChange();
    }

    private Task OnShowSparklinesChanged(bool value)
    {
        if (workingSettings.ShowSparklines == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowSparklines = value;
        return NotifyChange();
    }

    private Task OnShowRetryMetricsChanged(bool value)
    {
        if (workingSettings.ShowRetryMetrics == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowRetryMetrics = value;
        return NotifyChange();
    }

    private Task OnSparklineModeChanged(SparklineRenderMode value)
    {
        if (workingSettings.SparklineMode == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.SparklineMode = value;
        return NotifyChange();
    }

    private Task OnEdgeStyleChanged(EdgeRenderMode value)
    {
        if (workingSettings.EdgeStyle == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.EdgeStyle = value;
        return NotifyChange();
    }

    private Task OnEnableFullDagChanged(bool value)
    {
        if (workingSettings.EnableFullDag == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.EnableFullDag = value;

        if (value && !workingSettings.IncludeExpressionNodes && !workingSettings.IncludeConstNodes)
        {
            workingSettings.IncludeExpressionNodes = true;
            workingSettings.IncludeConstNodes = true;
        }

        return NotifyChange();
    }

    private Task OnRespectUiPositionsChanged(bool value)
    {
        if (workingSettings.RespectUiPositions == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.RespectUiPositions = value;
        return NotifyChange();
    }

    private Task OnLayoutModeChanged(LayoutMode value)
    {
        if (workingSettings.Layout == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.Layout = value;
        return NotifyChange();
    }

    private Task OnIncludeServiceNodesChanged(bool value)
    {
        if (workingSettings.IncludeServiceNodes == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.IncludeServiceNodes = value;
        return NotifyChange();
    }

    private Task OnIncludeExpressionNodesChanged(bool value)
    {
        if (workingSettings.IncludeExpressionNodes == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.IncludeExpressionNodes = value;
        return NotifyChange();
    }

    private Task OnIncludeConstNodesChanged(bool value)
    {
        if (workingSettings.IncludeConstNodes == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.IncludeConstNodes = value;
        return NotifyChange();
    }

    private Task OnNeighborEmphasisChanged(bool value)
    {
        if (workingSettings.NeighborEmphasis == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.NeighborEmphasis = value;
        return NotifyChange();
    }

    private Task OnZoomPercentChanged(double value)
    {
        var clamped = Math.Clamp(value, 25d, 200d);
        if (Math.Abs(workingSettings.ZoomPercent - clamped) < 0.01d)
        {
            return Task.CompletedTask;
        }

        workingSettings.ZoomPercent = clamped;
        return NotifyChange();
    }

    private Task OnSlaThresholdChanged(double value)
    {
        var clamped = Math.Clamp(value, 0d, 1d);
        if (Math.Abs(workingSettings.SlaWarningThreshold - clamped) < 0.001d)
        {
            return Task.CompletedTask;
        }

        workingSettings.SlaWarningThreshold = clamped;
        return NotifyChange();
    }

    private Task OnUtilThresholdChanged(double value)
    {
        var clamped = Math.Clamp(value, 0d, 1d);
        if (Math.Abs(workingSettings.UtilizationWarningThreshold - clamped) < 0.001d)
        {
            return Task.CompletedTask;
        }

        workingSettings.UtilizationWarningThreshold = clamped;
        return NotifyChange();
    }

    private Task OnErrorThresholdChanged(double value)
    {
        var clamped = Math.Clamp(value, 0d, 0.5d);
        if (Math.Abs(workingSettings.ErrorRateAlertThreshold - clamped) < 0.001d)
        {
            return Task.CompletedTask;
        }

        workingSettings.ErrorRateAlertThreshold = clamped;
        return NotifyChange();
    }

    private Task OnShowArrivalsDependenciesChanged(bool value)
    {
        if (workingSettings.ShowArrivalsDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowArrivalsDependencies = value;
        return NotifyChange();
    }

    private Task OnShowServedDependenciesChanged(bool value)
    {
        if (workingSettings.ShowServedDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowServedDependencies = value;
        return NotifyChange();
    }

    private Task OnShowErrorsDependenciesChanged(bool value)
    {
        if (workingSettings.ShowErrorsDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowErrorsDependencies = value;
        return NotifyChange();
    }

    private Task OnShowQueueDependenciesChanged(bool value)
    {
        if (workingSettings.ShowQueueDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowQueueDependencies = value;
        return NotifyChange();
    }

    private Task OnShowCapacityDependenciesChanged(bool value)
    {
        if (workingSettings.ShowCapacityDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowCapacityDependencies = value;
        return NotifyChange();
    }

    private Task OnShowExpressionDependenciesChanged(bool value)
    {
        if (workingSettings.ShowExpressionDependencies == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowExpressionDependencies = value;
        return NotifyChange();
    }

    private Task OnShowInspectorOverviewChanged(bool value)
    {
        if (workingSettings.ShowInspectorOverview == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.ShowInspectorOverview = value;
        return NotifyChange();
    }

    private Task OnHorizonBandsChanged(int value)
    {
        var clamped = Math.Clamp(value, 1, 6);
        if (workingSettings.HorizonBands == clamped)
        {
            return Task.CompletedTask;
        }

        workingSettings.HorizonBands = clamped;
        return NotifyChange();
    }

    private Task OnNormalizeHorizonChanged(bool value)
    {
        if (workingSettings.NormalizeInspectorHorizonCounts == value)
        {
            return Task.CompletedTask;
        }

        workingSettings.NormalizeInspectorHorizonCounts = value;
        return NotifyChange();
    }

    private Task OnInspectorHorizonGlobalCapChanged(double? value)
    {
        if (Nullable.Equals(workingSettings.InspectorHorizonGlobalCap, value))
        {
            return Task.CompletedTask;
        }

        if (value.HasValue && value.Value < 0) value = 0;
        workingSettings.InspectorHorizonGlobalCap = value;
        return NotifyChange();
    }

    private Task ResetSettings()
    {
        workingSettings = TopologyOverlaySettings.Default.Clone();
        return NotifyChange();
    }

    private async Task NotifyChange()
    {
        await SettingsChanged.InvokeAsync(workingSettings.Clone());
        StateHasChanged();
    }
}
