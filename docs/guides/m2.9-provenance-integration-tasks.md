# M2.9 Provenance Integration - Task Tracking

**Date Created:** October 3, 2025  
**Milestone:** Engine M2.9 + Sim M2.7 Integration  
**Status:** ðŸŸ¡ In Progress

---

## Decision Summary

Based on deep analysis of Engine implementation vs Sim spec:

1. **Field Naming:** Engine will use **camelCase** (modelId, templateId, etc.)
2. **Transport:** Support **both** full JSON in header AND embedded YAML
3. **Template Title:** Engine will **add** templateTitle field
4. **Response Format:** Spec will document **actual** Engine response fields
5. **Query Endpoints:** Phase to **M2.10** (not blocking M2.9)

---

## Phase 1: Critical for M2.9 Integration âœ…

### Sim Tasks (flowtime-sim-vnext)

- [ ] **Task 1:** Update spec field naming consistency
  - File: `docs/guides/engine-m2.9-provenance-spec.md`
  - Action: Verify all examples use camelCase (already correct)
  - Owner: Sim team
  - Est: 15 min

- [ ] **Task 2:** Update header format documentation
  - File: `docs/guides/engine-m2.9-provenance-spec.md`
  - Action: Clarify header contains full JSON object, document both approaches
  - Owner: Sim team
  - Est: 30 min

- [ ] **Task 3:** Document actual Engine response format
  - File: `docs/guides/engine-m2.9-provenance-spec.md`
  - Action: Update response examples with all fields (grid, order, series, etc.)
  - Owner: Sim team
  - Est: 20 min

- [ ] **Task 4:** Mark query endpoints as M2.10
  - File: `docs/guides/engine-m2.9-provenance-spec.md`
  - Action: Add milestone markers, clarify what's M2.9 vs M2.10
  - Owner: Sim team
  - Est: 15 min

- [ ] **Task 5:** Verify Sim output matches spec
  - Files: Check ProvenanceMetadata serialization
  - Action: Validation only, confirm camelCase output
  - Owner: Sim team
  - Est: 10 min

### Engine Tasks (flowtime-vnext)

- [ ] **Task 1:** Change ProvenanceMetadata to camelCase
  - File: `src/FlowTime.API/Models/ProvenanceMetadata.cs`
  - Action: Update all JsonPropertyName attributes
  - Owner: Engine team
  - Est: 15 min

- [ ] **Task 2:** Add templateTitle field to ProvenanceMetadata
  - File: `src/FlowTime.API/Models/ProvenanceMetadata.cs`
  - Action: Add new property with JsonPropertyName attribute
  - Owner: Engine team
  - Est: 5 min

- [ ] **Task 3:** Update ProvenanceService to parse JSON from header
  - File: `src/FlowTime.API/Services/ProvenanceService.cs`
  - Action: Deserialize full JSON object from header, keep embedded support
  - Owner: Engine team
  - Est: 45 min

- [ ] **Task 4:** Update all provenance tests
  - Files: `tests/FlowTime.Api.Tests/Provenance/*.cs`
  - Action: Update for camelCase, JSON header, templateTitle
  - Owner: Engine team
  - Est: 60 min

---

## Phase 2: Final M2.9 Completion ðŸ“‹

### Engine Tasks

- [ ] **Task 5:** Update Engine documentation
  - File: `docs/architecture/run-provenance.md`
  - Action: Update field names, header format, templateTitle
  - Owner: Engine team
  - Est: 30 min

---

## Phase 3: M2.10 Enhancement ðŸ”®

### Engine Tasks (Future)

- [ ] **Task 6:** Add provenance query parameters
  - Files: Multiple (IArtifactRegistry, ArtifactQueryOptions, registry index)
  - Action: Add source, templateId, modelId query support
  - Owner: Engine team
  - Est: 2-3 hours

- [ ] **Task 7:** Add dedicated provenance endpoint
  - File: `src/FlowTime.API/Program.cs`
  - Action: Add GET /v1/artifacts/{runId}/provenance endpoint
  - Owner: Engine team
  - Est: 1 hour

---

## Integration Testing Plan

### After Phase 1 Completion

1. **Unit Tests:** All provenance tests passing in both repos
2. **Integration Test:** Sim generates model â†’ Engine accepts via header
3. **Integration Test:** Sim generates model â†’ Engine accepts via embedded YAML
4. **Integration Test:** Verify provenance.json stored correctly
5. **Integration Test:** Verify manifest.json includes provenance reference
6. **Validation:** Confirm camelCase fields in all stored JSON

### Test Scenarios

```bash
# Scenario 1: Header with full JSON
curl -X POST http://localhost:8090/api/v1/templates/transportation-basic/generate \
  -H "Content-Type: application/json" \
  -d '{"bins": 12}' | \
  jq -r '.model' | \
  curl -X POST http://localhost:8080/v1/run \
    -H "Content-Type: application/x-yaml" \
    -H "X-Model-Provenance: $(curl ... | jq -c '.provenance')" \
    --data-binary @-

# Scenario 2: Embedded provenance
curl -X POST http://localhost:8090/api/v1/templates/transportation-basic/generate?embed_provenance=true \
  -H "Content-Type: application/json" \
  -d '{"bins": 12}' | \
  jq -r '.model' | \
  curl -X POST http://localhost:8080/v1/run \
    -H "Content-Type: application/x-yaml" \
    --data-binary @-
```

---

## Problems Identified & Solutions

### Problem 1: Field Naming Convention âœ… RESOLVED
- **Issue:** Sim sends camelCase, Engine expected snake_case
- **Solution:** Engine adopts camelCase (modern JSON standard)

### Problem 2: HTTP Header Format âœ… RESOLVED
- **Issue:** Spec showed JSON, Engine treated as string
- **Solution:** Engine parses full JSON, also supports embedded YAML

### Problem 3: Missing templateTitle âœ… RESOLVED
- **Issue:** Engine model didn't have templateTitle field
- **Solution:** Add to Engine ProvenanceMetadata model

### Problem 4: Response Format âœ… RESOLVED
- **Issue:** Spec showed minimal response, Engine returns more fields
- **Solution:** Update spec to document actual response (non-breaking)

### Problem 5: Query Endpoints âœ… DEFERRED
- **Issue:** Spec described queries that don't exist in Engine
- **Solution:** Phase to M2.10, mark clearly in spec

---

## Timeline Estimate

- **Phase 1 (Sim Docs):** ~1.5 hours
- **Phase 1 (Engine Code + Tests):** ~2 hours
- **Phase 2 (Engine Docs):** ~0.5 hours
- **Phase 3 (M2.10):** ~3-4 hours (future milestone)

**Total M2.9 Integration:** ~4 hours

---

## Success Criteria

### M2.9 Complete When:
- âœ… Engine accepts provenance via JSON header
- âœ… Engine accepts provenance via embedded YAML
- âœ… All provenance fields use camelCase
- âœ… templateTitle stored and retrieved
- âœ… provenance.json created in run artifacts
- âœ… All tests passing (Engine + Sim)
- âœ… Documentation accurate on both sides
- âœ… Integration test: Sim â†’ Engine â†’ Storage working end-to-end

### M2.10 Complete When:
- âœ… Query by source, templateId, modelId works
- âœ… GET /v1/artifacts/{runId}/provenance endpoint exists
- âœ… Registry index includes provenance metadata
- âœ… Query tests passing

---

## Notes

- Sim code requires **no changes** - only documentation updates
- Engine requires modest changes - all localized to provenance feature
- No breaking changes to existing APIs
- Backward compatible: provenance is optional
- Both repos maintain their existing test suites with updates
