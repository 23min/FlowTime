# M-02.10 ‚Äî Provenance Query Support

**Status:** ‚úÖ Complete  
**Dependencies:** ‚úÖ M-02.09 (Schema Evolution & Provenance)  
**Target:** Enable efficient querying of artifacts by provenance metadata

---

## Goal

Enable users and tools to efficiently query run artifacts by provenance metadata (templateId, modelId) through both API and CLI interfaces. This enables workflows like "show all runs from template X" and "find runs with specific model for comparison."

---

## Context

**What M-02.09 Delivered:**
- ‚úÖ Provenance storage (`provenance.json` in each run directory)
- ‚úÖ Provenance indexing (summary extracted into `registry-index.json`)
- ‚úÖ Provenance fields available via generic `fullTextSearch`

**Gap M-02.10 Addresses:**
- ‚ùå No dedicated provenance query parameters (must use generic search)
- ‚ùå No type-safe filtering (generic search matches anywhere in metadata)
- ‚ùå No CLI support for provenance queries

**Use Cases Enabled:**
1. "Show me all runs from the `transportation-basic` template"
2. "Find runs that used model `model_20251003T175743Z_3218a4e6`"

---

## Scope

### In Scope ‚úÖ

1. **API Provenance Query Parameters**
   - Add `templateId` and `modelId` filters to `/v1/artifacts` endpoint

2. **CLI Provenance Query Flags**
   - Add `--template-id <id>` flag to `flowtime artifacts list`
   - Add `--model-id <id>` flag to `flowtime artifacts list`

3. **Test-Driven Development**
   - Write comprehensive tests before implementation
   - Cover positive, negative, and edge cases

### Out of Scope ‚ùå

- ‚ùå Comparison workflows
- ‚ùå Advanced provenance analytics
- ‚ùå Provenance visualization in UI

---

## Requirements

### Functional Requirements

#### FR1: API Provenance Query Parameters

**Endpoint:** `GET /v1/artifacts`

**New Query Parameters:**
- `templateId` - Filter by template ID (exact match)
- `modelId` - Filter by model ID (exact match)

**Behavior:**
- Parameters are optional and can be combined with existing filters
- Empty results return `{ "artifacts": [], "total": 0, "count": 0 }`
- Parameters are case-sensitive (match exact values)
- Works with pagination (`skip`, `limit`)
- Works with sorting (`sortBy`, `sortOrder`)

**Examples:**

```bash
# Find all runs from a specific template
curl "http://localhost:8080/v1/artifacts?templateId=transportation-basic"

# Find runs with specific model ID
curl "http://localhost:8080/v1/artifacts?modelId=model_20251003T175743Z_3218a4e6"

# Combine with other filters
curl "http://localhost:8080/v1/artifacts?templateId=transportation-basic&sortBy=created&sortOrder=desc"

# Pagination support
curl "http://localhost:8080/v1/artifacts?templateId=transportation-basic&limit=10&skip=0"
```

**Response Format:**
```json
{
  "artifacts": [
    {
      "id": "run_20251003T175743Z_64ec2d02",
      "type": "run",
      "title": "Model with passenger_demand, vehicle_capacity, passengers_served",
      "created": "2025-10-03T17:57:43Z",
      "metadata": {
        "provenance": {
          "hasProvenance": true,
          "modelId": "model_20251003T175743Z_3218a4e6",
          "templateId": "transportation-basic"
        }
      }
    }
  ],
  "total": 1,
  "count": 1
}
```

**Retrieving Provenance Details:**

Use existing files endpoint to get full provenance data:

```bash
# Get provenance.json for a run
curl "http://localhost:8080/v1/artifacts/run_20251003T175743Z_64ec2d02/files/provenance.json"

# Response:
{
  "source": "flowtime-sim",
  "modelId": "model_20251003T175743Z_3218a4e6",
  "templateId": "transportation-basic",
  "templateVersion": "1.0",
  "templateTitle": "Transportation Network",
  "generatedAt": "2025-10-03T17:57:43.457Z",
  "receivedAt": "2025-10-03T17:57:43.5263364Z",
  "generator": "flowtime-sim/0.5.0",
  "parameters": {
    "bins": 6
  }
}
```

#### FR2: CLI Provenance Query Flags

**Command:** `flowtime artifacts list`

**New Options:**
- `--template-id <id>` - Filter by template ID
- `--model-id <id>` - Filter by model ID

**Examples:**

```bash
# List runs from specific template
flowtime artifacts list --template-id transportation-basic

# List runs with specific model
flowtime artifacts list --model-id model_20251003T175743Z_3218a4e6

# Combine with existing filters
flowtime artifacts list --template-id transportation-basic --type run --limit 5
```

**Output Format:**
```
ID                                  Type  Created              Title
run_20251003T175743Z_64ec2d02       run   2025-10-03 17:57:43  Model with passenger_demand, vehicle_capacity
run_20251003T175743Z_88b531f3       run   2025-10-03 17:57:43  Model with passenger_demand, vehicle_capacity

Total: 2 artifacts
```

### Non-Functional Requirements

#### NFR1: Backward Compatibility
- All new parameters are optional
- Existing queries continue to work unchanged
- Artifacts without provenance are handled gracefully (excluded from results)

#### NFR2: Test Coverage
- Unit tests: 100% coverage of new query logic
- Integration tests: API endpoint tests with real registry
- CLI tests: Command parsing and output formatting

---

## Test-Driven Development Plan

### Phase 0: Write Failing Tests (RED State)

#### API Tests

**File:** `tests/FlowTime.API.Tests/Provenance/ProvenanceQueryTests.cs`

Test scenarios:
1. ‚úÖ Query by templateId returns matching artifacts
2. ‚úÖ Query by modelId returns exact match
3. ‚úÖ Combined filters work correctly (templateId + modelId)
4. ‚úÖ Empty results when no matches found
5. ‚úÖ Case-sensitive matching behavior
6. ‚úÖ Pagination works with provenance filters
7. ‚úÖ Sorting works with provenance filters
8. ‚úÖ Artifacts without provenance excluded from results

#### CLI Tests

**File:** `tests/FlowTime.CLI.Tests/Commands/ProvenanceQueryTests.cs`

Test scenarios:
1. ‚úÖ `artifacts list --template-id` filters correctly
2. ‚úÖ `artifacts list --model-id` filters correctly
3. ‚úÖ Combined filters work in CLI
4. ‚úÖ Output formatting is correct

#### Core Tests

**File:** `tests/FlowTime.Tests/Registry/ProvenanceFilterTests.cs`

Test scenarios:
1. ‚úÖ Registry correctly extracts provenance from manifest.json
2. ‚úÖ Provenance fields indexed properly in registry-index.json
3. ‚úÖ Filter logic correctly matches provenance fields
4. ‚úÖ Null/missing provenance handled gracefully

### Phase 1: Implement Features (GREEN State)

Implementation order:
1. Update `ArtifactQueryOptions` with new parameters (`templateId`, `modelId`)
2. Update `FileSystemArtifactRegistry.GetArtifactsAsync()` with filter logic
3. Update CLI `artifacts list` command with new flags
4. Run tests and verify all pass

### Phase 2: Refactor & Optimize (REFACTOR)

1. Clean up duplicate code
2. Add inline documentation

### Phase 3: Documentation & Examples

1. Update API documentation with new parameters
2. Update CLI help text
3. Add usage examples to README
4. Update integration guide for UI developers

---

## Implementation Notes

### Current Registry Structure

The provenance data is already indexed in `registry-index.json`:

```json
"metadata": {
  "provenance": {
    "hasProvenance": true,
    "modelId": "model_20251003T175743Z_3218a4e6",
    "templateId": "transportation-basic"
  }
}
```

This means the data is available for filtering without re-scanning directories.

### Filter Logic Approach

Query filters should:
1. Parse provenance JSON from metadata field
2. Match against requested filter values
3. Handle missing/malformed provenance gracefully (exclude from results)

### Error Handling

- Missing provenance: Exclude from results (not an error)
- Malformed provenance: Log warning, exclude from results
- Invalid filter values: Return empty results (not 400 error)

---

## Success Criteria

### Definition of Done

- [ ] All tests written and initially failing (RED state)
- [ ] API query parameters implemented and tests pass
- [ ] CLI flags implemented and tests pass
- [ ] Documentation updated (API, CLI help, examples)
- [ ] Integration tests pass with real registry data
- [ ] Backward compatibility verified (existing queries work)
- [ ] Code reviewed and merged

### Validation

**Manual Testing:**
```bash
# 1. Generate runs with provenance (via Sim)
# 2. Query by template
curl "http://localhost:8080/v1/artifacts?templateId=transportation-basic"

# 3. Query by model
curl "http://localhost:8080/v1/artifacts?modelId=model_20251003T175743Z_3218a4e6"

# 4. CLI validation
flowtime artifacts list --template-id transportation-basic
flowtime artifacts list --model-id model_20251003T175743Z_3218a4e6

# 5. Get provenance details
curl "http://localhost:8080/v1/artifacts/run_xyz/files/provenance.json"
```

---

## Dependencies

### Prerequisites
- ‚úÖ M-02.09 complete (provenance storage and indexing)
- ‚úÖ Registry index contains provenance metadata
- ‚úÖ Provenance.json files exist in run directories

### Related Work
- **FlowTime-Sim**: Already generates provenance metadata (SIM-M-02.07)
- **FlowTime UI**: Will consume these APIs for compare workflows (future)

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Breaking existing queries | High | Low | All new parameters optional, comprehensive tests |
| Provenance data inconsistencies | Medium | Medium | Graceful handling of missing/malformed data |

---

## Timeline

**Total Estimated Effort:** 1-2 hours

- **Phase 0 (Tests):** 30 minutes
- **Phase 1 (Implementation):** 30-60 minutes
- **Phase 2 (Refactor):** 15 minutes
- **Phase 3 (Documentation):** 15 minutes

---

**Milestone Status:** üìã Ready for implementation  
**Next Action:** Write failing tests (Phase 0)

## Test Strategy

**Approach:** Strict TDD (RED ‚Üí GREEN ‚Üí REFACTOR) on branch `feature/api-m2.10/provenance-queries`. All tests operate on real temp directories and the concrete registry implementation‚Äîno mocks.

### Phase 0: Tests First
- Add core filter coverage in `tests/FlowTime.Tests/Registry/ProvenanceFilterTests.cs`.
- Add API query coverage in `tests/FlowTime.Api.Tests/Provenance/ProvenanceQueryTests.cs`.
- Add CLI flag coverage in `tests/FlowTime.Cli.Tests/Commands/ProvenanceQueryTests.cs`.
- Tests should initially fail, verifying data isolation via `TestWebApplicationFactory` temp directories.

### Phase 1: Implementation Sequence
1. Extend `ArtifactQueryOptions` and `FileSystemArtifactRegistry` filtering.
2. Wire `/v1/artifacts` to accept `templateId`/`modelId` query parameters.
3. Add `--template-id` / `--model-id` options to `flowtime artifacts list`.
4. Run targeted suites after each layer (`dotnet test --filter "FullyQualifiedName~ProvenanceQuery"`).

### Phase 2: Refactor & Hardening
- Remove duplication, add XML docs, keep code coverage >95% for new logic.
- Validate deterministic behavior with multiple provenance combinations (exact match, missing metadata, combined filters).
- Ensure empty results respond with `artifacts: []` and correct pagination metadata.

### Test Data Notes
- Provenance JSON includes `source`, `templateId`, `modelId`, timestamps, and `parameters`.
- Registry index exposes provenance metadata under `metadata.provenance`.
- Use helper methods to create runs with provenance payloads and verify results through API/CLI.

### Success Criteria
- All new tests pass and cover positive/negative cases.
- API + CLI queries filter correctly without impacting existing search parameters.
- No regression in artifact listing performance; CLI help text updated with new flags.
