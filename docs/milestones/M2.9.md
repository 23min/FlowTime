# M2.9 Phase 0: TDD Setup - Test Plan

**Branch**: `feature/core-m2.9/tdd-setup`  
**Goal**: Establish comprehensive test coverage BEFORE implementing breaking changes  
**Strategy**: Red â†’ Green â†’ Refactor (TDD)

---

## Phase 0 Objectives

1. **Isolate Legacy Tests** - Move existing tests to `.Legacy` namespaces
2. **New Test Architecture** - Establish clean structure for target schema
3. **Write Failing Tests** - Define success criteria through tests
4. **Validate Approach** - Ensure tests fail appropriately before implementation

---

## Test Isolation Strategy

### Legacy Test Namespaces

Move existing tests that validate current `binMinutes` format:

```
FlowTime.Tests/                    â†’ FlowTime.Tests.Legacy/
â”œâ”€â”€ ValidationTests.cs             â†’ ValidationTests.cs (binMinutes validation)
â”œâ”€â”€ GraphTests.cs                  â†’ GraphTests.cs (current parser)
â”œâ”€â”€ ApiIntegrationTests.cs         â†’ ApiIntegrationTests.cs (current API)
â””â”€â”€ ... (other current-format tests)

FlowTime.Api.Tests/                â†’ FlowTime.Api.Tests.Legacy/
â”œâ”€â”€ ApiIntegrationTests.cs         â†’ ApiIntegrationTests.cs (current endpoints)
â”œâ”€â”€ ParityTests.cs                 â†’ ParityTests.cs (current parity)
â””â”€â”€ ... (other API tests)
```

### Tests to Keep (Already Target-Compatible)

These tests don't depend on `binMinutes` format:
- âœ… `Expressions/ExpressionParserTests.cs` - Expression evaluation (format-agnostic)
- âœ… `Expressions/ExpressionIntegrationTests.cs` - Expression integration
- âœ… `BinaryOpTests.cs` - Binary operations (format-agnostic)
- âœ… `DeterminismTests.cs` - Determinism validation
- âœ… `Nodes/ShiftNodeTests.cs` - SHIFT node behavior
- âœ… `Pmf/PmfNodeTests.cs` - PMF node tests (already exist!)
- âœ… `Pmf/PmfTests.cs` - PMF tests

### Tests to Create (Target Schema)

New tests for target-model-schema format:
- ğŸ†• `TimeGrid/TimeGridValidationTests.cs` - binSize/binUnit validation
- ğŸ†• `TimeGrid/TimeUnitConversionTests.cs` - Unit conversion logic
- ğŸ†• `Schema/SchemaVersionTests.cs` - schemaVersion validation
- ğŸ†• `Schema/TargetSchemaValidationTests.cs` - Complete schema validation
- ğŸ†• `Pmf/PmfCompilationPipelineTests.cs` - 4-phase compilation
- ğŸ†• `Pmf/PmfGridAlignmentTests.cs` - Repeat/error policies
- ğŸ†• `Pmf/PmfProvenanceTests.cs` - PMF provenance tracking
- ğŸ†• `Rng/Pcg32Tests.cs` - PCG32 algorithm tests
- ğŸ†• `Rng/RngDeterminismTests.cs` - RNG determinism validation
- ğŸ†• `Provenance/ProvenanceStorageTests.cs` - provenance.json creation
- ğŸ†• `Provenance/ProvenanceHeaderTests.cs` - X-Model-Provenance header
- ğŸ†• `Provenance/ProvenanceEmbeddedTests.cs` - Embedded YAML provenance
- ğŸ†• `Provenance/ProvenanceQueryTests.cs` - Query by model_id/template_id

---

## New Test Structure

```
FlowTime.Tests/
â”œâ”€â”€ Legacy/                        # OLD: Tests for binMinutes format
â”‚   â”œâ”€â”€ ValidationTests.cs
â”‚   â”œâ”€â”€ GraphTests.cs
â”‚   â””â”€â”€ ApiIntegrationTests.cs
â”‚
â”œâ”€â”€ TimeGrid/                      # NEW: Target schema time grid tests
â”‚   â”œâ”€â”€ TimeGridValidationTests.cs
â”‚   â”œâ”€â”€ TimeUnitConversionTests.cs
â”‚   â””â”€â”€ TimeGridParsingTests.cs
â”‚
â”œâ”€â”€ Schema/                        # NEW: Schema validation tests
â”‚   â”œâ”€â”€ SchemaVersionTests.cs
â”‚   â”œâ”€â”€ TargetSchemaValidationTests.cs
â”‚   â””â”€â”€ SchemaErrorHandlingTests.cs
â”‚
â”œâ”€â”€ Pmf/                          # NEW: Enhanced PMF tests
â”‚   â”œâ”€â”€ PmfCompilationPipelineTests.cs
â”‚   â”œâ”€â”€ PmfGridAlignmentTests.cs
â”‚   â”œâ”€â”€ PmfProvenanceTests.cs
â”‚   â””â”€â”€ PmfValidationTests.cs
â”‚
â”œâ”€â”€ Rng/                          # NEW: RNG tests
â”‚   â”œâ”€â”€ Pcg32Tests.cs
â”‚   â”œâ”€â”€ RngDeterminismTests.cs
â”‚   â””â”€â”€ RngIntegrationTests.cs
â”‚
â”œâ”€â”€ Provenance/                   # NEW: Provenance tests
â”‚   â”œâ”€â”€ ProvenanceStorageTests.cs
â”‚   â”œâ”€â”€ ProvenanceHeaderTests.cs
â”‚   â”œâ”€â”€ ProvenanceEmbeddedTests.cs
â”‚   â””â”€â”€ ProvenanceQueryTests.cs
â”‚
â”œâ”€â”€ Expressions/                  # KEEP: Format-agnostic
â”‚   â”œâ”€â”€ ExpressionParserTests.cs
â”‚   â””â”€â”€ ExpressionIntegrationTests.cs
â”‚
â””â”€â”€ Nodes/                        # KEEP: Node behavior tests
    â””â”€â”€ ShiftNodeTests.cs

FlowTime.Api.Tests/
â”œâ”€â”€ Legacy/                       # OLD: Current API tests
â”‚   â”œâ”€â”€ ApiIntegrationTests.cs
â”‚   â””â”€â”€ ParityTests.cs
â”‚
â”œâ”€â”€ Provenance/                   # NEW: Provenance endpoint tests
â”‚   â”œâ”€â”€ ProvenanceEndpointTests.cs
â”‚   â”œâ”€â”€ ProvenanceQueryTests.cs
â”‚   â””â”€â”€ ProvenanceIntegrationTests.cs
â”‚
â””â”€â”€ Schema/                       # NEW: API schema tests
    â”œâ”€â”€ TargetSchemaAcceptanceTests.cs
    â””â”€â”€ SchemaValidationErrorTests.cs

FlowTime.Cli.Tests/
â”œâ”€â”€ Legacy/                       # OLD: Current CLI tests
â”‚   â””â”€â”€ OutputDirectoryConfigurationTests.cs
â”‚
â””â”€â”€ Schema/                       # NEW: CLI schema tests
    â”œâ”€â”€ TargetSchemaProcessingTests.cs
    â””â”€â”€ CliValidationTests.cs
```

---

## Test Implementation Order

### Step 1: Legacy Isolation (First commit)
```bash
test(core): Isolate legacy tests to .Legacy namespace

- Move binMinutes-dependent tests to FlowTime.Tests.Legacy
- Move current API tests to FlowTime.Api.Tests.Legacy
- Update namespaces and project structure
- Ensure all legacy tests still pass
```

### Step 2: TimeGrid Tests (Failing - RED)
```bash
test(core): Add failing tests for TimeGrid evolution

- TimeGridValidationTests.cs (binSize/binUnit validation)
- TimeUnitConversionTests.cs (minutes/hours/days/weeks)
- TimeGridParsingTests.cs (YAML parsing)

Status: RED (TimeUnit enum doesn't exist yet)
```

### Step 3: Schema Version Tests (Failing - RED)
```bash
test(core): Add failing tests for schemaVersion validation

- SchemaVersionTests.cs (require schemaVersion: 1)
- TargetSchemaValidationTests.cs (complete validation)
- SchemaErrorHandlingTests.cs (error messages)

Status: RED (schemaVersion not enforced yet)
```

### Step 4: PMF Compilation Tests (Failing - RED)
```bash
test(core): Add failing tests for PMF compilation pipeline

- PmfCompilationPipelineTests.cs (4-phase compilation)
- PmfGridAlignmentTests.cs (repeat/error policies)
- PmfProvenanceTests.cs (provenance tracking)

Status: RED (PMF compilation not implemented)
```

### Step 5: RNG Tests (Failing - RED)
```bash
test(core): Add failing tests for PCG32 RNG

- Pcg32Tests.cs (algorithm correctness)
- RngDeterminismTests.cs (same seed â†’ same output)
- RngIntegrationTests.cs (PMF integration)

Status: RED (PCG32 doesn't exist yet)
```

### Step 6: Provenance Tests (Failing - RED)
```bash
test(api): Add failing tests for provenance support

- ProvenanceStorageTests.cs (provenance.json creation)
- ProvenanceHeaderTests.cs (X-Model-Provenance)
- ProvenanceEmbeddedTests.cs (embedded YAML)
- ProvenanceQueryTests.cs (query filters)

Status: RED (provenance support not implemented)
```

### Step 7: Documentation
```bash
docs(test): Document Phase 0 test coverage

- This test plan document
- Coverage report showing failing tests
- Next steps for Phase 2 implementation
```

---

## Success Criteria for Phase 0

**Definition of Done:**
- [ ] All legacy tests isolated and passing
- [ ] New test structure established
- [ ] Failing tests written for:
  - [ ] TimeGrid evolution (binSize/binUnit)
  - [ ] Schema versioning (schemaVersion: 1)
  - [ ] PMF compilation pipeline
  - [ ] RNG integration (PCG32)
  - [ ] Provenance support
- [ ] Test coverage plan documented
- [ ] All tests compile (but many fail as expected)
- [ ] Solution still builds successfully
- [ ] Clear RED state (failing tests define work to do)

**Exit Criteria:**
âœ… Phase 0 complete when all tests compile, legacy tests pass, new tests fail predictably

â¡ï¸ Ready for Phase 2 implementation (make failing tests pass)

---

## Test Example Templates

### TimeGrid Validation Test (Failing - RED)
```csharp
namespace FlowTime.Tests.TimeGrid;

[TestFixture]
public class TimeGridValidationTests
{
    [Test]
    public void Validate_BinSizeAndBinUnit_Required()
    {
        // Arrange
        var yaml = @"
schemaVersion: 1
grid:
  bins: 24
  # Missing binSize and binUnit
nodes:
  - id: test
    kind: const
    values: [1, 2, 3]
";

        // Act & Assert
        var ex = Assert.Throws<ValidationException>(() => 
            ModelParser.Parse(yaml));
        
        Assert.That(ex.Message, Does.Contain("binSize"));
        Assert.That(ex.Message, Does.Contain("binUnit"));
    }
    
    [TestCase("minutes", 1, 1)]
    [TestCase("hours", 1, 60)]
    [TestCase("days", 1, 1440)]
    [TestCase("weeks", 1, 10080)]
    public void TimeUnit_ToMinutes_ConvertsCorrectly(string unit, int size, int expected)
    {
        // Act
        var minutes = TimeUnit.Parse(unit).ToMinutes(size);
        
        // Assert
        Assert.That(minutes, Is.EqualTo(expected));
    }
}
```

### PMF Compilation Test (Failing - RED)
```csharp
namespace FlowTime.Tests.Pmf;

[TestFixture]
public class PmfCompilationPipelineTests
{
    [Test]
    public void Compile_ValidPmf_ProducesConstSeries()
    {
        // Arrange
        var pmf = new PmfNode
        {
            Id = "test",
            Values = new[] { 1.0, 2.0, 3.0 },
            Probabilities = new[] { 0.5, 0.3, 0.2 }
        };
        var grid = new TimeGrid { Bins = 10 };
        var rng = new Pcg32(seed: 12345);
        
        // Act
        var compiled = PmfCompiler.Compile(pmf, grid, rng);
        
        // Assert
        Assert.That(compiled.Kind, Is.EqualTo(NodeKind.Const));
        Assert.That(compiled.Values.Length, Is.EqualTo(10));
        Assert.That(compiled.Values, Has.All.GreaterThanOrEqualTo(1.0));
        Assert.That(compiled.Values, Has.All.LessThanOrEqualTo(3.0));
    }
}
```

### Provenance Storage Test (Failing - RED)
```csharp
namespace FlowTime.Api.Tests.Provenance;

[TestFixture]
public class ProvenanceStorageTests
{
    [Test]
    public async Task Run_WithProvenanceHeader_CreatesProvenanceJson()
    {
        // Arrange
        var request = new HttpRequestMessage(HttpMethod.Post, "/v1/run");
        request.Headers.Add("X-Model-Provenance", "model_test123");
        request.Content = new StringContent(ValidModelYaml, 
            Encoding.UTF8, "application/x-yaml");
        
        // Act
        var response = await _client.SendAsync(request);
        var result = await response.Content
            .ReadFromJsonAsync<RunResponse>();
        
        // Assert
        var provenancePath = Path.Combine(
            _dataDir, result.RunId, "provenance.json");
        Assert.That(File.Exists(provenancePath), Is.True);
        
        var provenance = JsonSerializer.Deserialize<ProvenanceMetadata>(
            await File.ReadAllTextAsync(provenancePath));
        Assert.That(provenance.ModelId, Is.EqualTo("model_test123"));
    }
}
```

---

## Phase 0 Implementation Order

**Complexity**: Medium  
**Risk**: Low (just tests, no breaking changes yet)

**Step 1**: Legacy isolation  
**Steps 2-3**: TimeGrid + Schema tests  
**Steps 4-6**: PMF + RNG + Provenance tests  
**Step 7**: Documentation

---

**Next**: Phase 2 implementation (make tests pass one component at a time)
