# M2.9 Phase 0: TDD Setup - Test Plan

**Branch**: `feature/core-m2.9/tdd-setup`  
**Goal**: Establish comprehensive test coverage BEFORE implementing breaking changes  
**Strategy**: Red → Green → Refactor (TDD)

---

## Phase 0 Objectives

1. **Isolate Legacy Tests** - Move existing tests to `.Legacy` namespaces
2. **New Test Architecture** - Establish clean structure for target schema
3. **Write Failing Tests** - Define success criteria through tests
4. **Validate Approach** - Ensure tests fail appropriately before implementation

---

## Test Isolation Strategy

### Legacy Test Namespaces

Move existing tests that validate current `binMinutes` format:

```
FlowTime.Tests/                    → FlowTime.Tests.Legacy/
├── ValidationTests.cs             → ValidationTests.cs (binMinutes validation)
├── GraphTests.cs                  → GraphTests.cs (current parser)
├── ApiIntegrationTests.cs         → ApiIntegrationTests.cs (current API)
└── ... (other current-format tests)

FlowTime.Api.Tests/                → FlowTime.Api.Tests.Legacy/
├── ApiIntegrationTests.cs         → ApiIntegrationTests.cs (current endpoints)
├── ParityTests.cs                 → ParityTests.cs (current parity)
└── ... (other API tests)
```

### Tests to Keep (Already Target-Compatible)

These tests don't depend on `binMinutes` format:
- ✅ `Expressions/ExpressionParserTests.cs` - Expression evaluation (format-agnostic)
- ✅ `Expressions/ExpressionIntegrationTests.cs` - Expression integration
- ✅ `BinaryOpTests.cs` - Binary operations (format-agnostic)
- ✅ `DeterminismTests.cs` - Determinism validation
- ✅ `Nodes/ShiftNodeTests.cs` - SHIFT node behavior
- ✅ `Pmf/PmfNodeTests.cs` - PMF node tests (already exist!)
- ✅ `Pmf/PmfTests.cs` - PMF tests

### Tests to Create (Target Schema)

New tests for target-model-schema format:
- 🆕 `TimeGrid/TimeGridValidationTests.cs` - binSize/binUnit validation
- 🆕 `TimeGrid/TimeUnitConversionTests.cs` - Unit conversion logic
- 🆕 `Schema/SchemaVersionTests.cs` - schemaVersion validation
- 🆕 `Schema/TargetSchemaValidationTests.cs` - Complete schema validation
- 🆕 `Pmf/PmfCompilationPipelineTests.cs` - 4-phase compilation
- 🆕 `Pmf/PmfGridAlignmentTests.cs` - Repeat/error policies
- 🆕 `Pmf/PmfProvenanceTests.cs` - PMF provenance tracking
- 🆕 `Rng/Pcg32Tests.cs` - PCG32 algorithm tests
- 🆕 `Rng/RngDeterminismTests.cs` - RNG determinism validation
- 🆕 `Provenance/ProvenanceStorageTests.cs` - provenance.json creation
- 🆕 `Provenance/ProvenanceHeaderTests.cs` - X-Model-Provenance header
- 🆕 `Provenance/ProvenanceEmbeddedTests.cs` - Embedded YAML provenance
- 🆕 `Provenance/ProvenanceQueryTests.cs` - Query by model_id/template_id

---

## New Test Structure

```
FlowTime.Tests/
├── Legacy/                        # OLD: Tests for binMinutes format
│   ├── ValidationTests.cs
│   ├── GraphTests.cs
│   └── ApiIntegrationTests.cs
│
├── TimeGrid/                      # NEW: Target schema time grid tests
│   ├── TimeGridValidationTests.cs
│   ├── TimeUnitConversionTests.cs
│   └── TimeGridParsingTests.cs
│
├── Schema/                        # NEW: Schema validation tests
│   ├── SchemaVersionTests.cs
│   ├── TargetSchemaValidationTests.cs
│   └── SchemaErrorHandlingTests.cs
│
├── Pmf/                          # NEW: Enhanced PMF tests
│   ├── PmfCompilationPipelineTests.cs
│   ├── PmfGridAlignmentTests.cs
│   ├── PmfProvenanceTests.cs
│   └── PmfValidationTests.cs
│
├── Rng/                          # NEW: RNG tests
│   ├── Pcg32Tests.cs
│   ├── RngDeterminismTests.cs
│   └── RngIntegrationTests.cs
│
├── Provenance/                   # NEW: Provenance tests
│   ├── ProvenanceStorageTests.cs
│   ├── ProvenanceHeaderTests.cs
│   ├── ProvenanceEmbeddedTests.cs
│   └── ProvenanceQueryTests.cs
│
├── Expressions/                  # KEEP: Format-agnostic
│   ├── ExpressionParserTests.cs
│   └── ExpressionIntegrationTests.cs
│
└── Nodes/                        # KEEP: Node behavior tests
    └── ShiftNodeTests.cs

FlowTime.Api.Tests/
├── Legacy/                       # OLD: Current API tests
│   ├── ApiIntegrationTests.cs
│   └── ParityTests.cs
│
├── Provenance/                   # NEW: Provenance endpoint tests
│   ├── ProvenanceEndpointTests.cs
│   ├── ProvenanceQueryTests.cs
│   └── ProvenanceIntegrationTests.cs
│
└── Schema/                       # NEW: API schema tests
    ├── TargetSchemaAcceptanceTests.cs
    └── SchemaValidationErrorTests.cs

FlowTime.Cli.Tests/
├── Legacy/                       # OLD: Current CLI tests
│   └── OutputDirectoryConfigurationTests.cs
│
└── Schema/                       # NEW: CLI schema tests
    ├── TargetSchemaProcessingTests.cs
    └── CliValidationTests.cs
```

---

## Test Implementation Order

### Step 1: Legacy Isolation (First commit)
```bash
test(core): Isolate legacy tests to .Legacy namespace

- Move binMinutes-dependent tests to FlowTime.Tests.Legacy
- Move current API tests to FlowTime.Api.Tests.Legacy
- Update namespaces and project structure
- Ensure all legacy tests still pass
```

### Step 2: TimeGrid Tests (Failing - RED)
```bash
test(core): Add failing tests for TimeGrid evolution

- TimeGridValidationTests.cs (binSize/binUnit validation)
- TimeUnitConversionTests.cs (minutes/hours/days/weeks)
- TimeGridParsingTests.cs (YAML parsing)

Status: RED (TimeUnit enum doesn't exist yet)
```

### Step 3: Schema Version Tests (Failing - RED)
```bash
test(core): Add failing tests for schemaVersion validation

- SchemaVersionTests.cs (require schemaVersion: 1)
- TargetSchemaValidationTests.cs (complete validation)
- SchemaErrorHandlingTests.cs (error messages)

Status: RED (schemaVersion not enforced yet)
```

### Step 4: PMF Compilation Tests (Failing - RED)
```bash
test(core): Add failing tests for PMF compilation pipeline

- PmfCompilationPipelineTests.cs (4-phase compilation)
- PmfGridAlignmentTests.cs (repeat/error policies)
- PmfProvenanceTests.cs (provenance tracking)

Status: RED (PMF compilation not implemented)
```

### Step 5: RNG Tests (Failing - RED)
```bash
test(core): Add failing tests for PCG32 RNG

- Pcg32Tests.cs (algorithm correctness)
- RngDeterminismTests.cs (same seed → same output)
- RngIntegrationTests.cs (PMF integration)

Status: RED (PCG32 doesn't exist yet)
```

### Step 6: Provenance Tests (Failing - RED)
```bash
test(api): Add failing tests for provenance support

- ProvenanceStorageTests.cs (provenance.json creation)
- ProvenanceHeaderTests.cs (X-Model-Provenance)
- ProvenanceEmbeddedTests.cs (embedded YAML)
- ProvenanceQueryTests.cs (query filters)

Status: RED (provenance support not implemented)
```

### Step 7: Documentation
```bash
docs(test): Document Phase 0 test coverage

- This test plan document
- Coverage report showing failing tests
- Next steps for Phase 2 implementation
```

---

## Success Criteria for Phase 0

**Definition of Done:**
- [ ] All legacy tests isolated and passing
- [ ] New test structure established
- [ ] Failing tests written for:
  - [ ] TimeGrid evolution (binSize/binUnit)
  - [ ] Schema versioning (schemaVersion: 1)
  - [ ] PMF compilation pipeline
  - [ ] RNG integration (PCG32)
  - [ ] Provenance support
- [ ] Test coverage plan documented
- [ ] All tests compile (but many fail as expected)
- [ ] Solution still builds successfully
- [ ] Clear RED state (failing tests define work to do)

**Exit Criteria:**
✅ Phase 0 complete when all tests compile, legacy tests pass, new tests fail predictably

➡️ Ready for Phase 2 implementation (make failing tests pass)

---

## Test Example Templates

### TimeGrid Validation Test (Failing - RED)
```csharp
namespace FlowTime.Tests.TimeGrid;

[TestFixture]
public class TimeGridValidationTests
{
    [Test]
    public void Validate_BinSizeAndBinUnit_Required()
    {
        // Arrange
        var yaml = @"
schemaVersion: 1
grid:
  bins: 24
  # Missing binSize and binUnit
nodes:
  - id: test
    kind: const
    values: [1, 2, 3]
";

        // Act & Assert
        var ex = Assert.Throws<ValidationException>(() => 
            ModelParser.Parse(yaml));
        
        Assert.That(ex.Message, Does.Contain("binSize"));
        Assert.That(ex.Message, Does.Contain("binUnit"));
    }
    
    [TestCase("minutes", 1, 1)]
    [TestCase("hours", 1, 60)]
    [TestCase("days", 1, 1440)]
    [TestCase("weeks", 1, 10080)]
    public void TimeUnit_ToMinutes_ConvertsCorrectly(string unit, int size, int expected)
    {
        // Act
        var minutes = TimeUnit.Parse(unit).ToMinutes(size);
        
        // Assert
        Assert.That(minutes, Is.EqualTo(expected));
    }
}
```

### PMF Compilation Test (Failing - RED)
```csharp
namespace FlowTime.Tests.Pmf;

[TestFixture]
public class PmfCompilationPipelineTests
{
    [Test]
    public void Compile_ValidPmf_ProducesConstSeries()
    {
        // Arrange
        var pmf = new PmfNode
        {
            Id = "test",
            Values = new[] { 1.0, 2.0, 3.0 },
            Probabilities = new[] { 0.5, 0.3, 0.2 }
        };
        var grid = new TimeGrid { Bins = 10 };
        var rng = new Pcg32(seed: 12345);
        
        // Act
        var compiled = PmfCompiler.Compile(pmf, grid, rng);
        
        // Assert
        Assert.That(compiled.Kind, Is.EqualTo(NodeKind.Const));
        Assert.That(compiled.Values.Length, Is.EqualTo(10));
        Assert.That(compiled.Values, Has.All.GreaterThanOrEqualTo(1.0));
        Assert.That(compiled.Values, Has.All.LessThanOrEqualTo(3.0));
    }
}
```

### Provenance Storage Test (Failing - RED)
```csharp
namespace FlowTime.Api.Tests.Provenance;

[TestFixture]
public class ProvenanceStorageTests
{
    [Test]
    public async Task Run_WithProvenanceHeader_CreatesProvenanceJson()
    {
        // Arrange
        var request = new HttpRequestMessage(HttpMethod.Post, "/v1/run");
        request.Headers.Add("X-Model-Provenance", "model_test123");
        request.Content = new StringContent(ValidModelYaml, 
            Encoding.UTF8, "application/x-yaml");
        
        // Act
        var response = await _client.SendAsync(request);
        var result = await response.Content
            .ReadFromJsonAsync<RunResponse>();
        
        // Assert
        var provenancePath = Path.Combine(
            _dataDir, result.RunId, "provenance.json");
        Assert.That(File.Exists(provenancePath), Is.True);
        
        var provenance = JsonSerializer.Deserialize<ProvenanceMetadata>(
            await File.ReadAllTextAsync(provenancePath));
        Assert.That(provenance.ModelId, Is.EqualTo("model_test123"));
    }
}
```

---

## Phase 0 Implementation Order

**Complexity**: Medium  
**Risk**: Low (just tests, no breaking changes yet)

**Step 1**: Legacy isolation  
**Steps 2-3**: TimeGrid + Schema tests  
**Steps 4-6**: PMF + RNG + Provenance tests  
**Step 7**: Documentation

---

**Next**: Phase 2 implementation (make tests pass one component at a time)
