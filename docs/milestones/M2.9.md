# M2.9 â€” Schema Evolution & Documentation

**Status:** ðŸ”„ In Progress  
**Dependencies:** None  
**Target:** Complete schema evolution with documentation alignment and engine migration  
**Date:** 2025-10-07

---

## Goal

Complete the evolution of FlowTime schema architecture, migrating from `binMinutes` to `binSize`/`binUnit` format for enhanced flexibility and time unit support. This milestone encompasses both comprehensive schema documentation and the core engine migration to unified schema formats.

## Context & Strategic Benefits

The schema evolution provides:
- **Enhanced Flexibility**: Support for hours, days, weeks, etc. natively in time specifications
- **Schema Unification**: Single schema format across Template and Engine systems  
- **Future-Proofing**: Extensible time unit system for diverse modeling scenarios
- **Reduced Complexity**: Elimination of translation layers between schema formats
- **Clean Breaking Change**: TDD approach enables confident migration without backward compatibility constraints

## Schema Architecture

**Current Problem**: Two incompatible schema formats exist:
- **Template Schema** (FlowTime-Sim output): Uses `binSize`/`binUnit` format
- **Engine Schema** (FlowTime Engine input): Uses legacy `binMinutes` format

**Target State**: Engine evolved to accept Template Schema format directly - unified schema throughout the system.

## Four-Phase Evolution Plan

### Phase 0: Test-Driven Development Setup ðŸ“‹ PLANNED

**Goal**: Establish clean test architecture and comprehensive coverage before engine evolution to ensure safe refactoring.

**TDD Strategy**: Isolate legacy tests, write comprehensive new tests for target schema, then implement breaking changes with confidence.

#### 0.1 Legacy Test Isolation
**Approach**: Move existing tests to `.Legacy` namespaces to preserve them while building new test suite.

**Namespace Migration:**
- `FlowTime.Core.Tests` â†’ `FlowTime.Core.Tests.Legacy`
- `FlowTime.API.Tests` â†’ `FlowTime.API.Tests.Legacy`
- `FlowTime.Contracts.Tests` â†’ `FlowTime.Contracts.Tests.Legacy`

**Benefits:**
- **Clear Separation**: Old vs new tests clearly distinguished
- **Preservation**: Legacy tests remain functional during transition
- **Clean Architecture**: New tests start with proper structure
- **Safe Migration**: Can compare old vs new test results

#### 0.2 Breaking Change Strategy
**Philosophy**: Clean schema evolution without backward compatibility constraints.

**Rationale**: 
- **Development Phase**: FlowTime is in active development (0.x versioning)
- **TDD Safety**: Comprehensive test coverage eliminates migration risk
- **Clean Architecture**: Avoiding compatibility layers simplifies codebase
- **Future Flexibility**: Breaking cleanly now prevents technical debt

**Migration Approach**:
- **Legacy Preservation**: Move old tests to `.Legacy` namespaces
- **Target Implementation**: Build new implementation for target schema exclusively
- **Example Updates**: Update all examples to new schema format
- **Documentation**: Clear migration guide for any external users

#### 0.3 New Test Architecture
**Focus**: Write tests for evolved engine in proper namespaces before implementing changes.

**New Test Structure:**
```
FlowTime.Core.Tests/
â”œâ”€â”€ TimeGrid/                    # New binSize/binUnit tests
â”œâ”€â”€ Nodes/
â”‚   â”œâ”€â”€ ConstNodeTests.cs       # Enhanced const node tests
â”‚   â”œâ”€â”€ PmfNodeTests.cs         # New PMF node tests
â”‚   â””â”€â”€ ExprNodeTests.cs        # Updated expression tests
â”œâ”€â”€ Rng/
â”‚   â””â”€â”€ Pcg32Tests.cs           # New RNG tests
â”œâ”€â”€ Schema/
â”‚   â””â”€â”€ ValidationTests.cs      # New schema validation tests
â””â”€â”€ Legacy/                     # Moved legacy tests
    â””â”€â”€ [existing test files]

FlowTime.Cli.Tests/             # New CLI tests
â”œâ”€â”€ TimeGrid/
â”‚   â””â”€â”€ CliTimeGridTests.cs     # CLI binSize/binUnit handling
â”œâ”€â”€ Schema/
â”‚   â””â”€â”€ CliSchemaTests.cs       # CLI new schema validation
â”œâ”€â”€ Output/
â”‚   â””â”€â”€ CliOutputTests.cs       # CLI artifact generation tests
â””â”€â”€ Legacy/                     # Moved legacy CLI tests
    â””â”€â”€ [existing test files]
```

**Test Categories:**
- **TimeGrid Evolution**: `binSize`/`binUnit` conversion and validation
- **PMF Node Support**: Probability distribution sampling and validation
- **RNG Integration**: PCG32 deterministic generation
- **Schema Validation**: New format validation and error handling
- **API Evolution**: Enhanced endpoints and content negotiation
- **CLI Evolution**: New schema support, output generation, example processing

#### 0.3 Test-First Development
**Goal**: Write failing tests that define success criteria before implementation.

**TDD Cycle:**
1. **Red**: Write test for new engine capability (fails)
2. **Green**: Implement minimum code to make test pass
3. **Refactor**: Clean up implementation while keeping tests green
4. **Repeat**: Move to next capability

**Success Criteria:**
- [ ] Legacy tests isolated in `.Legacy` namespaces
- [ ] New test structure established
- [ ] Failing tests written for all Phase 2 capabilities
- [ ] Test coverage plan documented

### Phase 1: Schema Documentation & Alignment âœ… COMPLETED

**Goal**: Establish comprehensive, authoritative schema documentation and clarify relationships between systems.

**Completed Work:**
- **Template Schema Documentation**: Comprehensive specification with RNG/PMF support, Node Types, PMF Compilation Pipeline
- **Engine Schema Documentation**: Complete documentation of current `binMinutes` format with validation rules  
- **API Endpoint Standardization**: Updated all documentation to use `/api/v1/` format
- **Schema Relationship Clarification**: Clear documentation of Template vs Engine schema responsibilities
- **FlowTime-Sim Integration**: Documentation aligned with current FlowTime-Sim implementation

**Deliverables:**
- `docs/schemas/template-schema.md` - Authoritative template format specification
- `docs/schemas/engine-input-schema.md` - Complete engine input documentation  
- `docs/schemas/engine-input.schema.json` - JSON Schema for validation
- `docs/schemas/README.md` - Schema architecture overview
- Updated API endpoint references throughout documentation

### Phase 2: FlowTime Engine Evolution ðŸ“‹ PLANNED

**Goal**: Complete engine evolution to support full template schema capabilities including PMF nodes, RNG, and unified grid format.

**Core Engine Updates:**
- **TimeGrid Evolution**: `binMinutes` â†’ `binSize`/`binUnit` with time unit conversion
- **PMF Node Support**: Implement probability mass function nodes with distribution sampling
- **RNG Integration**: Add PCG32 deterministic random number generation
- **Schema Versioning**: Implement proper schema version handling and validation
- **Model Parser Enhancement**: Support new node types, validation rules, and error handling
- **API Evolution**: Enhanced endpoints with new content types and validation

### Phase 2.1: CLI Architecture Modernization ðŸ“‹ PLANNED

**Goal**: Evolve FlowTime CLI to be a focused developer tool working directly against evolved core engine.

**CLI Design Philosophy:**
- **Primary Tool**: Command should be `flowtime` (not `flowtime-cli`)
- **Developer-Focused**: Optimized for model development, testing, and automation
- **Local Execution**: Works completely offline with filesystem I/O
- **Direct Core Access**: No API dependencies or network requirements

**Core CLI Capabilities:**

```bash
# Basic model execution
flowtime model.yaml                     # Execute model, output to ./data/
flowtime model.yaml --output results/   # Custom output directory

# Development workflow
flowtime model.yaml --validate          # Schema validation only
flowtime model.yaml --dry-run           # Parse without execution  
flowtime model.yaml --verbose           # Detailed logging and metrics

# Reproducible execution
flowtime model.yaml --seed 12345        # Override RNG seed
flowtime model.yaml --deterministic     # Deterministic run IDs
```

**Schema Support Requirements:**
- **Input Processing**: Accept YAML models with `binSize`/`binUnit` format
- **TimeGrid Evolution**: Support flexible time units (minutes, hours, days, weeks)
- **PMF Nodes**: Process probability mass function definitions
- **RNG Integration**: Handle PCG32 deterministic random number generation
- **Validation**: Clear error messages for schema violations

**Output Generation:**
- **CSV Results**: Primary output format for analysis tools
- **Artifact Manifests**: Include schema metadata and run provenance
- **Verbose Logging**: Display execution plan and performance metrics
- **Error Reporting**: Clear diagnostic messages for failures

**Architecture Benefits:**
- **Fast Iteration**: Sub-second execution for typical models
- **Automation-Ready**: Perfect for CI/CD and scripting workflows
- **Portable**: Runs anywhere .NET runtime is available
- **Deterministic**: Reproducible results for testing and validation

**Files Requiring Updates:**
```
src/FlowTime.Cli/
â”œâ”€â”€ Program.cs              # Remove --via-api, add new schema support
â”œâ”€â”€ Configuration/          # Update for binSize/binUnit parameters
â”œâ”€â”€ Validation/             # New schema validation logic
â””â”€â”€ Output/                 # Update artifact generation

examples/
â”œâ”€â”€ hello/model.yaml        # Migrate to binSize/binUnit format
â”œâ”€â”€ it-system/model.yaml    # Update schema format
â”œâ”€â”€ transportation/model.yaml # Update schema format
â””â”€â”€ [all examples]          # Complete schema migration

docs/guides/
â””â”€â”€ CLI.md                  # Update with new schema examples
```

**CLI Evolution Priorities:**

**Phase 2.1a: Core Schema Support**
- Update TimeGrid handling for `binSize`/`binUnit`
- Implement new YAML schema parsing
- Add validation for PMF and RNG parameters
- Remove `--via-api` option completely

**Phase 2.1b: Enhanced Developer Experience**
- Add `--validate` for schema-only validation
- Implement `--dry-run` for parse-only mode
- Enhanced verbose output with execution metrics
- Improved error messages and diagnostics

**Phase 2.1c: Automation Support**
- Deterministic run ID generation
- Batch processing capabilities
- CI/CD-friendly exit codes and output
- JSON output format option

**CLI Usage Scenarios:**

**Model Development:**
```bash
# Typical development iteration
flowtime draft-model.yaml --validate    # Check schema
flowtime draft-model.yaml --dry-run     # Verify parsing
flowtime draft-model.yaml --verbose     # Full execution with metrics
```

**Testing & Validation:**
```bash
# Reproducible testing
flowtime model.yaml --seed 42 --deterministic
flowtime model.yaml --seed 123          # Different seed, different results

# Schema validation
flowtime *.yaml --validate --batch      # Validate multiple models
```

**CI/CD Integration:**
```bash
# Automated testing
flowtime examples/**/*.yaml --batch --quiet
flowtime model.yaml --validate --junit-output
```

**Runtime Characteristics:**
- **Execution Speed**: ~100ms for typical models, <1s for complex models
- **Memory Usage**: Streams results to files, minimal memory footprint
- **Dependencies**: Only requires .NET runtime, no external services
- **Offline Capable**: No network requirements, works in air-gapped environments

**Strategic Benefits:**
- **Schema Unification**: Single format eliminates translation complexity
- **Stochastic Modeling**: Native PMF and RNG support for advanced simulations
- **Enhanced Capabilities**: Full time unit flexibility (minutes, hours, days, weeks)
- **Future-Proof Architecture**: Extensible foundation for advanced modeling features

### Phase 3: Examples & Documentation Migration ðŸ“‹ PLANNED  

**Goal**: Complete migration of all examples, tests, and documentation to new unified schema.

**Migration Scope:**
- **CLI Updates**: Update FlowTime.Cli to support `binSize`/`binUnit` format and new schema
- **Example Models**: Update all model examples to use new schema format
- **Test Suite**: Migrate test cases to new schema format
- **Documentation**: Update all guides and references to reflect unified schema
- **Legacy Cleanup**: Remove references to old `binMinutes` format

**CLI Migration Details:**
- **Schema Processing**: CLI reads and validates new YAML schema format
- **TimeGrid Handling**: CLI processes `binSize`/`binUnit` parameters correctly
- **Output Format**: CLI artifacts use new schema format consistently
- **Verbose Logging**: CLI displays `binSize`/`binUnit` instead of `binMinutes`
- **Example Migration**: All models in `examples/` directory updated to new schema
- **Documentation**: CLI guide updated with new schema examples and usage patterns
- **Architecture Cleanup**: Remove `--via-api` option (CLI uses core directly)

## Current Status

**âœ… Phase 1 Complete**: Schema documentation and alignment work finished
- Comprehensive template and engine schema documentation created
- API endpoint standardization completed  
- FlowTime-Sim integration documentation aligned

**ðŸ“‹ Phase 2 Planned**: Engine migration ready for implementation
- Core engine updates designed and documented
- Breaking change migration strategy with comprehensive TDD coverage

**ðŸ“‹ Phase 3 Planned**: Final migration and cleanup phase
- Examples and tests ready for systematic update
- Documentation consolidation planned

## Success Criteria

**Phase 1** (âœ… Complete):
- [x] Comprehensive schema documentation published
- [x] Template and Engine schema relationships clarified
- [x] API endpoint standardization completed
- [x] FlowTime-Sim integration documentation aligned

**Phase 2** (ðŸ“‹ Planned):
- [ ] TimeGrid structure supports `binSize`/`binUnit` format
- [ ] Engine accepts new schema format with validation
- [ ] PMF nodes implemented with distribution sampling
- [ ] RNG integration with PCG32 deterministic generation
- [ ] API responses updated to new format
- [ ] CLI evolved to `flowtime` command with new schema support
- [ ] CLI removed `--via-api` option for direct core access

**Phase 3** (ðŸ“‹ Planned):  
- [ ] All examples migrated to new schema format
- [ ] Test suite validates new schema exclusively
- [ ] Documentation reflects unified schema throughout
- [ ] Legacy `binMinutes` references removed

## Dependencies & Integration

**FlowTime-Sim Integration**: This milestone runs in parallel with UI-M2.9 (Template Schema Migration). The UI milestone focuses on template form updates and UI integration, while M2.9 handles the core engine evolution.

**Charter Independence**: This milestone is independent of charter workflow decisions and provides foundational schema improvements regardless of UI paradigm choices.

---

*This milestone was reorganized from Compare Workflow to focus on schema evolution priorities. Compare functionality moved to M2.10 (deferred).*