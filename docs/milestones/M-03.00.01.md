# M-03.00.01 ‚Äî Shared Expression Validation Library

**Status:** üìã Planned  
**Dependencies:** M-03.00 (Foundation + Fixtures)  
**Target:** Extract the Engine expression parser/AST/validation logic into a shared `FlowTime.Expressions` assembly with mirrored tests so FlowTime Engine and FlowTime.Sim consume the same validation behaviour.

---

## Overview

Post‚ÄëM-03.00 we must publish a neutral expression library to unblock FlowTime.Sim‚Äôs validation workstream (`time-travel-planning-roadmap.md`, Post-M-03.00 follow-up #1). This milestone formalises that refactor: the Engine extracts its expression parser, AST model, and semantic validation rules into a standalone assembly (`FlowTime.Expressions`) and ships a matching unit test suite. Both Engine and Sim will reference this package going forward, guaranteeing consistent expression semantics ahead of M-03.01 (/state APIs) and the Sim schema upgrades.

### Strategic Context
- **Motivation:** Prevent divergence between Engine and FlowTime.Sim validation logic and enable shared TDD coverage before API work begins.
- **Impact:** Engine codebase gains a reusable expression component; FlowTime.Sim can adopt the library in its M-03 validation milestone without further changes.
- **Dependencies:** M-03.00 fixtures and schema extensions must already be in place.

---

## Scope

### In Scope ‚úÖ
1. Create a new `FlowTime.Expressions` project containing:
   - Expression AST definitions, parser, and semantic validation rules currently under `FlowTime.Core/Expressions`.
   - Public API surface sufficient for both Engine and Sim consumers.
2. Export shared unit tests covering parsing, AST structure, SHIFT rules, and validation errors (migrated/adapted from existing Engine tests).
3. Update Engine projects (core, API, CLI, tests) to reference the new assembly and pass all existing tests.
4. Deliver developer documentation explaining how Engine and Sim consume the shared library.

### Out of Scope ‚ùå
- FlowTime.Sim code changes (tracked separately under SIM-M-03 workstreams).
- TelemetryLoader integration or schema changes beyond existing M-03.00 outputs.
- New expression features (grammar remains unchanged).

### Future Work
- FlowTime.Sim adoption (SIM-M-03 WS2) using the published library.
- Optional NuGet packaging or versioning strategy once both surfaces are onboarded.

---

## Requirements

### Functional Requirements

#### FR1: Shared Expression Assembly
**Description:** Provide a `FlowTime.Expressions` assembly exposing parser, AST, and validation entry points.

**Acceptance Criteria:**
- [ ] Engine builds successfully with `FlowTime.Expressions` replacing internal parser usage.
- [ ] API surface exported from the new assembly matches existing Engine capabilities (parser, node references, validation helpers).
- [ ] Semantic SHIFT validation (self-reference with initial conditions) is enforced via the shared library.

#### FR2: Test Coverage Migration
**Description:** Shared library ships with the unit tests necessary to guarantee behaviour parity.

**Acceptance Criteria:**
- [ ] Existing Engine expression tests are migrated or re-pointed to the new assembly.
- [ ] Additional regression tests confirm the shared library reports identical errors to the pre-refactor implementation.
- [ ] CI executes the shared test suite as part of the Engine solution and passes.

### Non-Functional Requirements

#### NFR1: Backward Compatibility
**Target:** No observable regressions in Engine behaviour or public APIs after adopting the shared assembly.
**Validation:** All M-02.10+ regression tests pass; manual smoke test of `flowtime run` ensures expression evaluation remains identical.

#### NFR2: Documentation & Developer Guidance
**Target:** Contributors understand how to reference the shared library.
**Validation:** Update contributor docs (e.g., `docs/development/versioning.md` or appropriate architecture notes) describing the shared component, plus README entry in the new project.

---

## Technical Design

### Architecture Decisions
- **Extraction Approach:** Move the expression parser, AST nodes, and validation logic from `FlowTime.Core` into a new project. Engine references the new assembly; internal namespaces remain consistent to minimise churn.
- **Shared Tests:** Consolidate parser/validation tests into a dedicated test project (e.g., `FlowTime.Expressions.Tests`) executed within the Engine solution.
- **Consumer Updates:** Engine surface layers (core, CLI, API) reference `FlowTime.Expressions` for expression handling. No behavioural changes occur beyond library relocation.
- **TDD Workflow:** Begin by creating failing tests in the new test project that mirror current Engine expectations, then refactor code until tests pass.

---

## Implementation Plan

### Phase 1: Library Extraction
1. Create `src/FlowTime.Expressions/` project replicating existing AST, parser, and validation code.
2. Add `FlowTime.Expressions.Tests` with initial failing tests copied from Engine‚Äôs expression suite.
3. Wire projects into `FlowTime.sln`.

### Phase 2: Engine Integration
1. Replace Engine references to internal expression classes with references to `FlowTime.Expressions`.
2. Remove redundant code from `FlowTime.Core/Expressions`.
3. Update Engine unit/integration tests to reference the shared assembly; ensure all pass.

### Phase 3: Documentation & Cleanup
1. Document the shared library usage (developer notes + mention in `docs/architecture/run-provenance.md` or related guides if necessary).
2. Ensure metadata (e.g., `Directory.Build.props`, solution filters) include the new project.
3. Final validation: run full test suite and smoke-test CLI.

---

## Test Plan

### TDD Approach
1. Duplicate existing expression parser/validation tests into the new shared test project and run them against the extracted assembly (expecting initial failures).
2. Refactor code until the shared tests pass.
3. Re-run the Engine test suite (`dotnet test FlowTime.sln`) to confirm regression coverage.

### Test Cases
- Parser success cases (constants, binary ops, nested functions).
- Parser failure cases (unknown tokens, mismatched parentheses, invalid identifiers).
- Semantic validations (self-referential SHIFT requiring `initial`, negative SHIFT lag errors).
- Integration smoke test: `flowtime run` on existing fixtures to ensure outputs match pre-refactor results.

---

## Success Criteria
- [ ] `FlowTime.Expressions` project added with complete parser/validation implementation.
- [ ] Shared test suite (`FlowTime.Expressions.Tests`) exercises parser and validation logic.
- [ ] Engine builds/tests passing; no behavioural changes observed.
- [ ] Documentation updated to direct Engine/Sim teams to the shared library.
- [ ] Milestone tracking doc (`docs/milestones/tracking/M-03.00-tracking.md`) reflects completion.

---

## File Impact Summary

### Files to Modify
- `FlowTime.sln`
- `src/FlowTime.Core/Expressions/*` (remove/migrate code)
- `tests/FlowTime.Tests/Expressions/*` (relocate tests)
- Documentation references (`docs/architecture/...`, `docs/development/...`)

### Files to Create
- `src/FlowTime.Expressions/**`
- `tests/FlowTime.Expressions.Tests/**`
- README or project notes for the shared assembly (optional but recommended)

---

## References
- `docs/architecture/time-travel/time-travel-planning-roadmap.md` (Post-M-03.00 follow-up #1)
- `docs/architecture/time-travel/sim/sim-implementation-plan.md` (WS2 dependency)
- `docs/architecture/time-travel/sim/sim-architecture-overview.md` (shared validation requirement)
