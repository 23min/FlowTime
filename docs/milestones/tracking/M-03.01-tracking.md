# M-03.01 Implementation Tracking

**Milestone:** M-03.01 ‚Äî Time-Travel State APIs  
**Started:** (tracking pending kickoff)  
**Status:** üìã Not Started  
**Branch:** `time-travel-m3`  
**Assignee:** Codex (AI)

---

## Quick Links

- **Milestone Document:** [`docs/milestones/M-03.01.md`](../M-03.01.md)
- **Roadmap Context:** [`docs/architecture/time-travel/time-travel-planning-roadmap.md`](../../architecture/time-travel/time-travel-planning-roadmap.md)
- **Milestone Guide:** [`docs/development/milestone-documentation-guide.md`](../../development/milestone-documentation-guide.md)

---

## Current Status

### Overall Progress
- [ ] Phase 1: Contracts & Metadata Plumbing (0/3 tasks)
- [ ] Phase 2: Endpoint & Validation Pipeline (0/3 tasks)
- [ ] Phase 3: Testing, Observability & Docs (0/3 tasks)

### Test Status
- **Unit Tests:** 0 passing / 0 total
- **Integration Tests:** 0 passing / 0 total
- **Golden Tests:** 0 passing / 0 total

---

## Progress Log

### Kickoff Session (Pending)

**Preparation:**
- [ ] Review milestone document and roadmap context
- [ ] Enumerate fixture runs used for validation
- [ ] Confirm branch `time-travel-m3` is up to date with latest `main`
- [ ] Draft initial test scaffolding plan

**Next Steps:**
- [ ] Begin Phase 1 Task 1.1 (DTO scaffolding tests)
- [ ] Capture baseline golden output expectations

---

## Phase 1: Contracts & Metadata Plumbing

**Goal:** Establish DTOs, manifest readers, and schema documentation that drive both endpoints.

### Task 1.1: Define Response DTOs
**File(s):** `src/FlowTime.Contracts/TimeTravel/StateResponse.cs`, `StateWindowResponse.cs`

**Checklist (TDD Order):**
- [ ] Write unit test: `StateResponseSerializationTests.RoundTripsMetadata()` (RED)
- [ ] Add DTO classes with required fields and attributes (GREEN)
- [ ] Update contracts project to expose time-travel namespace (GREEN)

**Status:** ‚è≥ Not Started

### Task 1.2: Implement RunManifestReader
**File(s):** `src/FlowTime.Core/TimeTravel/RunManifestReader.cs`

**Checklist (TDD Order):**
- [ ] Write unit test: `RunManifestReaderTests.ReadAsync_ReturnsModeSchemaHash()` (RED)
- [ ] Implement manifest parsing with provenance hash validation (GREEN)
- [ ] Add negative test for missing metadata (GREEN)

**Status:** ‚è≥ Not Started

### Task 1.3: Document Response Schema
**File(s):** `docs/schemas/time-travel-state-response.schema.json` (optional), `docs/milestones/M-03.01.md`

**Checklist (TDD Order):**
- [ ] Draft schema validation tests ensuring required fields present (RED)
- [ ] Publish JSON Schema or Markdown contract and link from docs (GREEN)
- [ ] Regenerate or approve documentation snapshots (GREEN)

**Status:** ‚è≥ Not Started

### Phase 1 Validation

- [ ] Build solution (`dotnet build FlowTime.sln`)
- [ ] Run relevant unit tests (`dotnet test tests/FlowTime.Contracts.Tests` if created)
- [ ] Verify schema documentation checked in

---

## Phase 2: Endpoint & Validation Pipeline

**Goal:** Implement `/state` and `/state_window` handlers backed by mode-aware validation.

### Task 2.1: Build StateSnapshotBuilder
**File(s):** `src/FlowTime.API/TimeTravel/StateSnapshotBuilder.cs`

**Checklist (TDD Order):**
- [ ] Write unit test: `StateSnapshotBuilderTests.BuildAsync_ComputesDerivedMetrics()` (RED)
- [ ] Implement snapshot aggregation using derived metrics helper (GREEN)
- [ ] Add guard test for missing node metrics (GREEN)

**Status:** ‚è≥ Not Started

### Task 2.2: Implement Mode Validator
**File(s):** `src/FlowTime.Core/TimeTravel/ModeValidator.cs`

**Checklist (TDD Order):**
- [ ] Write unit test: `ModeValidatorTests.TelemetryMissingSeries_ReturnsWarning()` (RED)
- [ ] Implement validator with per-mode rules and provenance checks (GREEN)
- [ ] Add test for provenance mismatch error payload (GREEN)

**Status:** ‚è≥ Not Started

### Task 2.3: Wire API Endpoints
**File(s):** `src/FlowTime.API/Program.cs`, `src/FlowTime.API/TimeTravel/StateEndpoints.cs`

**Checklist (TDD Order):**
- [ ] Write integration test: `StateEndpointTests.GetState_ReturnsSnapshot()` (RED)
- [ ] Add minimal API routes and dependency registrations (GREEN)
- [ ] Verify telemetry warnings flow through response (GREEN)

**Status:** ‚è≥ Not Started

### Phase 2 Validation

- [ ] `dotnet test tests/FlowTime.API.Tests/FlowTime.API.Tests.csproj`
- [ ] Verify `/state` and `/state_window` requests via `.http` files
- [ ] Inspect logs for validation metadata

---

## Phase 3: Testing, Observability & Docs

**Goal:** Finalise automation, golden snapshots, documentation, and logging coverage.

### Task 3.1: Golden Snapshot Tests
**File(s):** `tests/FlowTime.API.Tests/TimeTravel/ApprovedResponses/*`

**Checklist (TDD Order):**
- [ ] Write failing golden test for `/state` response (RED)
- [ ] Generate approved JSON from fixture run (GREEN)
- [ ] Repeat for `/state_window` slice (GREEN)

**Status:** ‚è≥ Not Started

### Task 3.2: Observability Verification
**File(s):** Logging configuration, tests capturing logs

**Checklist (TDD Order):**
- [ ] Write integration test asserting structured logs include runId/mode (RED)
- [ ] Implement logging hooks in handlers (GREEN)
- [ ] Document log fields in milestone references (GREEN)

**Status:** ‚è≥ Not Started

### Task 3.3: Documentation & Samples
**File(s):** `src/FlowTime.API/FlowTime.API.http`, `docs/architecture/time-travel/time-travel-planning-roadmap.md`

**Checklist (TDD Order):**
- [ ] Update `.http` samples to hit new endpoints (RED via docs check)
- [ ] Refresh roadmap & decision log references to mark milestone active (GREEN)
- [ ] Capture verification notes in tracking log (GREEN)

**Status:** ‚è≥ Not Started

### Phase 3 Validation

- [ ] Run full solution tests (`dotnet test FlowTime.sln`)
- [ ] Manually execute `.http` samples against local API
- [ ] Confirm documentation links render correctly

---

## Testing & Validation

### Test Case 1: `/state` happy path
- [ ] Call `/v1/runs/{fixtureRun}/state?binIndex=42`
- [ ] Expect `200` with populated metadata, derived metrics, empty warnings for simulation run
- [ ] Verify log entry includes `runId=fixtureRun` and `mode=simulation`

### Test Case 2: `/state_window` range validation
- [ ] Call `/v1/runs/{fixtureRun}/state_window?startBin=50&endBin=30`
- [ ] Expect `400` with `invalid_range` error code
- [ ] Confirm no snapshot builder invocation

### Test Case 3: Provenance mismatch
- [ ] Manipulate request to supply stale hash header (if exposed) or altered manifest path
- [ ] Expect `409` with expected vs actual hash in response
- [ ] Warning counter increments in logs/metrics

---

## Issues Encountered

- None yet. This will be updated once implementation begins.

---

## Final Checklist

### Code Complete
- [ ] All phase tasks complete
- [ ] All tests passing
- [ ] No compilation warnings
- [ ] New endpoints manually smoke-tested

### Documentation
- [ ] Milestone document status updated to üîÑ / ‚úÖ as work progresses
- [ ] Roadmap adjusted to reflect implementation state
- [ ] `.http` samples validated against running API

### Quality Gates
- [ ] Unit tests green
- [ ] Integration tests green
- [ ] Golden snapshots approved
- [ ] Logs reviewed for correctness
