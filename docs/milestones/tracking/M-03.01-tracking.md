# M-03.01 Implementation Tracking

**Milestone:** M-03.01 ‚Äî Time-Travel State APIs  
**Started:** 2025-10-14  
**Status:** üîÑ In Progress  
**Branch:** `time-travel-m3`  
**Assignee:** Codex (AI)

---

## Quick Links

- **Milestone Document:** [`docs/milestones/M-03.01.md`](../M-03.01.md)
- **Roadmap Context:** [`docs/architecture/time-travel/time-travel-planning-roadmap.md`](../../architecture/time-travel/time-travel-planning-roadmap.md)
- **Milestone Guide:** [`docs/development/milestone-documentation-guide.md`](../../development/milestone-documentation-guide.md)

---

## Current Status

### Overall Progress
- [x] Phase 1: Contracts & Metadata Plumbing (2/3 tasks complete)
- [x] Phase 2: Endpoint & Validation Pipeline (3/3 tasks complete)
- [x] Phase 3: Testing, Observability & Docs (3/3 tasks complete)

### Test Status
- **Unit Tests:** `dotnet test tests/FlowTime.Core.Tests` (pass)
- **Integration Tests:** `dotnet test tests/FlowTime.Api.Tests` (pass)
- **Golden Tests:** `state-approved.json`, `state-window-approved.json`

---

## Progress Log

### Kickoff Session (Pending)

**Preparation:**
- [ ] Review milestone document and roadmap context
- [ ] Enumerate fixture runs used for validation
- [ ] Confirm branch `time-travel-m3` is up to date with latest `main`
- [ ] Draft initial test scaffolding plan

**Next Steps:**
- [x] Begin Phase 1 Task 1.1 (DTO scaffolding tests)
- [ ] Capture baseline golden output expectations

---

### 2025-10-14 ‚Äî Phase 1/2 Kickoff

**Changes:**
- Authored `StateContractSerializationTests` to drive new time-travel DTOs, added `StateSnapshotResponse`/`StateWindowResponse` contracts under `FlowTime.Contracts`.
- Introduced `RunManifestReader` with telemetry source extraction and negative coverage, wiring it into `StateQueryService` along with the new metadata envelope.
- Reworked `/state` and `/state_window` handlers to emit enriched metadata/provenance plus telemetry hints; updated integration fixtures and assertions.

**Tests:**
- ‚úÖ `dotnet test tests/FlowTime.Core.Tests`
- ‚úÖ `dotnet test tests/FlowTime.Api.Tests`

**Next Steps:**
- [ ] Flesh out mode-aware validation + warning surface (Phase 2.2).
- [ ] Add golden snapshots and logging assertions once response shape stabilises.
- [ ] Update `.http` samples and docs after validation work lands.

---

### 2025-10-15 ‚Äî Mode Validation Pipeline

**Changes:**
- Implemented `ModeValidator` to enforce simulation requirements and surface telemetry source warnings; added provenance hash guard in `StateQueryService`.
- Propagated validator results through node telemetry metadata and response warnings; updated DI registration (`ModeValidator`) and error payload structure (`code`).
- Expanded integration/unit tests (`ModeValidatorTests`, `StateEndpointTests`) to cover new metadata, warnings, provenance behaviour, and NaN/telemetry warning paths.

**Tests:**
- ‚úÖ `dotnet test tests/FlowTime.Core.Tests`
- ‚úÖ `dotnet test tests/FlowTime.Api.Tests`

**Next Steps:**
- [ ] Capture golden responses and observability verification before Phase 3 closure.
- [ ] Finalise logging/doc updates for Phase 3 tasks.

---

### 2025-10-16 ‚Äî Golden Snapshots & Telemetry Warnings

**Changes:**
- Added `/state` and `/state_window` golden snapshots (`tests/FlowTime.Api.Tests/Golden/*.json`) with sanitized storage paths.
- Hardened telemetry missing-source handling so runs return warnings instead of 500s; surfaced them via `ModeValidator` and response metadata.
- Expanded integration tests to assert telemetry warning behaviour, simulation failures, and the approved golden payloads.

**Tests:**
- ‚úÖ `dotnet test tests/FlowTime.Core.Tests`
- ‚úÖ `dotnet test tests/FlowTime.Api.Tests`

**Next Steps:**
- [ ] Add logging assertions and `.http` sample updates (Phase 3).
- [ ] Update milestone/docs once observability work completes.

---

### 2025-10-17 ‚Äî Observability Assertions & Docs Refresh

**Changes:**
- Added structured logging in `StateQueryService` (event IDs 3001/3002) capturing `runId`, `mode`, and bin counts for `/state` and `/state_window`.
- Introduced `TestLogCollector` test infrastructure and new integration assertions verifying observability fields in `StateEndpointTests`.
- Updated `FlowTime.API.http` samples with enriched response envelopes and inline walkthrough for the new metadata/telemetry payload.
- Recorded Phase 3 completion and validation details within this milestone tracker.

**Tests:**
- ‚úÖ `dotnet test tests/FlowTime.Api.Tests --logger "console;verbosity=detailed"`
- ‚úÖ `dotnet test tests/FlowTime.Core.Tests --logger "console;verbosity=minimal"`

**Next Steps:**
- [ ] Revisit Phase 1 Task 1.3 schema documentation deliverable.
- [ ] Smoke `.http` samples against a running API instance prior to milestone closure.
- [ ] Follow-up: add wildcard (`*`) expansion support to `RunArtifactWriter` outputs so `.http` samples emit CSVs without explicit series lists.
- [ ] Follow-up: update `RunArtifactWriter` to persist the canonical `model/metadata/provenance` artifact layout so runs created via `/v1/run` can be replayed by `/state` without manual fixes.

## Phase 1: Contracts & Metadata Plumbing

**Goal:** Establish DTOs, manifest readers, and schema documentation that drive both endpoints.

### Task 1.1: Define Response DTOs
**File(s):** `src/FlowTime.Contracts/TimeTravel/StateContracts.cs`, `tests/FlowTime.Core.Tests/TimeTravel/StateContractSerializationTests.cs`

**Checklist (TDD Order):**
- [x] Write unit test: `StateContractSerializationTests.StateSnapshotResponse_SerializesExpectedShape` (RED)
- [x] Add DTO classes with required fields and attributes (GREEN)
- [x] Update contracts project references (`FlowTime.Core.Tests` ‚Üí Contracts) (GREEN)

**Status:** ‚úÖ Complete

### Task 1.2: Implement RunManifestReader
**File(s):** `src/FlowTime.Core/TimeTravel/RunManifestReader.cs`, `tests/FlowTime.Core.Tests/TimeTravel/RunManifestReaderTests.cs`

**Checklist (TDD Order):**
- [x] Write unit tests covering metadata hash/mode and missing metadata failure (RED)
- [x] Implement manifest parsing with telemetry source extraction + YAML fallback (GREEN)
- [x] Extend tests for semantics-only telemetry URIs (GREEN)

**Status:** ‚úÖ Complete

### Task 1.3: Document Response Schema
**File(s):** `docs/schemas/time-travel-state.schema.json`, `docs/milestones/M-03.01.md`

**Checklist (TDD Order):**
- [ ] Draft schema validation tests ensuring required fields present (RED)
- [x] Publish JSON Schema or Markdown contract and link from docs (GREEN)
- [ ] Regenerate or approve documentation snapshots (GREEN)

**Status:** ‚ö†Ô∏è In Progress

### Phase 1 Validation

- [x] Run core unit tests (`dotnet test tests/FlowTime.Core.Tests`)
- [x] Draft response schema documentation / JSON schema artifact

---

## Phase 2: Endpoint & Validation Pipeline

**Goal:** Implement `/state` and `/state_window` handlers backed by mode-aware validation.

### Task 2.1: Adapt StateQueryService to Time-Travel Contracts
**File(s):** `src/FlowTime.API/Services/StateQueryService.cs`

**Checklist (TDD Order):**
- [x] Update integration test (`StateEndpointTests.GetState_ReturnsSnapshotWithDerivedMetrics`) to fail on legacy payload (RED)
- [x] Implement new response mapping using `StateSnapshotResponse`/`StateWindowResponse` (GREEN)
- [x] Ensure metadata/telemetry sourced via `RunManifestReader` (GREEN)

**Status:** ‚úÖ Complete

### Task 2.2: Implement Mode Validator
**File(s):** `src/FlowTime.Core/TimeTravel/ModeValidator.cs`

**Checklist (TDD Order):**
- [x] Write unit tests covering telemetry warnings vs simulation failures (RED)
- [x] Implement validator with per-mode rules and provenance checks (GREEN)
- [x] Add provenance mismatch handling surfaced via `StateQueryException` (GREEN)

**Status:** ‚úÖ Complete

### Task 2.3: Harden API Validations & Telemetry Surface
**File(s):** `src/FlowTime.API/Services/StateQueryService.cs`, `tests/FlowTime.Api.Tests/StateEndpointTests.cs`

**Checklist (TDD Order):**
- [x] Update integration tests to assert telemetry metadata + timestamps (RED)
- [x] Add DI registration for manifest/validator & ensure tests pass (GREEN)
- [x] Layer mode-aware validation/warning assertions (RED/GREEN)

**Status:** ‚úÖ Complete

### Phase 2 Validation

- [x] `dotnet test tests/FlowTime.API.Tests/FlowTime.API.Tests.csproj`
- [ ] Verify `/state` and `/state_window` requests via `.http` files
- [x] Inspect logs for validation metadata

---

## Phase 3: Testing, Observability & Docs

**Goal:** Finalise automation, golden snapshots, documentation, and logging coverage.

### Task 3.1: Golden Snapshot Tests
**File(s):** `tests/FlowTime.Api.Tests/Golden/*`

**Checklist (TDD Order):**
- [x] Write failing golden test for `/state` response (RED)
- [x] Generate approved JSON from fixture run (GREEN)
- [x] Repeat for `/state_window` slice (GREEN)

**Status:** ‚úÖ Complete

### Task 3.2: Observability Verification
**File(s):** Logging configuration, tests capturing logs

**Checklist (TDD Order):**
- [x] Write integration test asserting structured logs include runId/mode (RED)
- [x] Implement logging hooks in handlers (GREEN)
- [x] Document log fields in milestone references (GREEN)

**Status:** ‚úÖ Complete

### Task 3.3: Documentation & Samples
**File(s):** `src/FlowTime.API/FlowTime.API.http`, `docs/architecture/time-travel/time-travel-planning-roadmap.md`

**Checklist (TDD Order):**
- [x] Update `.http` samples to hit new endpoints (RED via docs check)
- [ ] Refresh roadmap & decision log references to mark milestone active (GREEN)
- [x] Capture verification notes in tracking log (GREEN)

**Status:** ‚ö†Ô∏è In Progress

### Phase 3 Validation

- [ ] Run full solution tests (`dotnet test FlowTime.sln`)
- [ ] Manually execute `.http` samples against local API
- [ ] Confirm documentation links render correctly

---

## Testing & Validation

### Test Case 1: `/state` happy path
- [ ] Call `/v1/runs/{fixtureRun}/state?binIndex=42`
- [ ] Expect `200` with populated metadata, derived metrics, empty warnings for simulation run
- [ ] Verify log entry includes `runId=fixtureRun` and `mode=simulation`

### Test Case 2: `/state_window` range validation
- [ ] Call `/v1/runs/{fixtureRun}/state_window?startBin=50&endBin=30`
- [ ] Expect `400` with `invalid_range` error code
- [ ] Confirm no snapshot builder invocation

### Test Case 3: Provenance mismatch
- [ ] Manipulate request to supply stale hash header (if exposed) or altered manifest path
- [ ] Expect `409` with expected vs actual hash in response
- [ ] Warning counter increments in logs/metrics

---

## Issues Encountered

- None yet. This will be updated once implementation begins.

---

## Final Checklist

### Code Complete
- [ ] All phase tasks complete
- [x] All tests passing
- [ ] No compilation warnings
- [ ] New endpoints manually smoke-tested

### Documentation
- [ ] Milestone document status updated to üîÑ / ‚úÖ as work progresses
- [ ] Roadmap adjusted to reflect implementation state
- [ ] `.http` samples validated against running API

### Quality Gates
- [x] Unit tests green
- [x] Integration tests green
- [x] Golden snapshots approved
- [x] Logs reviewed for correctness
