# Milestone M2.9 â€” Charter Compare Workflow

**Status:** ðŸ“‹ Planned (Charter-Aligned)  
**Dependencies:** M2.8 (UI Incremental Charter), M2.7 (Artifacts Registry)  
**Target:** Implement charter Compare functionality using artifacts registry  
**Date:** 2025-09-20

---

## Goal

Implement the **charter's Compare workflow** that enables side-by-side analysis of any two artifacts (Run vs Run, Run vs Telemetry, Model vs Model execution). This milestone establishes the core charter UI paradigm where Compare is a **contextual action** launched from results or artifacts registry, not a separate analysis mode.

## Context & Charter Alignment

The **FlowTime-Engine Charter** defines Compare as a core workflow:
- **Compare button** on results: Launch from current run to select comparison input
- **Compare action** on artifacts: Select baseline, choose comparison, view side-by-side results  
- **Input flexibility**: Compare Run artifacts, Telemetry artifacts, or fresh Model executions
- **Engine integration**: Engine runs/replays both inputs and produces comparison metrics

This milestone transforms comparison from "separate analysis feature" to **contextual workflow** integrated throughout the artifacts-centric UI.

## Functional Requirements

### **FR-M2.9-1: Compare Workflow Infrastructure**
Core Compare service and workflow management supporting charter's contextual approach.

**Compare Service Interface:**
```csharp
public interface ICompareWorkflowService
{
    // Start comparison from current run result
    Task<CompareSession> StartFromRunResultAsync(string baselineRunId, CancellationToken ct = default);
    
    // Start comparison from artifact registry
    Task<CompareSession> StartFromArtifactAsync(string baselineArtifactId, CancellationToken ct = default);
    
    // Select comparison input (any artifact type)
    Task<CompareSession> SelectComparisonInputAsync(string sessionId, string comparisonArtifactId, CancellationToken ct = default);
    
    // Execute comparison (engine computes both sides)
    Task<CompareResult> ExecuteComparisonAsync(string sessionId, CompareConfiguration config, CancellationToken ct = default);
    
    // Get comparison results with side-by-side data
    Task<CompareResult?> GetComparisonResultAsync(string sessionId, CancellationToken ct = default);
}

public class CompareSession
{
    public string Id { get; init; }
    public CompareInput Baseline { get; init; }
    public CompareInput? Comparison { get; init; }
    public CompareConfiguration? Configuration { get; init; }
    public CompareResult? Result { get; init; }
    public CompareStatus Status { get; init; }
}

public class CompareInput
{
    public string ArtifactId { get; init; }
    public string ArtifactType { get; init; } // "run", "model", "telemetry"
    public string Title { get; init; }
    public CompareInputSource Source { get; init; } // "artifact", "fresh_execution"
}

public enum CompareStatus { Draft, Configured, Computing, Completed, Failed }
```

**Compare Configuration Options:**
```csharp
public class CompareConfiguration
{
    // Grid alignment (when comparing different time ranges)
    public GridAlignment Alignment { get; init; } = GridAlignment.StartTime;
    
    // Metrics to compute
    public CompareMetrics Metrics { get; init; } = CompareMetrics.Standard;
    
    // Visual comparison options
    public CompareVisualization Visualization { get; init; } = CompareVisualization.SideBySide;
    
    // Export options
    public bool ExportResults { get; init; } = true;
}

public class CompareResult
{
    public string SessionId { get; init; }
    public CompareInput Baseline { get; init; }
    public CompareInput Comparison { get; init; }
    
    // Side-by-side telemetry data
    public Dictionary<string, CompareSeriesData> Series { get; init; }
    
    // Quantitative comparison metrics
    public CompareMetricsSummary Metrics { get; init; }
    
    // Generated artifacts
    public string? ComparisonRunId { get; init; } // If fresh execution was needed
    public string? ResultsArtifactId { get; init; } // Comparison results as artifact
}

public class CompareSeriesData
{
    public string SeriesId { get; init; }
    public double[] BaselineValues { get; init; }
    public double[] ComparisonValues { get; init; }
    public double[] DifferenceValues { get; init; }
    public double[] PercentChangeValues { get; init; }
}
```

### **FR-M2.9-2: Engine API Compare Integration**
Extend FlowTime-Engine API to support charter Compare operations with artifacts registry.

**New Engine Compare Endpoints:**
```bash
# Execute comparison between two artifacts  
POST /v1/compare
{
  "baseline": { "artifactId": "run_123", "type": "run" },
  "comparison": { "artifactId": "model_456", "type": "model" },
  "configuration": { 
    "alignment": "start_time",
    "metrics": ["mae", "smape", "correlation"],
    "exportResults": true
  }
}

# Get comparison results
GET /v1/compare/{sessionId}

# Export comparison results  
GET /v1/compare/{sessionId}/export/{format}
```

**Engine Compare Logic:**
```csharp
// Enhanced Program.cs Compare endpoint
v1.MapPost("/compare", async (CompareRequest request, ILogger<Program> logger, IArtifactRegistryService artifacts) =>
{
    try
    {
        // Get baseline data (run artifact, telemetry artifact, or fresh model execution)
        var baselineData = await GetInputData(request.Baseline, artifacts);
        
        // Get comparison data (run artifact, telemetry artifact, or fresh model execution)  
        var comparisonData = await GetInputData(request.Comparison, artifacts);
        
        // Align grids if needed (different time ranges, bin sizes)
        var (alignedBaseline, alignedComparison) = AlignTimeGrids(baselineData, comparisonData, request.Configuration);
        
        // Compute comparison metrics
        var metrics = ComputeComparisonMetrics(alignedBaseline, alignedComparison, request.Configuration.Metrics);
        
        // Generate comparison results artifact
        var comparisonResult = new CompareResult
        {
            SessionId = Guid.NewGuid().ToString(),
            Baseline = request.Baseline,
            Comparison = request.Comparison,
            Series = BuildComparisonSeries(alignedBaseline, alignedComparison),
            Metrics = metrics
        };
        
        // Create results artifact if requested
        if (request.Configuration.ExportResults)
        {
            var resultsArtifact = await CreateComparisonResultsArtifact(comparisonResult);
            comparisonResult.ResultsArtifactId = resultsArtifact.Id;
        }
        
        return Results.Ok(comparisonResult);
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Comparison failed");
        return Results.Problem($"Comparison failed: {ex.Message}");
    }
});

static async Task<RunData> GetInputData(CompareInput input, IArtifactRegistryService artifacts)
{
    return input.Type switch
    {
        "run" => await LoadRunArtifactData(input.ArtifactId, artifacts),
        "telemetry" => await LoadTelemetryArtifactData(input.ArtifactId, artifacts), 
        "model" => await ExecuteModelArtifact(input.ArtifactId, artifacts),
        _ => throw new InvalidOperationException($"Unsupported input type: {input.Type}")
    };
}
```

### **FR-M2.9-3: Charter Compare UI Components**
Implement Compare UI components following charter's contextual workflow approach.

**Compare Button Integration (Results Context):**
```csharp
// /Components/Results/RunResultsView.razor - Enhanced with Compare
<MudCard Elevation="2">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Analysis Results</MudText>
            <MudText Typo="Typo.body2">Run: @RunResult.RunId</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudButton Variant="Variant.Filled" 
                     Color="Color.Secondary"
                     StartIcon="@Icons.Material.Filled.Compare"
                     OnClick="StartCompareWorkflow">
                Compare
            </MudButton>
            <MudButton Variant="Variant.Outlined" 
                     StartIcon="@Icons.Material.Filled.Download"
                     OnClick="ShowExportOptions">
                Export
            </MudButton>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        @* Existing results visualization *@
        <RunVisualization Data="@RunResult" />
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public GraphRunResult RunResult { get; set; }
    [Inject] ICompareWorkflowService CompareService { get; set; }
    
    private async Task StartCompareWorkflow()
    {
        // Charter workflow: Start from current run as baseline
        var session = await CompareService.StartFromRunResultAsync(RunResult.RunId);
        
        // Navigate to Compare selection UI
        NavigationManager.NavigateTo($"/compare/{session.Id}");
    }
}
```

**Compare Selection Dialog (Contextual):**
```csharp
// /Components/Compare/CompareSelectionDialog.razor
<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-3">Select Comparison Input</MudText>
        <MudText Typo="Typo.body2" Class="mb-4">
            Choose what to compare against: <strong>@BaselineTitle</strong>
        </MudText>
        
        <MudTabs @bind-ActivePanelIndex="selectionMode" Elevation="1">
            <MudTabPanel Text="Artifacts" Icon="@Icons.Material.Filled.Storage">
                <MudPaper Class="pa-3 mt-3" Elevation="0">
                    <ArtifactSelector Types="@(new[] { "run", "telemetry" })"
                                    OnArtifactSelected="SelectArtifactForComparison" />
                </MudPaper>
            </MudTabPanel>
            
            <MudTabPanel Text="Fresh Model Run" Icon="@Icons.Material.Filled.PlayArrow">
                <MudPaper Class="pa-3 mt-3" Elevation="0">
                    <MudText Typo="Typo.body2" Class="mb-3">
                        Execute a model fresh for comparison:
                    </MudText>
                    <ArtifactSelector Types="@(new[] { "model" })"
                                    OnArtifactSelected="SelectModelForFreshExecution" />
                </MudPaper>
            </MudTabPanel>
            
            <MudTabPanel Text="Upload CSV" Icon="@Icons.Material.Filled.Upload">
                <MudPaper Class="pa-3 mt-3" Elevation="0">
                    <MudText Typo="Typo.body2" Class="mb-3">
                        Upload telemetry data for comparison:
                    </MudText>
                    <MudFileUpload T="IBrowserFile" Accept=".csv" OnFilesChanged="HandleCsvUpload">
                        <ButtonTemplate>
                            <MudButton HtmlTag="label" 
                                     Variant="Variant.Outlined" 
                                     Color="Color.Primary" 
                                     StartIcon="@Icons.Material.Filled.Upload"
                                     for="@context">
                                Upload CSV...
                            </MudButton>
                        </ButtonTemplate>
                    </MudFileUpload>
                </MudPaper>
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                 Variant="Variant.Filled" 
                 OnClick="StartComparison"
                 Disabled="@(selectedComparison == null)">
            Start Comparison
        </MudButton>
    </DialogActions>
</MudDialog>
```

**Compare Results View (Side-by-Side):**
```csharp
// /Pages/Compare.razor
@page "/compare/{SessionId}"

<MudContainer MaxWidth="MaxWidth.False">
    <MudText Typo="Typo.h4" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.Compare" Class="mr-2" />
        Comparison Results
    </MudText>
    
    @if (compareResult != null)
    {
        <MudGrid Spacing="3">
            @* Comparison Header *@
            <MudItem xs="12">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudGrid AlignItems="AlignItems.Center">
                        <MudItem xs="12" md="5">
                            <MudCard Outlined="true">
                                <MudCardContent Class="pa-3">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Baseline</MudText>
                                    <MudText Typo="Typo.h6">@compareResult.Baseline.Title</MudText>
                                    <MudText Typo="Typo.body2">@compareResult.Baseline.ArtifactType.ToUpper()</MudText>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                        <MudItem xs="12" md="2" Class="text-center">
                            <MudIcon Icon="@Icons.Material.Filled.CompareArrows" Size="Size.Large" Color="Color.Secondary" />
                        </MudItem>
                        <MudItem xs="12" md="5">
                            <MudCard Outlined="true">
                                <MudCardContent Class="pa-3">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Comparison</MudText>
                                    <MudText Typo="Typo.h6">@compareResult.Comparison.Title</MudText>
                                    <MudText Typo="Typo.body2">@compareResult.Comparison.ArtifactType.ToUpper()</MudText>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>
            
            @* Quantitative Metrics *@
            <MudItem xs="12">
                <MudPaper Class="pa-4" Elevation="1">
                    <MudText Typo="Typo.h6" Class="mb-3">Comparison Metrics</MudText>
                    <MudSimpleTable Elevation="0" Dense="true">
                        <thead>
                            <tr>
                                <th>Series</th>
                                <th>MAE</th>
                                <th>SMAPE (%)</th>
                                <th>Correlation</th>
                                <th>% Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var metric in compareResult.Metrics.SeriesMetrics)
                            {
                                <tr>
                                    <td><strong>@metric.Key</strong></td>
                                    <td>@metric.Value.MAE.ToString("F3")</td>
                                    <td>@(metric.Value.SMAPE * 100).ToString("F1")</td>
                                    <td>@metric.Value.Correlation.ToString("F3")</td>
                                    <td style="color: @GetChangeColor(metric.Value.PercentChange)">
                                        @metric.Value.PercentChange.ToString("+0.0%;-0.0%;0.0%")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </MudPaper>
            </MudItem>
            
            @* Side-by-Side Charts *@
            <MudItem xs="12">
                <MudPaper Class="pa-4" Elevation="1">
                    <MudText Typo="Typo.h6" Class="mb-3">Series Comparison</MudText>
                    @foreach (var seriesId in compareResult.Series.Keys)
                    {
                        <ComparisonChart SeriesId="@seriesId" 
                                       ComparisonData="@compareResult.Series[seriesId]" 
                                       Class="mb-4" />
                    }
                </MudPaper>
            </MudItem>
            
            @* Actions *@
            <MudItem xs="12">
                <MudStack Row Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                             Color="Color.Primary"
                             StartIcon="@Icons.Material.Filled.Download"
                             OnClick="ExportComparisonResults">
                        Export Results
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                             Color="Color.Secondary"
                             StartIcon="@Icons.Material.Filled.Compare"
                             OnClick="StartNewComparison">
                        New Comparison
                    </MudButton>
                    <MudButton Variant="Variant.Text" 
                             StartIcon="@Icons.Material.Filled.Save"
                             OnClick="SaveComparisonAsArtifact">
                        Save as Artifact
                    </MudButton>
                </MudStack>
            </MudItem>
        </MudGrid>
    }
    else if (isLoading)
    {
        <MudProgressCircular Indeterminate="true" />
        <MudText Class="ml-3">Computing comparison...</MudText>
    }
    else
    {
        <MudAlert Severity="Severity.Error">
            Comparison session not found or failed to load.
        </MudAlert>
    }
</MudContainer>
```

### **FR-M2.9-4: Artifacts Registry Compare Actions**
Integrate Compare workflow into M2.8 artifacts registry with contextual actions.

**Enhanced Artifact Cards with Compare:**
```csharp
// /Components/Artifacts/ArtifactCard.razor - Enhanced with Compare
<MudCardActions>
    @if (Artifact.Type == "run")
    {
        <MudButton Size="Size.Small" Color="Color.Primary" OnClick="() => OpenRunResults(Artifact.Id)">
            Results
        </MudButton>
        <MudButton Size="Size.Small" Color="Color.Secondary" OnClick="() => StartCompareFromArtifact(Artifact.Id)">
            Compare
        </MudButton>
        <MudButton Size="Size.Small" Color="Color.Tertiary" OnClick="() => ExportRunArtifact(Artifact.Id)">
            Export
        </MudButton>
    }
    else if (Artifact.Type == "telemetry")
    {
        <MudButton Size="Size.Small" Color="Color.Primary" OnClick="() => ReplayTelemetryArtifact(Artifact.Id)">
            Replay
        </MudButton>
        <MudButton Size="Size.Small" Color="Color.Secondary" OnClick="() => StartCompareFromArtifact(Artifact.Id)">
            Compare
        </MudButton>
        <MudButton Size="Size.Small" Color="Color.Tertiary" OnClick="() => ViewTelemetryDetails(Artifact.Id)">
            Details
        </MudButton>
    }
    else if (Artifact.Type == "model")
    {
        <MudButton Size="Size.Small" Color="Color.Primary" OnClick="() => RunModelArtifact(Artifact.Id)">
            Run
        </MudButton>
        <MudButton Size="Size.Small" Color="Color.Secondary" OnClick="() => CompareModelExecutions(Artifact.Id)">
            Compare
        </MudButton>
        <MudButton Size="Size.Small" Color="Color.Tertiary" OnClick="() => EditModelArtifact(Artifact.Id)">
            Edit
        </MudButton>
    }
</MudCardActions>

@code {
    [Parameter] public ArtifactSummary Artifact { get; set; }
    [Inject] ICompareWorkflowService CompareService { get; set; }
    
    private async Task StartCompareFromArtifact(string artifactId)
    {
        // Charter workflow: Start from artifact as baseline
        var session = await CompareService.StartFromArtifactAsync(artifactId);
        NavigationManager.NavigateTo($"/compare/{session.Id}");
    }
}
```

## Integration Points

### **M2.7 Artifacts Registry Integration**
- Compare workflow uses artifacts registry for input selection and baseline identification
- Comparison results can be saved as new artifacts in registry
- Artifact metadata enables proper comparison type validation (compatible grids, formats)

### **M2.6 Export System Integration**
- Compare results export using same format infrastructure (CSV, NDJSON, Parquet)
- Comparison artifacts include both raw results and formatted comparison metrics
- Export includes side-by-side data and quantitative metrics

### **M2.8 Charter UI Integration**  
- Compare launched contextually from Runs results view and Artifacts registry
- Compare selection dialog reuses M2.8 artifact browsing components
- Compare results integrate with charter navigation and artifact actions

### **Engine API Enhancement**
- Compare endpoints extend M2.6 export system with comparison logic
- Engine handles grid alignment for different time ranges and bin sizes
- Comparison metrics computed server-side for consistency and performance

## Acceptance Criteria

### **Compare Workflow Functionality**
- âœ… Compare can be launched from run results with one-click access
- âœ… Compare can be launched from any artifact in registry with contextual actions
- âœ… Input selection supports all artifact types (run, telemetry, model) and fresh execution
- âœ… Comparison handles different grid sizes and time ranges with proper alignment

### **Comparison Results Quality**
- âœ… Side-by-side visualization clearly shows baseline vs comparison data
- âœ… Quantitative metrics (MAE, SMAPE, correlation) computed correctly
- âœ… Visual design makes differences and similarities immediately apparent
- âœ… Results can be exported in all M2.6 formats with comparison metadata

### **Charter Workflow Compliance**
- âœ… Compare is contextual action, not separate analysis mode
- âœ… Input selection uses artifacts registry for all browsing and selection
- âœ… Comparison sessions are stateful and can be resumed/shared
- âœ… Results integrate seamlessly with charter navigation patterns

### **Performance & Reliability**
- âœ… Compare operations complete in reasonable time (< 30 seconds for typical data)
- âœ… Grid alignment handles edge cases without data corruption
- âœ… Comparison metrics are mathematically accurate and deterministic
- âœ… Error handling provides clear feedback for invalid comparisons

## Implementation Plan

### **Phase 1: Engine Compare Infrastructure (Week 1)**
1. **Compare API endpoints** in FlowTime Engine with artifact integration
2. **Grid alignment logic** for different time ranges and bin sizes
3. **Comparison metrics** computation (MAE, SMAPE, correlation)
4. **Artifact data loading** for all input types (run, telemetry, model)

### **Phase 2: Compare Workflow Service (Week 2)**
1. **ICompareWorkflowService implementation** with session management
2. **Compare session state** management and persistence
3. **Integration with M2.7 artifacts registry** for input selection
4. **Error handling and validation** for comparison compatibility

### **Phase 3: Charter UI Components (Week 3)**
1. **Compare button integration** in results views and artifact cards
2. **Compare selection dialog** with artifact browsing and upload
3. **Compare results view** with side-by-side visualization
4. **Comparison charts** and quantitative metrics display

### **Phase 4: Integration & Polish (Week 4)**
1. **Export integration** with M2.6 system for comparison results
2. **Performance optimization** for large comparison datasets
3. **User experience testing** for charter workflow compliance
4. **Documentation** and examples for comparison workflows

## Risk Mitigation

### **Grid Alignment Risk**
**Risk:** Comparing artifacts with different time grids produces incorrect results  
**Mitigation:**
- Robust grid alignment algorithm with validation
- Clear error messages for incompatible comparisons
- Option to resample data to common grid resolution

### **Performance Risk**
**Risk:** Large dataset comparisons cause UI timeouts or poor performance  
**Mitigation:**
- Server-side computation with proper timeout handling
- Streaming results for large comparisons
- Progress indicators for long-running operations

### **UI Complexity Risk**
**Risk:** Charter contextual workflow is confusing compared to dedicated comparison tool  
**Mitigation:**
- Clear visual cues for Compare actions and workflow states
- Consistent patterns across all Compare entry points
- User testing and iterative refinement

## Success Metrics

### **Charter Workflow Success**
- **Contextual usage**: 80%+ of comparisons launched from results or artifacts (not standalone)
- **Input diversity**: Users compare different artifact types (run vs telemetry, model vs run)
- **Workflow completion**: 90%+ of started comparisons complete successfully

### **Technical Success**
- **Performance**: Comparisons complete in < 30 seconds for datasets up to 10K points
- **Accuracy**: Comparison metrics match reference implementations (R/Python analytics)
- **Reliability**: Zero data corruption in grid alignment or metric computation

### **User Experience Success**
- **Discoverability**: Users find and use Compare actions without documentation
- **Clarity**: Comparison results clearly communicate differences and similarities
- **Integration**: Compare feels like natural part of charter workflow, not separate feature

---

## Next Steps

1. **M3.0-TELEMETRY-IMPORT**: Implement telemetry import to complete charter loop
2. **M3.1-OVERLAY**: Add scenario overlays for what-if analysis comparisons
3. **SIM-M3.0-CHARTER**: FlowTime-Sim alignment to support model artifact generation

This milestone completes the **core charter Compare workflow**, making FlowTime a true comparison platform where any artifact can be compared with any other artifact through contextual, intuitive UI actions.
