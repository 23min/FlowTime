# M-03.04 ‚Äî Run Orchestration APIs

**Status:** üìã Planned  
**Dependencies:** M-03.01 (Time-Travel State APIs), M-03.02 (Telemetry Capture + Templates), SIM-M-03.00 (Schema Foundations)  
**Target:** Expose `/v1/runs` orchestration and discovery endpoints so UI clients can create, list, and inspect telemetry-backed runs without relying on CLI tooling.

---

## Overview

Current time-travel workflows rely on CLI commands (`flowtime telemetry capture`, `flowtime telemetry bundle`, `flowtime run`) to stitch captured telemetry, templates, and canonical artifacts together. As noted in the status report (`docs/architecture/time-travel/status-2025-10-16.md`), the UI cannot self-serve telemetry runs because the API lacks run creation and listing endpoints. M-03.04 fills that gap by moving the orchestration logic server-side while we remain in the bootstrap phase without live ADX ingestion (`time-travel-planning-roadmap.md` ¬ßUI Contract).

This milestone delivers REST endpoints that:
- Create telemetry-mode runs from a template id, parameter payload, and optional captured bundle.
- Surface run metadata, provenance, and readiness for `/state` consumption.
- List available runs for UI selection and resume flows.

It explicitly reuses capture/bundle infrastructure from M-03.02 and keeps ADX adapters out of scope (deferred per planning decisions). Graph layout hints also remain deferred; the focus here is delivering the API surface the UI needs to unblock planning and playback.

---

## Scope

### In Scope ‚úÖ
1. `POST /v1/runs` orchestration that instantiates telemetry runs using FlowTime-Sim templates plus optional captured bundles.
2. `GET /v1/runs` paginated listing of available runs with summary metadata (mode, template, window, provenance hash, warning count).
3. `GET /v1/runs/{runId}` detail endpoint returning the manifest/metadata envelope necessary for UI hand-off.
4. Service abstractions that wrap existing capture/bundle components so the API can invoke them safely (dry-run support, progress logging).
5. Documentation and `.http` walkthroughs demonstrating end-to-end usage without CLI dependence.
6. CLI wrapper (`flowtime telemetry run`) that invokes the shared orchestration service for bootstrap scenarios.

### Out of Scope ‚ùå
- Live ADX ingestion or loader services (deferred to a future milestone).
- Graph layout metadata generation (tracked separately; UI still relies on standard charting for M-03.x).
- Enhancements to `/state` or `/state_window` payloads (handled in M-03.03 and beyond).
- CLI deprecation; CLI remains supported but becomes a thin wrapper over the new orchestration services (shared code) rather than issuing manual HTTP calls.

### Future Work (Post M-03.04)
- Integrate live telemetry adapters when prioritised.
- Add mutation endpoints for cancelling/regenerating runs.
- Automate topology layout hint generation once the visualization milestone is scheduled.

---

## Requirements

### Functional Requirements

#### FR1: Run Creation API
- **Description:** `POST /v1/runs` accepts template id, mode (`telemetry` or `simulation`), window/config parameters, and optional telemetry bundle reference.
- **Acceptance Criteria:**
  - [x] Request with template id + telemetry bundle path orchestrates capture (if required), template generation, and canonical artifact writing.
  - [x] Response returns run metadata (`runId`, `mode`, `template`, `schema`, `provenanceHash`, warning summary) and links to `/state`, `/state_window`.
  - [x] Validations enforce presence of window/timeline info and template contracts; errors use documented codes.
  - [x] Supports dry-run mode (`?dryRun=true`) that reports planned operations without writing files.

#### FR2: Run Listing
- **Description:** `GET /v1/runs` returns a paginated collection of run summaries sorted by creation time.
- **Acceptance Criteria:**
  - [x] Includes basic fields: `runId`, `mode`, `templateId`, `templateTitle`, `startUtc`, `duration`, `warnings`.
  - [x] Supports filters by `mode`, `templateId`, and `hasWarnings`.
  - [x] Pagination parameters (`page`, `pageSize`) validated; defaults documented.

#### FR3: Run Detail
- **Description:** `GET /v1/runs/{runId}` returns enriched metadata (storage paths, provenance hashes, available telemetry sources).
- **Acceptance Criteria:**
  - [x] Mirrors the metadata envelope consumed by `/state` (`StateMetadata`) and includes any bundle manifest warnings.
  - [x] Returns `404` with structured error when run is missing.
  - [x] Indicates readiness for `/state` via `canReplay` flag (true when artifacts exist).

#### FR4: Orchestration Service Layer
- **Description:** Introduce reusable orchestration services invoked by API and CLI.
- **Acceptance Criteria:**
  - [x] Encapsulates capture, template generation, and bundling with cancellation support.
  - [x] Emits structured logs (start, progress, completion, warnings) for observability.
  - [x] CLI commands reuse the service layer to avoid drift.

### Non-Functional Requirements
- **NFR1 (Performance):** Single run orchestration completes within 2√ó the CLI baseline (document baseline from existing `site` telemetry bundle).
- **NFR2 (Idempotency):** Repeated `POST /v1/runs` with `deterministicRunId=true` produces identical run ids and hashes.
- **NFR3 (Security):** Validate filesystem paths to prevent directory traversal; limit accessible directories to configured roots.
- **NFR4 (Observability):** Emit structured logs and metrics (`run_created`, `run_failed`, duration histogram); include runId, templateId, mode.

---

## Inputs, Outputs & Schemas

### Inputs
- Template definitions managed by FlowTime-Sim (`templates/*.yaml`).
- Optional telemetry capture directories containing `manifest.json` + CSVs from M-03.02.
- Request payloads containing window parameters, template overrides, and bundling options.
- Configuration for output roots (`FLOWTIME_DATA_DIR`, API app settings).

### Outputs
- Canonical run directories under `data/runs/<runId>/`.
- API responses: run metadata envelopes, paginated listings.
- Updated `.http` walkthroughs demonstrating API usage.

---

## Implementation Plan

### Phase 1: Service Abstractions
- Wrap existing capture/bundle logic in a `RunOrchestrationService` that handles dry-run, deterministic run ids, and provenance alignment.
- Introduce DTOs for run requests/responses under `FlowTime.Contracts`.
- Add configuration bindings for telemetry + run storage roots.

### Phase 2: API Endpoints
- Implement `POST /v1/runs`, `GET /v1/runs`, `GET /v1/runs/{runId}` in `FlowTime.API`.
- Add input validation, error handling, and logging aligned with existing `/state` patterns.
- Update CLI commands to call the new service layer to ensure parity.
  - Deliver `flowtime telemetry run` for parity with the new API surface.

### Phase 3: Tests, Docs, Observability
- Author unit tests for request validation, service orchestration, and metadata extraction.
- Add integration tests using fixture templates and telemetry bundles (reusing golden data from M-03.02).
- Capture golden responses for run creation/listing.
- Update docs: `FlowTime.API.http`, `docs/operations/telemetry-capture-guide.md`, status tracker.

---

## Test Plan

### Unit Tests
- `RunRequestValidatorTests` ‚Äî validates required fields, window bounds, template existence.
- `RunOrchestrationServiceTests` ‚Äî dry-run, deterministic id, warning propagation.
- `RunRepositoryTests` ‚Äî listing filters, pagination, metadata extraction.
- `TelemetryRunCommandTests` ‚Äî CLI wrapper parity with orchestration service.

### Integration Tests
- `RunApiTests.CreateTelemetryRun_ReturnsMetadata()` ‚Äî orchestrates a run using fixture bundle.
- `RunApiTests.ListRuns_FiltersByTemplateAndMode()` ‚Äî seeds indexed runs and asserts filtering.
- `RunApiTests.RunDetail_MirrorsStateMetadata()` ‚Äî ensures metadata matches `/state`.
- `RunApiTests.CreateRun_InvalidTemplate_Returns422()` ‚Äî exercises error handling.

### Golden Tests
- Approved JSON for `POST /v1/runs` response using the order-system fixture.
- Approved JSON for `GET /v1/runs` listing with multiple modes.

### Observability Verification
- Log capture asserting `run_created` and `run_failed` events.
- Optional metrics assertion via in-memory exporter (if available).

---

## Success Criteria
- [ ] `POST /v1/runs`, `GET /v1/runs`, `GET /v1/runs/{runId}` implemented with documented contracts.
- [ ] CLI commands reuse the orchestration service without behaviour drift.
- [ ] Integration and golden tests pass (`dotnet test FlowTime.sln`).
- [ ] Docs and `.http` examples updated; UI teams can create runs without CLI.
- [ ] Observability requirements satisfied (structured logs per request).

---

## File Impact Summary

- `src/FlowTime.API/Program.cs`, new handlers under `FlowTime.API/RunOrchestration`.
- `src/FlowTime.Core/TimeTravel/RunOrchestrationService.cs` (or equivalent namespace).
- `src/FlowTime.Contracts/TimeTravel/RunRequests.cs` & `RunMetadata.cs`.
- `src/FlowTime.Cli/Commands/*` (reusing orchestration).
- `tests/FlowTime.API.Tests/RunOrchestration/` (new integration suite).
- `docs/operations/telemetry-capture-guide.md`, `FlowTime.API.http`, `docs/architecture/time-travel/status-2025-10-16.md` (status update upon completion).

---

## References
- `docs/architecture/time-travel/status-2025-10-16.md`
- `docs/architecture/time-travel/time-travel-planning-roadmap.md`
- `docs/architecture/time-travel/time-travel-planning-decisions.md`
- `docs/architecture/time-travel/time-travel-architecture-ch3-components.md`
- `docs/architecture/time-travel/time-travel-architecture-ch5-implementation-roadmap.md`
