# M2.10 Task Tracker ‚Äî Provenance Query Support

**Branch:** `feature/api-m2.10/provenance-queries`  
**Status:** üîÑ In Progress (Phase 1c - CLI Implementation)  
**Started:** October 5, 2025  
**Current:** Architecture refactored - registry now shared between API and CLI!

---

## Quick Reference

- **Milestone Doc:** [`M2.10.md`](M2.10.md)
- **Test Strategy:** [`M2.10-TEST-STRATEGY.md`](M2.10-TEST-STRATEGY.md)
- **Total Estimated Effort:** 1-2 hours
- **Approach:** TDD (RED ‚Üí GREEN ‚Üí REFACTOR)

---

## Progress Overview

| Phase | Status | Time Spent | Notes |
|-------|--------|-----------|-------|
| **Phase 0: Tests (RED)** | ‚úÖ Complete | ~30 min | All test files created, RED state confirmed |
| **Phase 1: Implementation (GREEN)** | ‚úÖ Complete | ~90 min | All 8 API tests passing! Fixed async timing issue |
| **Phase 1b: Architecture Refactor** | ‚úÖ Complete | ~30 min | Moved registry to FlowTime.Contracts for code sharing |
| **Phase 1c: CLI Implementation** | üîÑ In Progress | - | Add `artifacts list` command using shared registry |
| **Phase 2: Refactor** | ‚è≥ Pending | - | Clean up code, extract duplicate logic |
| **Phase 3: Documentation** | ‚è≥ Pending | - | Update docs |

**Phase 1 Completion Notes (API):**
- ‚úÖ Provenance preserved as JsonElement in artifact metadata (not flattened to string)
- ‚úÖ Added TemplateId and ModelId properties to ArtifactQueryOptions
- ‚úÖ Implemented filtering in FileSystemArtifactRegistry.GetArtifactsAsync()
- ‚úÖ API endpoint parses templateId and modelId query parameters
- ‚úÖ Discovered fire-and-forget async registration issue: tests require explicit RebuildIndex() call
- ‚úÖ Used unique test IDs (test1-, test2-, etc.) to prevent cross-test contamination
- ‚úÖ All 8 API tests passing

**Phase 1b: Architecture Refactor ‚úÖ COMPLETE**
- ‚úÖ Moved `IArtifactRegistry` interface to `FlowTime.Contracts.Services`
- ‚úÖ Moved `FileSystemArtifactRegistry` implementation to `FlowTime.Contracts.Services`
- ‚úÖ Moved artifact models (`Artifact`, `RegistryIndex`, etc.) to `FlowTime.Contracts.Services`
- ‚úÖ Added Microsoft.Extensions dependencies to FlowTime.Contracts
- ‚úÖ Updated all API code to use new namespace (`FlowTime.Contracts.Services`)
- ‚úÖ Updated all tests to use new namespace
- ‚úÖ Deleted old files from FlowTime.API.Services and FlowTime.API.Models
- ‚úÖ Solution builds successfully
- ‚úÖ All tests pass (8/8 API provenance tests, 4 CLI tests still SKIPPED)
- ‚úÖ **Result:** CLI can now use FileSystemArtifactRegistry directly without API dependency

**Phase 1c: CLI Implementation (IN PROGRESS)**
- üîÑ Add `artifacts` command with `list` subcommand to Program.cs
- üîÑ Instantiate `FileSystemArtifactRegistry` directly (no HTTP calls!)
- üîÑ Support `--template-id` and `--model-id` flags
- üîÑ Format results as table (ID, Type, Created, Title)
- üîÑ Un-skip and implement all 4 CLI tests
- üîÑ Verify all 12 tests pass (8 API + 4 CLI)

---

## Phase 0: Write Failing Tests (RED State) ‚Äî 30 min

**Goal:** Write all tests that define expected behavior. All should fail initially.

### Core/Registry Tests (4 tests)

**File:** `tests/FlowTime.Api.Tests/Registry/ProvenanceFilterTests.cs`

- [x] **Test 1:** `Registry_ExtractsProvenanceFromManifest` - Registry correctly extracts provenance from manifest.json
- [x] **Test 2:** `Registry_IndexesProvenanceFields` - Provenance fields indexed properly in registry-index.json
- [x] **Test 3:** `GetArtifacts_FiltersByTemplateId` - Filter logic correctly matches provenance fields
- [x] **Test 4:** `GetArtifacts_WithTemplateIdFilter_ExcludesNullProvenance` - Null/missing provenance handled gracefully

**Create File:** ‚úÖ Created - Compilation errors as expected (no TemplateId property yet)

---

### API Tests (8 tests)

**File:** `tests/FlowTime.Api.Tests/Provenance/ProvenanceQueryTests.cs`

- [x] **Test 1:** `GetArtifacts_WithTemplateId_ReturnsMatchingArtifacts` - Query by templateId returns matching artifacts
- [x] **Test 2:** `GetArtifacts_WithModelId_ReturnsExactMatch` - Query by modelId returns exact match
- [x] **Test 3:** `GetArtifacts_WithTemplateIdAndModelId_ReturnsBothMatches` - Combined filters work correctly
- [x] **Test 4:** `GetArtifacts_WithNonExistentTemplateId_ReturnsEmptyResult` - Empty results when no matches found
- [x] **Test 5:** `GetArtifacts_TemplateIdCaseSensitive_NoMatch` - Case-sensitive matching behavior
- [x] **Test 6:** `GetArtifacts_WithTemplateIdAndPagination_ReturnsPagedResults` - Pagination works with provenance filters
- [x] **Test 7:** `GetArtifacts_WithTemplateIdAndSorting_ReturnsSortedResults` - Sorting works with provenance filters
- [x] **Test 8:** `GetArtifacts_WithTemplateId_ExcludesArtifactsWithoutProvenance` - Artifacts without provenance excluded

**Create File:** ‚úÖ Created - All tests compile and will fail during execution (RED state)

---

### CLI Tests (4 tests)

**File:** `tests/FlowTime.Cli.Tests/Commands/ProvenanceQueryTests.cs`

- [x] **Test 1:** `ArtifactsList_WithTemplateIdFlag_FiltersCorrectly` - `--template-id` filters correctly
- [x] **Test 2:** `ArtifactsList_WithModelIdFlag_FiltersCorrectly` - `--model-id` filters correctly
- [x] **Test 3:** `ArtifactsList_WithBothFlags_FiltersByBoth` - Combined filters work in CLI
- [x] **Test 4:** `ArtifactsList_WithTemplateIdFlag_OutputFormatCorrect` - Output formatting is correct

**Create File:** ‚úÖ Created - All tests marked as SKIPPED (CLI command doesn't exist yet)

**‚ö†Ô∏è NOTE:** The CLI `artifacts list` command doesn't exist yet. These tests are placeholders documenting expected behavior. The actual CLI command will need to be implemented as part of M2.10.

---

### Phase 0 Completion Criteria

- [x] All 16 test files created
- [x] Core/Registry tests created with compilation errors (expected - properties don't exist yet)
- [x] API tests created and compile (will fail during execution)
- [x] CLI tests created and marked as SKIPPED (command doesn't exist)
- [x] Run `dotnet test --filter "FullyQualifiedName~ProvenanceQuery"` - **Confirmed RED state**
  - FlowTime.Api.Tests: 2 compilation errors (ArtifactQueryOptions missing TemplateId property)
  - FlowTime.Cli.Tests: 4 tests SKIPPED (CLI command not implemented)
- [ ] Commit tests with message: `test(api,cli,core): add provenance query tests (RED state)`

**Status:** ‚úÖ Complete - Ready to commit

---

## Phase 1: Implementation (GREEN State) ‚Äî 30-60 min

**Goal:** Make all tests pass with minimal working code.

### Step 1: Update Core Data Models

- [ ] Add `TemplateId` property to `ArtifactQueryOptions`
- [ ] Add `ModelId` property to `ArtifactQueryOptions`
- [ ] Ensure proper serialization/deserialization
- [ ] Run core tests: `dotnet test tests/FlowTime.Tests/Registry/ProvenanceFilterTests.cs`

**Files to modify:**
- `src/FlowTime.Core/Artifacts/ArtifactQueryOptions.cs` (or similar)

---

### Step 2: Implement Registry Filter Logic

- [ ] Update `FileSystemArtifactRegistry.GetArtifactsAsync()` to filter by provenance
- [ ] Extract provenance from indexed metadata
- [ ] Apply templateId/modelId matching logic
- [ ] Handle missing/malformed provenance gracefully
- [ ] Run core tests again - should pass

**Files to modify:**
- `src/FlowTime.Core/Artifacts/FileSystemArtifactRegistry.cs` (or similar)

---

### Step 3: Update API Endpoint

- [ ] Add `templateId` query parameter to `/v1/artifacts` endpoint
- [ ] Add `modelId` query parameter to `/v1/artifacts` endpoint
- [ ] Map parameters to `ArtifactQueryOptions`
- [ ] Ensure backward compatibility (parameters optional)
- [ ] Run API tests: `dotnet test tests/FlowTime.Api.Tests/Provenance/ProvenanceQueryTests.cs`

**Files to modify:**
- `src/FlowTime.API/Program.cs` (Minimal APIs endpoint)

---

### Step 4: CLI Implementation (NOW IN SCOPE)

**Goal:** Add `artifacts list` command with provenance filtering support

#### 4.1: Command Structure
- [ ] Add `artifacts` command recognition to Program.cs
- [ ] Add `list` subcommand handler
- [ ] Parse `--template-id <id>` flag
- [ ] Parse `--model-id <id>` flag
- [ ] Parse `--api-url <url>` flag (default: http://localhost:8080)
- [ ] Add pagination support: `--limit <n>` and `--skip <n>` (optional)

#### 4.2: API Integration
- [ ] Create HttpClient to call `/v1/artifacts` endpoint
- [ ] Build query string with templateId/modelId parameters
- [ ] Handle HTTP errors gracefully (connection refused, 404, etc.)
- [ ] Parse JSON response

#### 4.3: Output Formatting
- [ ] Format artifacts as table with columns: ID, Type, Created, Title
- [ ] Add table header row
- [ ] Format timestamps for readability
- [ ] Add footer: "Total: N artifacts"
- [ ] Handle empty results gracefully

#### 4.4: Testing
- [ ] Remove `[Fact(Skip = "...")]` from all 4 tests in ProvenanceQueryTests.cs
- [ ] Update tests to actually execute CLI and verify output
- [ ] Run tests: `dotnet test --filter "FullyQualifiedName~Cli.Tests.Commands.ProvenanceQuery"`
- [ ] Verify all 4 CLI tests pass

**Files to modify:**
- `src/FlowTime.Cli/Program.cs` - Add command parsing and routing
- `tests/FlowTime.Cli.Tests/Commands/ProvenanceQueryTests.cs` - Remove Skip attribute, implement tests

**Implementation Notes:**
- Keep it simple: CLI just calls existing API endpoint
- API must be running (document this requirement)
- Use consistent table formatting with other CLI output
- Follow existing CLI patterns from `run` command

---

### Phase 1 Completion Criteria

- [ ] All 16 tests passing (GREEN state)
- [ ] Run full test suite: `dotnet test --filter "FullyQualifiedName~ProvenanceQuery"`
- [ ] Manual smoke test: Start API, query with `curl`
- [ ] Commit implementation: `feat(api,cli,core): implement provenance query support`

**Status:** ‚è≥ Not Started

---

## Phase 2: Refactor (REFACTOR) ‚Äî 15 min

**Goal:** Clean up and optimize implementation.

### Code Quality

- [ ] Remove duplicate filter logic
- [ ] Add XML documentation comments to public methods
- [ ] Ensure consistent error handling
- [ ] Verify logging for edge cases
- [ ] Check for any code smells

---

### Performance

- [ ] Verify filtering doesn't cause performance regression
- [ ] Ensure index data is used efficiently (no full file scans)
- [ ] Test with larger datasets if available

---

### Phase 2 Completion Criteria

- [ ] All tests still passing after refactoring
- [ ] Code review self-checklist complete
- [ ] Commit refactoring: `refactor(core): clean up provenance query logic`

**Status:** ‚è≥ Not Started

---

## Phase 3: Documentation & Validation ‚Äî 15 min

**Goal:** Document the feature and validate end-to-end.

### Documentation Updates

- [ ] Update API documentation with new query parameters
- [ ] Update CLI help text for `artifacts list` command
- [ ] Add usage examples to README or guides
- [ ] Update integration guides if needed

**Files to update:**
- API docs (if separate from code)
- CLI help text
- README.md or user guides

---

### Manual End-to-End Testing

- [ ] Start API: `dotnet run --project src/FlowTime.API`
- [ ] Test API query by templateId: `curl "http://localhost:8080/v1/artifacts?templateId=transportation-basic"`
- [ ] Test API query by modelId: `curl "http://localhost:8080/v1/artifacts?modelId=model_xyz"`
- [ ] Test CLI: `flowtime artifacts list --template-id transportation-basic`
- [ ] Test CLI: `flowtime artifacts list --model-id model_xyz`
- [ ] Test combined filters (API and CLI)
- [ ] Verify backward compatibility (existing queries work)

---

### Phase 3 Completion Criteria

- [ ] Documentation updated and reviewed
- [ ] Manual testing checklist complete
- [ ] All acceptance criteria met
- [ ] Commit docs: `docs(api,cli): document provenance query support`

**Status:** ‚è≥ Not Started

---

## Final Checklist

### Definition of Done

- [ ] All 16 tests written and initially failing (RED state)
- [ ] All 16 tests passing (GREEN state)
- [ ] Code refactored and optimized
- [ ] API accepts `templateId` and `modelId` query parameters
- [ ] CLI accepts `--template-id` and `--model-id` flags
- [ ] Empty results handled gracefully (no errors)
- [ ] Backward compatibility maintained
- [ ] Documentation updated
- [ ] Manual testing complete
- [ ] All commits follow conventional commits format
- [ ] Ready for PR review

---

## Commands Reference

```bash
# Run all provenance query tests
dotnet test --filter "FullyQualifiedName~ProvenanceQuery"

# Run only API tests
dotnet test tests/FlowTime.Api.Tests/Provenance/ProvenanceQueryTests.cs

# Run only CLI tests
dotnet test tests/FlowTime.Cli.Tests/Commands/ProvenanceQueryTests.cs

# Run only Core tests
dotnet test tests/FlowTime.Tests/Registry/ProvenanceFilterTests.cs

# Run with verbose output
dotnet test --filter "FullyQualifiedName~ProvenanceQuery" --logger "console;verbosity=detailed"

# Start API for manual testing
dotnet run --project src/FlowTime.API

# Build solution
dotnet build

# Full test suite
dotnet test
```

---

## Notes & Decisions

### Decision Log

- **2025-10-05:** Using TDD approach (RED ‚Üí GREEN ‚Üí REFACTOR)
- **2025-10-05:** Supporting both header and embedded provenance (per M2.9 architecture)
- **2025-10-05:** Case-sensitive matching for templateId and modelId
- **2025-10-05:** CLI `artifacts list` command does not exist yet - will need to be implemented as part of Phase 1
- **2025-10-05:** Registry tests placed in `tests/FlowTime.Api.Tests/Registry/` (alongside existing registry tests)

### Issues Encountered

**Issue #1: CLI Command Scope Expansion**
- **Problem:** The CLI doesn't have an `artifacts list` command yet. M2.10 assumes it exists.
- **Impact:** CLI tests are placeholders (SKIPPED). Phase 1 will need to implement the entire CLI command structure, not just add flags.
- **Decision:** Document this in tests and task tracker. CLI implementation is part of M2.10 scope.

---

**Task Tracker Status:** üîÑ Active  
**Current Phase:** Phase 1 (Implementation - GREEN State)  
**Last Updated:** October 5, 2025
