schemaVersion: 1
generator: flowtime-sim
metadata:
  id: 'network-reliability'
  title: 'Network Reliability with Queues and Retries'
  description: 'Edge gateway buffering, core retries, and stochastic infrastructure variation'
  version: 2.0.0
  captureKey: network-reliability-telemetry
  tags: [network, stochastic, queue, retries]
window:
  start: 2025-01-01T00:00:00Z
  timezone: UTC

parameters:
  - name: bins
    type: integer
    title: "Time Periods"
    description: "Number of 5-minute bins (24h default)"
    default: 288
    minimum: 12
    maximum: 288
  - name: binSize
    type: integer
    title: "Bin Size (minutes)"
    description: "Duration of each bin"
    default: 5
    minimum: 5
    maximum: 60
  - name: retryRate
    type: number
    title: "Core Retry Rate"
    description: "Fraction of dispatched requests that retry at the core"
    default: 0.15
    minimum: 0.0
    maximum: 1.0
  - name: retryFailureRate
    type: number
    title: "Failed Retry Rate"
    description: "Probability that a retry still fails"
    default: 0.3
    minimum: 0.0
    maximum: 1.0
  - name: telemetryBaseLoadSource
    type: string
    title: "Telemetry base load source"
    description: "Optional file:// URI for observed request load"
    default: ""

grid:
  bins: ${bins}
  binSize: ${binSize}
  binUnit: minutes

rng:
  kind: pcg32
  seed: 20250331

topology:
  nodes:
    - id: EdgeGateway
      kind: service
      semantics:
        arrivals: base_requests
        served: network_requests
        errors: network_failures
        capacity: edge_capacity
        processingTimeMsSum: edge_gateway_processing_time_ms_sum
        servedCount: network_requests
        aliases:
          arrivals: "Incoming requests"
          served: "Requests routed"
          errors: "Network drops"
    - id: RequestQueue
      kind: queue
      semantics:
        arrivals: request_queue_demand
        served: request_queue_served
        errors: request_queue_attrition
        queueDepth: request_queue_depth
        aliases:
          arrivals: "Effective demand"
          served: "Requests dequeued"
          errors: "Queue attrition"
          queue: "Edge backlog"
      initialCondition:
        queueDepth: 40
    - id: CorePlatform
      kind: service
      semantics:
        arrivals: request_queue_served
        served: successful_requests
        errors: core_errors
        capacity: server_capacity
        attempts: core_attempts
        failures: core_retry_failures
        retryEcho: core_retry_echo
        retryKernel: [0.0, 0.6, 0.3, 0.1]
        processingTimeMsSum: core_platform_processing_time_ms_sum
        servedCount: successful_requests
        aliases:
          served: "Requests fulfilled"
          errors: "Core failures"
          attempts: "Dispatch attempts"
          failures: "Failed retries"
          retryEcho: "Retry backlog"
    - id: EdgeDropQueue
      kind: queue
      semantics:
        arrivals: edge_drop_inflow
        served: edge_drop_served_zero
        errors: edge_drop_attrition
        queueDepth: edge_drop_depth
        aliases:
          arrivals: "Edge drops"
          queue: "Edge loss backlog"
      initialCondition:
        queueDepth: 0
    - id: CoreDlq
      kind: dlq
      semantics:
        arrivals: core_dlq_inflow
        served: core_dlq_served_zero
        errors: core_dlq_attrition
        queueDepth: core_dlq_depth
        aliases:
          arrivals: "Core exhausted retries"
          queue: "Core DLQ"
      initialCondition:
        queueDepth: 0
    - id: DatabaseLossQueue
      kind: queue
      semantics:
        arrivals: database_failures
        served: database_loss_served_zero
        errors: database_loss_attrition
        queueDepth: database_loss_depth
        aliases:
          arrivals: "DB failures"
          queue: "Database loss"
      initialCondition:
        queueDepth: 0
  edges:
    - id: edge_to_queue
      from: EdgeGateway:out
      to: RequestQueue:in
    - id: queue_to_core
      from: RequestQueue:out
      to: CorePlatform:in
    - id: edge_to_drop
      from: EdgeGateway:errors
      to: EdgeDropQueue:arrivals
      type: terminal
      measure: errors
    - id: core_to_dlq
      from: CorePlatform:failures
      to: CoreDlq:arrivals
      type: terminal
      measure: failures
    - id: db_to_loss
      from: CorePlatform:errors
      to: DatabaseLossQueue:arrivals
      type: terminal
      measure: errors

nodes:
  - id: base_requests
    kind: pmf
    source: ${telemetryBaseLoadSource}
    pmf:
      values: [60, 90, 120, 150, 180, 210]
      probabilities: [0.08, 0.18, 0.28, 0.24, 0.15, 0.07]
    profile:
      kind: builtin
      name: hub-rush-hour

  - id: network_reliability
    kind: pmf
    pmf:
      values: [1.0, 0.95, 0.8, 0.6, 0.3]
      probabilities: [0.7, 0.2, 0.06, 0.03, 0.01]
    profile:
      kind: builtin
      name: three-shift

  - id: server_performance
    kind: pmf
    pmf:
      values: [0.8, 1.0, 1.2]
      probabilities: [0.1, 0.8, 0.1]
    profile:
      kind: builtin
      name: three-shift

  - id: edge_capacity
    kind: pmf
    pmf:
      values: [140, 170, 200, 230, 260]
      probabilities: [0.08, 0.22, 0.3, 0.25, 0.15]
    profile:
      kind: builtin
      name: hub-rush-hour

  - id: database_reliability
    kind: pmf
    pmf:
      values: [1.0, 0.9, 0.7, 0.5]
      probabilities: [0.85, 0.1, 0.04, 0.01]
    profile:
      kind: builtin
      name: three-shift

  - id: network_requests
    kind: expr
    expr: "base_requests * MIN(network_reliability, 1)"

  - id: network_failures
    kind: expr
    expr: "MAX(0, base_requests - network_requests)"

  - id: edge_gateway_processing_time_ms_sum
    kind: expr
    expr: "network_requests * 120"

  - id: server_capacity
    kind: expr
    expr: "180 * server_performance"

  - id: request_queue_carry_raw
    kind: expr
    expr: "CONV(network_requests - server_capacity, [1.0, 0.5, 0.25])"

  - id: request_queue_carry
    kind: expr
    expr: "MAX(0, request_queue_carry_raw)"

  - id: request_queue_demand
    kind: expr
    expr: "network_requests + request_queue_carry"

  - id: request_queue_attrition
    kind: expr
    expr: "MIN(request_queue_carry, request_queue_carry * 0.01)"

  - id: request_queue_served
    kind: expr
    expr: "MIN(server_capacity, request_queue_demand)"

  - id: request_queue_depth
    kind: backlog
    inflow: request_queue_demand
    outflow: request_queue_served
    loss: request_queue_attrition

  - id: core_retry_attempts
    kind: expr
    expr: "${retryRate} * request_queue_served"

  - id: core_attempts
    kind: expr
    expr: "request_queue_served + core_retry_attempts"

  - id: core_retry_failures
    kind: expr
    expr: "${retryFailureRate} * core_retry_attempts"

  - id: server_processed
    kind: expr
    expr: "MIN(core_attempts, server_capacity)"

  - id: core_processed
    kind: expr
    expr: "MIN(request_queue_served, MAX(0, server_processed - core_retry_failures))"

  - id: core_errors
    kind: expr
    expr: "MAX(0, request_queue_served - core_processed)"

  - id: core_retry_echo
    kind: expr
    expr: "CONV(core_retry_attempts, [0.0, 0.6, 0.3, 0.1])"

  - id: successful_requests
    kind: expr
    expr: "core_processed * MIN(database_reliability, 1)"

  - id: database_failures
    kind: expr
    expr: "MAX(0, core_processed - successful_requests)"

  - id: core_platform_processing_time_ms_sum
    kind: expr
    expr: "successful_requests * 220"

  - id: system_reliability
    kind: expr
    expr: "successful_requests / base_requests"

  - id: edge_drop_inflow
    kind: expr
    expr: "network_failures"

  - id: edge_drop_served_zero
    kind: expr
    expr: "0"
    metadata:
      graph.hidden: "true"

  - id: edge_drop_attrition
    kind: expr
    expr: "0"

  - id: edge_drop_depth
    kind: backlog
    inflow: edge_drop_inflow
    outflow: edge_drop_served_zero
    loss: edge_drop_attrition

  - id: core_dlq_inflow
    kind: expr
    expr: "core_retry_failures"

  - id: core_dlq_served_zero
    kind: expr
    expr: "0"
    metadata:
      graph.hidden: "true"

  - id: core_dlq_attrition
    kind: expr
    expr: "0"

  - id: core_dlq_depth
    kind: backlog
    inflow: core_dlq_inflow
    outflow: core_dlq_served_zero
    loss: core_dlq_attrition

  - id: database_loss_served_zero
    kind: expr
    expr: "0"
    metadata:
      graph.hidden: "true"

  - id: database_loss_attrition
    kind: expr
    expr: "0"

  - id: database_loss_depth
    kind: backlog
    inflow: database_failures
    outflow: database_loss_served_zero
    loss: database_loss_attrition

outputs:
  - series: base_requests
    as: base_requests.csv
  - series: request_queue_depth
    as: edge_queue_depth.csv
  - series: successful_requests
    as: successful_requests.csv
  - series: core_errors
    as: core_failures.csv
  - series: database_failures
    as: database_failures.csv
  - series: system_reliability
    as: system_reliability.csv
  - series: edge_drop_depth
    as: edge_drop_backlog.csv
  - series: core_dlq_depth
    as: core_dlq_backlog.csv
  - series: database_loss_depth
    as: database_loss_backlog.csv
