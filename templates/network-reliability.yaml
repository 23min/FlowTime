schemaVersion: 1
generator: flowtime-sim
metadata:
  id: 'network-reliability'
  title: 'Network Reliability with Stochastic Failures'
  description: 'Demonstrates PMF nodes and RNG for probabilistic network behavior modeling'
  version: 1.0.0
  captureKey: network-reliability-telemetry
  tags: [advanced, probabilistic, rng, network, stochastic]
window:
  start: 2025-01-01T00:00:00Z
  timezone: UTC

parameters:
  - name: bins
    type: integer
    title: "Time Periods"
    description: "Number of time periods to simulate"
    default: 12
    minimum: 1
    maximum: 48
  - name: binSize
    type: integer
    title: "Period Duration"
    description: "Duration of each time period in minutes"
    default: 60
    minimum: 15
    maximum: 480
  - name: rngSeed
    type: integer
    title: "Random Number Generator Seed"
    description: "Seed for reproducible random behavior"
    default: 42
    minimum: 1
    maximum: 2147483647
  - name: baseLoad
    type: array
    title: "Base Request Load"
    description: "Expected requests per time period"
    default: [100, 120, 150, 180, 200, 190, 170, 160, 140, 130, 110, 105]
    minimum: 0
    maximum: 1000
  - name: serverBaseCapacity
    type: integer
    title: "Server Base Capacity"
    description: "Base server capacity before performance variations"
    default: 150
    minimum: 50
    maximum: 500
  - name: telemetryBaseLoadSource
    type: string
    title: "Telemetry base load source"
    description: "Optional file:// URI for observed request load when replaying telemetry"
    default: ""

grid:
  bins: ${bins}
  binSize: ${binSize}
  binUnit: minutes

rng:
  kind: pcg32
  seed: ${rngSeed}

topology:
  nodes:
    - id: EdgeGateway
      kind: service
      semantics:
        arrivals: base_requests
        served: network_requests
        errors: network_failures
        processingTimeMsSum: edge_gateway_processing_time_ms_sum
        servedCount: network_requests
    - id: CorePlatform
      kind: service
      semantics:
        arrivals: network_requests
        served: successful_requests
        errors: database_failures
        processingTimeMsSum: core_platform_processing_time_ms_sum
        servedCount: successful_requests
  edges:
    - id: edge1
      from: EdgeGateway:out
      to: CorePlatform:in

nodes:
  # Base request load (deterministic pattern)
  - id: base_requests
    kind: const
    values: ${baseLoad}
    source: ${telemetryBaseLoadSource}
    
  # Network reliability (stochastic failures)
  - id: network_reliability
    kind: pmf
    pmf:
      values: [1.0, 0.95, 0.8, 0.6, 0.3]
      probabilities: [0.7, 0.2, 0.06, 0.03, 0.01]
      
  # Server performance variation (load-dependent capacity)
  - id: server_performance
    kind: pmf  
    pmf:
      values: [0.8, 1.0, 1.2]
      probabilities: [0.1, 0.8, 0.1]
      
  # Database connection reliability
  - id: database_reliability
    kind: pmf
    pmf:
      values: [1.0, 0.9, 0.7, 0.5]
      probabilities: [0.85, 0.1, 0.04, 0.01]
    
  # Requests that reach the server (after network failures)
  - id: network_requests
    kind: expr
    expr: "base_requests * network_reliability"

  - id: edge_gateway_processing_time_ms_sum
    kind: expr
    expr: "network_requests * 120"

  # Available server capacity (with performance variations)
  - id: server_capacity
    kind: expr
    expr: "${serverBaseCapacity} * server_performance"
    
  # Requests that can be processed by server
  - id: server_processed
    kind: expr
    expr: "MIN(network_requests, server_capacity)"
    
  # Requests that successfully complete (after database failures)
  - id: successful_requests
    kind: expr
    expr: "server_processed * database_reliability"

  - id: core_platform_processing_time_ms_sum
    kind: expr
    expr: "successful_requests * 220"

  # Failed requests due to network issues
  - id: network_failures
    kind: expr
    expr: "base_requests - network_requests"
    
  # Failed requests due to server capacity
  - id: server_failures
    kind: expr
    expr: "network_requests - server_processed"
    
  # Failed requests due to database issues
  - id: database_failures
    kind: expr
    expr: "server_processed - successful_requests"
    
  # Overall system reliability
  - id: system_reliability
    kind: expr
    expr: "successful_requests / base_requests"

outputs:
  - series: base_requests
    as: base_requests.csv
    description: "Original incoming requests"
  - series: successful_requests
    as: successful_requests.csv
    description: "Successfully processed requests"
  - series: network_failures
    as: network_failures.csv
    description: "Requests lost due to network issues"
  - series: server_failures
    as: server_failures.csv
    description: "Requests lost due to server capacity"
  - series: database_failures
    as: database_failures.csv
    description: "Requests lost due to database issues"
  - series: system_reliability
    as: system_reliability.csv
    description: "Overall system success rate"
