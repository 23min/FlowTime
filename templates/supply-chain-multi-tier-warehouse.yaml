schemaVersion: 1
generator: flowtime-sim
metadata:
  id: 'supply-chain-multi-tier-warehouse'
  title: 'Multi-Tier Supply Chain with Warehouse'
  description: 'Supply chain with explicit warehouse buffer (stock build and drawdown), conserving flow on SLA channels'
  version: 1.0.0
  captureKey: supply-chain-multi-tier-warehouse-telemetry
  tags: [advanced, supply-chain, multi-tier, warehouse, inventory, logistics]
window:
  start: 2025-01-01T00:00:00Z
  timezone: UTC

parameters:
  - name: bins
    type: integer
    title: "Time Periods"
    description: "Number of time periods to simulate"
    default: 6
    minimum: 3
    maximum: 288
  - name: binSize
    type: integer
    title: "Period Duration"
    description: "Duration of each time period in minutes"
    default: 60
    minimum: 15
    maximum: 480
  - name: demandPattern
    type: array
    title: "Customer Demand Pattern"
    description: "Customer demand volume per time period"
    default: [80, 120, 160, 140, 100, 60]
    minimum: 0
    maximum: 5000
  - name: supplierCapacity
    type: array
    title: "Supplier Capacity"
    description: "Supplier production capacity per time period"
    default: [200, 200, 200, 200, 200, 200]
    minimum: 1
    maximum: 5000
  - name: distributorCapacity
    type: array
    title: "Distributor Capacity"
    description: "Distribution center capacity per time period"
    default: [150, 150, 150, 150, 150, 150]
    minimum: 1
    maximum: 5000
  - name: retailerCapacity
    type: array
    title: "Retailer Capacity"
    description: "Retail outlet capacity per time period"
    default: [120, 120, 120, 120, 120, 120]
    minimum: 1
    maximum: 5000
  - name: bufferSize
    type: number
    title: "Buffer Size Multiplier"
    description: "Planned production multiplier (e.g., 1.2 = 20% build-ahead into warehouse)"
    default: 1.2
    minimum: 1.0
    maximum: 3.0
  - name: initialStock
    type: number
    title: "Initial Warehouse Stock"
    description: "Initial inventory units available in the warehouse (bin 0)"
    default: 0
    minimum: 0
    maximum: 100000
  - name: telemetryDemandSource
    type: string
    title: "Telemetry customer demand source"
    description: "Optional file:// URI for customer demand when replaying telemetry"
    default: ""

grid:
  bins: ${bins}
  binSize: ${binSize}
  binUnit: minutes

topology:
  nodes:
    - id: Supplier
      kind: service
      semantics:
        arrivals: planned_production
        served: supplier_shipments
        errors: supplier_shortage
        processingTimeMsSum: supplier_processing_time_ms_sum
        servedCount: supplier_shipments
    - id: Warehouse
      kind: service
      semantics:
        arrivals: supplier_shipments
        served: warehouse_shipments
        errors: inventory_build
        processingTimeMsSum: warehouse_processing_time_ms_sum
        servedCount: warehouse_shipments
    - id: Distributor
      kind: service
      semantics:
        arrivals: warehouse_shipments
        served: distributed_items
        errors: distributor_backlog
        processingTimeMsSum: distributor_processing_time_ms_sum
        servedCount: distributed_items
    - id: Retailer
      kind: service
      semantics:
        arrivals: distributed_items
        served: retail_sales
        errors: unmet_demand
        processingTimeMsSum: retailer_processing_time_ms_sum
        servedCount: retail_sales
  edges:
    - id: e1
      from: Supplier:out
      to: Warehouse:in
    - id: e2
      from: Warehouse:out
      to: Distributor:in
    - id: e3
      from: Distributor:out
      to: Retailer:in

nodes:
  # External demand
  - id: customer_demand
    kind: const
    values: ${demandPattern}
    source: ${telemetryDemandSource}

  # Capacities
  - id: supplier_capacity
    kind: const
    values: ${supplierCapacity}
  - id: distributor_capacity
    kind: const
    values: ${distributorCapacity}
  - id: retailer_capacity
    kind: const
    values: ${retailerCapacity}

  # Planning and shipments
  - id: planned_production
    kind: expr
    expr: "MIN(customer_demand * ${bufferSize}, supplier_capacity)"

  - id: supplier_shipments
    kind: expr
    expr: "planned_production"

  - id: supplier_processing_time_ms_sum
    kind: expr
    expr: "supplier_shipments * 180"

  # Downstream pull and availability
  - id: downstream_cap
    kind: expr
    expr: "MIN(distributor_capacity, retailer_capacity)"

  - id: requested_shipments
    kind: expr
    expr: "MIN(customer_demand, retailer_capacity)"

  - id: warehouse_shipments
    kind: expr
    expr: "MIN(supplier_shipments, requested_shipments)"

  - id: warehouse_processing_time_ms_sum
    kind: expr
    expr: "warehouse_shipments * 240"

  # Per-bin inventory delta (build-ahead not yet shipped this bin)
  - id: warehouse_stock_delta
    kind: expr
    expr: "MAX(0, supplier_shipments - warehouse_shipments)"

  # Downstream flows
  - id: distributed_items
    kind: expr
    expr: "MIN(warehouse_shipments, distributor_capacity)"

  - id: distributor_processing_time_ms_sum
    kind: expr
    expr: "distributed_items * 210"

  - id: retail_sales
    kind: expr
    expr: "MIN(distributed_items, retailer_capacity)"

  - id: retailer_processing_time_ms_sum
    kind: expr
    expr: "retail_sales * 260"

  # Diagnostics
  - id: supplier_shortage
    kind: expr
    expr: "MAX(0, customer_demand - supplier_shipments)"

  - id: distributor_backlog
    kind: expr
    expr: "MAX(0, warehouse_shipments - distributed_items)"

  - id: unmet_demand
    kind: expr
    expr: "MAX(0, customer_demand - retail_sales)"

  - id: supply_efficiency
    kind: expr
    expr: "retail_sales / customer_demand"

  - id: inventory_build
    kind: expr
    expr: "MAX(0, supplier_shipments - warehouse_shipments)"

  - id: warehouse_overflow
    kind: expr
    expr: "0"

outputs:
  - series: customer_demand
    as: demand.csv
  - series: planned_production
    as: planned_production.csv
  - series: supplier_shipments
    as: supplier_shipments.csv
  - series: warehouse_stock_delta
    as: warehouse_stock_delta.csv
  - series: warehouse_shipments
    as: warehouse_shipments.csv
  - series: distributed_items
    as: distributed.csv
  - series: retail_sales
    as: sales.csv
  - series: unmet_demand
    as: stockouts.csv
  - series: supply_efficiency
    as: efficiency.csv
  - series: inventory_build
    as: inventory_build.csv
