schemaVersion: 1
generator: flowtime-sim
metadata:
  id: 'it-system-microservices'
  title: 'IT System with Microservices'
  description: 'Modern web application with request queues, load balancer, auth service, and database bottlenecks'
  version: 1.0.0
  captureKey: it-system-telemetry
  tags: [intermediate, microservices, web-scale, modern, it-systems]
window:
  start: 2025-01-01T00:00:00Z
  timezone: UTC

parameters:
  - name: bins
    type: integer
    title: "Time Periods"
    description: "Number of time periods to simulate"
    default: 6
    minimum: 3
    maximum: 48
  - name: binSize
    type: integer
    title: "Period Duration"
    description: "Duration of each time period in minutes"
    default: 60
    minimum: 15
    maximum: 480
  - name: requestPattern
    type: array
    title: "User Request Pattern"
    description: "Number of requests per time period"
    default: [100, 150, 200, 180, 120, 80]
    minimum: 0
    maximum: 10000
  - name: loadBalancerCapacity
    type: array
    title: "Load Balancer Capacity"
    description: "Load balancer throughput per time period"
    default: [300, 300, 300, 300, 300, 300]
    minimum: 1
    maximum: 10000
  - name: authCapacity
    type: array
    title: "Auth Service Capacity"
    description: "Authentication service throughput per time period"
    default: [250, 250, 250, 250, 250, 250]
    minimum: 1
    maximum: 10000
  - name: databaseCapacity
    type: array
    title: "Database Capacity"
    description: "Database query capacity per time period"
    default: [180, 180, 180, 180, 180, 180]
    minimum: 1
    maximum: 10000
  - name: telemetryRequestsSource
    type: string
    title: "Telemetry requests source"
    description: "Optional file:// URI when replaying telemetry"
    default: ""

grid:
  bins: ${bins}
  binSize: ${binSize}
  binUnit: minutes

topology:
  nodes:
    - id: LoadBalancer
      kind: service
      semantics:
        arrivals: user_requests
        served: load_balanced_requests
        errors: failed_requests
        processingTimeMsSum: load_balancer_processing_time_ms_sum
        servedCount: load_balanced_requests
        aliases:
          arrivals: "User requests"
          served: "Requests routed"
          errors: "Dropped requests"
    - id: IngressQueue
      kind: queue
      semantics:
        arrivals: load_balanced_requests
        served: auth_queue_outflow
        errors: auth_queue_spill
        queueDepth: ingress_queue_depth
        aliases:
          arrivals: "Routed requests"
          served: "Requests dequeued"
          errors: "Queue attrition"
          queue: "Ingress backlog"
      initialCondition:
        queueDepth: 0
    - id: AuthService
      kind: service
      semantics:
        arrivals: auth_queue_outflow
        served: authenticated_requests
        errors: failed_requests
        processingTimeMsSum: auth_processing_time_ms_sum
        servedCount: authenticated_requests
        aliases:
          arrivals: "Routed requests"
          served: "Sessions authenticated"
          errors: "Auth failures"
    - id: Database
      kind: service
      semantics:
        arrivals: authenticated_requests
        served: processed_requests
        errors: failed_requests
        processingTimeMsSum: database_processing_time_ms_sum
        servedCount: processed_requests
        aliases:
          arrivals: "Auth passes"
          served: "Queries committed"
          errors: "Query failures"
  edges:
    - id: edge1
      from: LoadBalancer:out
      to: IngressQueue:in
    - id: edge2
      from: IngressQueue:out
      to: AuthService:in
    - id: edge3
      from: AuthService:out
      to: Database:in

nodes:
  - id: user_requests
    kind: const
    values: ${requestPattern}
    source: ${telemetryRequestsSource}

  - id: load_balancer_capacity
    kind: const
    values: ${loadBalancerCapacity}

  - id: auth_capacity
    kind: const
    values: ${authCapacity}

  - id: database_capacity
    kind: const
    values: ${databaseCapacity}

  - id: load_balanced_requests
    kind: expr
    expr: "MIN(user_requests, load_balancer_capacity)"

  - id: load_balancer_processing_time_ms_sum
    kind: expr
    expr: "load_balanced_requests * 150"

  - id: auth_queue_outflow
    kind: expr
    expr: "MIN(load_balanced_requests, auth_capacity)"

  - id: auth_queue_spill
    kind: expr
    expr: "0"

  - id: ingress_queue_depth
    kind: backlog
    inflow: load_balanced_requests
    outflow: auth_queue_outflow
    loss: auth_queue_spill

  - id: authenticated_requests
    kind: expr
    expr: "auth_queue_outflow"

  - id: auth_processing_time_ms_sum
    kind: expr
    expr: "authenticated_requests * 220"

  - id: processed_requests
    kind: expr
    expr: "MIN(authenticated_requests, database_capacity)"

  - id: database_processing_time_ms_sum
    kind: expr
    expr: "processed_requests * 320"

  - id: failed_requests
    kind: expr
    expr: "user_requests - processed_requests"

  - id: system_utilization
    kind: expr
    expr: "processed_requests / user_requests"

outputs:
  - series: user_requests
    as: requests.csv
  - series: processed_requests
    as: processed.csv
  - series: failed_requests
    as: failures.csv
  - series: ingress_queue_depth
    as: ingress_queue_depth.csv
  - series: system_utilization
    as: utilization.csv
