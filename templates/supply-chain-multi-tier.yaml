schemaVersion: 1
generator: flowtime-sim
metadata:
  id: 'supply-chain-multi-tier'
  title: 'Multi-Tier Supply Chain'
  description: 'Complex supply chain with suppliers, distributors, retailers, and demand variability'
  version: 1.0.0
  captureKey: supply-chain-multi-tier-telemetry
  tags: [advanced, supply-chain, multi-tier, variability, logistics]
window:
  start: 2025-01-01T00:00:00Z
  timezone: UTC

parameters:
  - name: bins
    type: integer
    title: "Time Periods"
    description: "Number of time periods to simulate"
    default: 6
    minimum: 3
    maximum: 288
  - name: binSize
    type: integer
    title: "Period Duration"
    description: "Duration of each time period in minutes"
    default: 60
    minimum: 15
    maximum: 480
  - name: demandPattern
    type: array
    title: "Customer Demand Pattern"
    description: "Customer demand volume per time period"
    default: [80, 120, 160, 140, 100, 60]
    minimum: 0
    maximum: 5000
  - name: supplierCapacity
    type: array
    title: "Supplier Capacity"
    description: "Supplier production capacity per time period"
    default: [200, 200, 200, 200, 200, 200]
    minimum: 1
    maximum: 5000
  - name: distributorCapacity
    type: array
    title: "Distributor Capacity"
    description: "Distribution center capacity per time period"
    default: [150, 150, 150, 150, 150, 150]
    minimum: 1
    maximum: 5000
  - name: retailerCapacity
    type: array
    title: "Retailer Capacity"
    description: "Retail outlet capacity per time period"
    default: [120, 120, 120, 120, 120, 120]
    minimum: 1
    maximum: 5000
  - name: bufferSize
    type: number
    title: "Buffer Size Multiplier"
    description: "Safety stock buffer as multiplier of demand (deprecated in this base template; use the warehouse variant to model buffers)"
    default: 1.0
    minimum: 1.0
    maximum: 3.0
  - name: telemetryDemandSource
    type: string
    title: "Telemetry customer demand source"
    description: "Optional file:// URI for customer demand when replaying telemetry"
    default: ""

grid:
  bins: ${bins}
  binSize: ${binSize}
  binUnit: minutes

topology:
  nodes:
    - id: Supplier
      kind: service
      semantics:
        arrivals: customer_demand
        served: supplied_items
        errors: supplier_shortage
        processingTimeMsSum: supplier_processing_time_ms_sum
        servedCount: supplied_items
        aliases:
          arrivals: "Customer demand"
          served: "Units supplied"
          errors: "Supplier shortage"
    - id: DistributorQueue
      kind: queue
      semantics:
        arrivals: queue_inflow
        served: queue_outflow
        errors: queue_errors
        queueDepth: queue_depth
        aliases:
          arrivals: "Supply inflow"
          served: "Loads released"
          queue: "Staged loads"
          errors: "Overflow"
    - id: Distributor
      kind: service
      semantics:
        arrivals: queue_outflow
        served: distributed_items
        errors: distributor_backlog
        processingTimeMsSum: distributor_processing_time_ms_sum
        servedCount: distributed_items
        aliases:
          served: "Units shipped"
          errors: "Distributor backlog"
    - id: Retailer
      kind: service
      semantics:
        arrivals: distributed_items
        served: retail_sales
        errors: unmet_demand
        processingTimeMsSum: retailer_processing_time_ms_sum
        servedCount: retail_sales
        aliases:
          served: "Units sold"
          errors: "Unmet demand"
  edges:
    - id: edge1
      from: Supplier:out
      to: DistributorQueue:in
    - id: edge2
      from: DistributorQueue:out
      to: Distributor:in
    - id: edge3
      from: Distributor:out
      to: Retailer:in

nodes:
  - id: supplier_capacity
    kind: const
    values: ${supplierCapacity}

  - id: customer_demand_pmf
    kind: pmf
    pmf:
      values: [80, 120, 160, 140, 100, 60]
      probabilities: [0.15, 0.25, 0.2, 0.2, 0.15, 0.05]

  - id: customer_demand
    kind: expr
    expr: "customer_demand_pmf"
  - id: distributor_capacity
    kind: const
    values: ${distributorCapacity}

  - id: retailer_capacity
    kind: const
    values: ${retailerCapacity}

  - id: supplied_items
    kind: expr
    expr: "MIN(customer_demand, supplier_capacity)"
  - id: supplier_processing_time_ms_sum
    kind: expr
    expr: "supplied_items * 180"

  - id: queue_inflow
    kind: expr
    expr: "supplied_items"

  - id: queue_outflow
    kind: expr
    expr: "MIN(queue_inflow, distributor_capacity)"

  - id: queue_errors
    kind: expr
    expr: "0"

  - id: queue_depth
    kind: backlog
    inflow: queue_inflow
    outflow: queue_outflow
    loss: queue_errors

  - id: distributed_items
    kind: expr
    expr: "queue_outflow"
  - id: distributor_processing_time_ms_sum
    kind: expr
    expr: "distributed_items * 210"

  - id: retail_sales
    kind: expr
    expr: "MIN(distributed_items, retailer_capacity)"
  - id: retailer_processing_time_ms_sum
    kind: expr
    expr: "retail_sales * 260"

  - id: supplier_shortage
    kind: expr
    expr: "MAX(0, customer_demand - supplied_items)"

  - id: distributor_backlog
    kind: expr
    expr: "MAX(0, supplied_items - distributed_items)"

  - id: unmet_demand
    kind: expr
    expr: "MAX(0, customer_demand - retail_sales)"

  - id: supply_efficiency
    kind: expr
    expr: "retail_sales / customer_demand"

outputs:
  - series: customer_demand
    as: demand.csv
  - series: retail_sales
    as: sales.csv
  - series: unmet_demand
    as: stockouts.csv
  - series: supplier_shortage
    as: supplier_shortage.csv
  - series: distributor_backlog
    as: distributor_backlog.csv
  - series: queue_depth
    as: distributor_queue_depth.csv
  - series: queue_outflow
    as: distributor_queue_out.csv
  - series: supply_efficiency
    as: efficiency.csv
