schemaVersion: 1
generator: flowtime-sim
metadata:
  id: 'manufacturing-line'
  title: 'Manufacturing Production Line'
  description: 'Production line with raw-material variability, WIP buffering, and QC retries'
  version: 2.0.0
  captureKey: manufacturing-line-telemetry
  tags: [manufacturing, production, queue, retries]
window:
  start: 2025-01-01T00:00:00Z
  timezone: UTC

parameters:
  - name: bins
    type: integer
    title: "Time Periods"
    description: "Number of 5-minute bins (24h by default)"
    default: 288
    minimum: 12
    maximum: 288
  - name: binSize
    type: integer
    title: "Bin Size (minutes)"
    description: "Duration of each bin"
    default: 5
    minimum: 5
    maximum: 60
  - name: qcRetryRate
    type: number
    title: "QC Retry Rate"
    description: "Fraction of inspected units that require rework"
    default: 0.08
    minimum: 0.0
    maximum: 0.5
  - name: qcRetryFailureRate
    type: number
    title: "QC Retry Failure Rate"
    description: "Probability that a retry attempt still fails"
    default: 0.35
    minimum: 0.0
    maximum: 1.0
  - name: telemetryRawMaterialsSource
    type: string
    title: "Telemetry raw materials source"
    description: "Optional file:// URI for captured arrivals"
    default: ""

grid:
  bins: ${bins}
  binSize: ${binSize}
  binUnit: minutes

rng:
  kind: pcg32
  seed: 20250330

topology:
  nodes:
    - id: AssemblyLine
      kind: service
      semantics:
        arrivals: raw_materials
        served: assembly_output
        errors: assembly_scrap
        capacity: assembly_capacity
        processingTimeMsSum: assembly_processing_time_ms_sum
        servedCount: assembly_output
        aliases:
          arrivals: "Raw material feed"
          served: "Units assembled"
          errors: "Assembly scrap"
    - id: WipQueue
      kind: queue
      semantics:
        arrivals: wip_queue_inflow
        served: wip_queue_outflow
        errors: wip_queue_loss
        queueDepth: wip_queue_depth
        aliases:
          arrivals: "Units assembled"
          served: "Units staged"
          errors: "Queue attrition"
          queue: "WIP backlog"
      initialCondition:
        queueDepth: 30
    - id: QualityControl
      kind: service
      semantics:
        arrivals: wip_queue_outflow
        served: quality_served
        errors: quality_errors
        capacity: quality_capacity
        attempts: quality_attempts
        failures: qc_retry_failures
        retryEcho: qc_retry_echo
        retryKernel: [0.0, 0.6, 0.3, 0.1]
        processingTimeMsSum: quality_processing_time_ms_sum
        servedCount: quality_served
        aliases:
          served: "Units approved"
          errors: "QC rejects"
          attempts: "Inspection attempts"
          failures: "Failed rework"
          retryEcho: "Rework backlog"
    - id: PackagingStation
      kind: service
      semantics:
        arrivals: quality_served
        served: packaging
        errors: packaging_rejects
        capacity: packaging_capacity
        processingTimeMsSum: packaging_processing_time_ms_sum
        servedCount: packaging
        aliases:
          served: "Units packaged"
          errors: "Packaging rejects"
  edges:
    - id: assembly_to_queue
      from: AssemblyLine:out
      to: WipQueue:in
    - id: queue_to_quality
      from: WipQueue:out
      to: QualityControl:in
    - id: quality_to_packaging
      from: QualityControl:out
      to: PackagingStation:in

nodes:
  - id: raw_materials
    kind: pmf
    source: ${telemetryRawMaterialsSource}
    pmf:
      values: [70, 85, 95, 110, 125, 140, 155]
      probabilities: [0.04, 0.12, 0.24, 0.24, 0.18, 0.12, 0.06]
    profile:
      kind: builtin
      name: three-shift

  - id: assembly_capacity
    kind: pmf
    pmf:
      values: [80, 90, 100, 110, 120]
      probabilities: [0.1, 0.25, 0.3, 0.25, 0.1]
    profile:
      kind: builtin
      name: three-shift

  - id: quality_capacity
    kind: pmf
    pmf:
      values: [70, 80, 85, 90, 100]
      probabilities: [0.08, 0.22, 0.3, 0.25, 0.15]
    profile:
      kind: builtin
      name: three-shift

  - id: packaging_capacity
    kind: pmf
    pmf:
      values: [60, 70, 80, 90, 95]
      probabilities: [0.1, 0.2, 0.3, 0.25, 0.15]
    profile:
      kind: builtin
      name: three-shift

  - id: assembly_output
    kind: expr
    expr: "MIN(raw_materials, assembly_capacity)"

  - id: assembly_processing_time_ms_sum
    kind: expr
    expr: "assembly_output * 240"

  - id: assembly_scrap
    kind: expr
    expr: "MAX(0, raw_materials - assembly_output)"

  - id: wip_queue_inflow
    kind: expr
    expr: "assembly_output"

  - id: wip_queue_loss
    kind: expr
    expr: "0"

  - id: wip_queue_outflow
    kind: expr
    expr: "MIN(wip_queue_inflow, quality_capacity)"

  - id: wip_queue_depth
    kind: backlog
    inflow: wip_queue_inflow
    outflow: wip_queue_outflow
    loss: wip_queue_loss

  - id: qc_retry_attempts
    kind: expr
    expr: "${qcRetryRate} * wip_queue_outflow"

  - id: quality_attempts
    kind: expr
    expr: "wip_queue_outflow + qc_retry_attempts"

  - id: qc_retry_failures
    kind: expr
    expr: "${qcRetryFailureRate} * qc_retry_attempts"

  - id: quality_capacity_window
    kind: expr
    expr: "MIN(quality_attempts, quality_capacity)"

  - id: quality_served
    kind: expr
    expr: "MIN(wip_queue_outflow, MAX(0, quality_capacity_window - qc_retry_failures))"

  - id: quality_errors
    kind: expr
    expr: "MAX(0, wip_queue_outflow - quality_served)"

  - id: qc_retry_echo
    kind: expr
    expr: "CONV(qc_retry_attempts, [0.0, 0.6, 0.3, 0.1])"

  - id: quality_processing_time_ms_sum
    kind: expr
    expr: "quality_served * 300"

  - id: packaging
    kind: expr
    expr: "MIN(quality_served, packaging_capacity)"

  - id: packaging_processing_time_ms_sum
    kind: expr
    expr: "packaging * 360"

  - id: packaging_rejects
    kind: expr
    expr: "MAX(0, quality_served - packaging)"

outputs:
  - series: raw_materials
    as: raw_materials.csv
  - series: assembly_output
    as: units_assembled.csv
  - series: wip_queue_depth
    as: wip_queue_depth.csv
  - series: quality_served
    as: units_approved.csv
  - series: quality_errors
    as: qc_rejects.csv
  - series: packaging
    as: finished_goods.csv
