schemaVersion: 1
generator: flowtime-sim
metadata:
  id: 'supply-chain-multi-tier-warehouse-1d5m'
  title: 'Multi-Tier Supply Chain with Warehouse (1day, 5m)'
  description: '24h window at 5-minute bins with explicit warehouse buffer; conservative SLA channels'
  version: 1.0.0
  captureKey: supply-chain-multi-tier-warehouse-telemetry
  tags: [advanced, supply-chain, multi-tier, warehouse, inventory, logistics]
window:
  start: 2025-01-01T00:00:00Z
  timezone: UTC

grid:
  bins: 288
  binSize: 5
  binUnit: minutes

topology:
  nodes:
    - id: Supplier
      kind: service
      semantics:
        arrivals: planned_production
        served: supplier_shipments
        errors: supplier_shortage
        processingTimeMsSum: supplier_processing_time_ms_sum
        servedCount: supplier_shipments
        aliases:
          arrivals: "Planned production"
          served: "Supplier shipments"
          errors: "Supplier shortage"
    - id: Warehouse
      kind: service
      semantics:
        arrivals: supplier_shipments
        served: warehouse_shipments
        errors: inventory_build
        processingTimeMsSum: warehouse_processing_time_ms_sum
        servedCount: warehouse_shipments
        aliases:
          served: "Warehouse shipments"
          errors: "Inventory build"
    - id: DistributorQueue
      kind: queue
      semantics:
        arrivals: queue_inflow
        served: queue_outflow
        errors: queue_errors
        queueDepth: queue_depth
        aliases:
          served: "Loads released"
          queue: "Queue depth"
          errors: "Queue losses"
      initialCondition:
        queueDepth: 0
    - id: Distributor
      kind: service
      semantics:
        arrivals: queue_outflow
        served: distributed_items
        errors: distributor_backlog
        processingTimeMsSum: distributor_processing_time_ms_sum
        servedCount: distributed_items
        aliases:
          served: "Units distributed"
          errors: "Distributor backlog"
    - id: Retailer
      kind: service
      semantics:
        arrivals: distributed_items
        served: retail_sales
        errors: unmet_demand
        processingTimeMsSum: retailer_processing_time_ms_sum
        servedCount: retail_sales
        aliases:
          served: "Units sold"
          errors: "Unmet demand"
  edges:
    - id: e1
      from: Supplier:out
      to: Warehouse:in
    - id: e2
      from: Warehouse:out
      to: DistributorQueue:in
    - id: e2a
      from: DistributorQueue:out
      to: Distributor:in
    - id: e3
      from: Distributor:out
      to: Retailer:in

nodes:
  # External demand: per-hour shape expanded to 5-minute bins (12 bins per hour)
  - id: customer_demand
    kind: const
    values: [
      30,30,30,30,30,30,30,30,30,30,30,30,
      28,28,28,28,28,28,28,28,28,28,28,28,
      26,26,26,26,26,26,26,26,26,26,26,26,
      25,25,25,25,25,25,25,25,25,25,25,25,
      25,25,25,25,25,25,25,25,25,25,25,25,
      28,28,28,28,28,28,28,28,28,28,28,28,
      40,40,40,40,40,40,40,40,40,40,40,40,
      60,60,60,60,60,60,60,60,60,60,60,60,
      80,80,80,80,80,80,80,80,80,80,80,80,
      100,100,100,100,100,100,100,100,100,100,100,100,
      120,120,120,120,120,120,120,120,120,120,120,120,
      140,140,140,140,140,140,140,140,140,140,140,140,
      160,160,160,160,160,160,160,160,160,160,160,160,
      160,160,160,160,160,160,160,160,160,160,160,160,
      150,150,150,150,150,150,150,150,150,150,150,150,
      140,140,140,140,140,140,140,140,140,140,140,140,
      130,130,130,130,130,130,130,130,130,130,130,130,
      170,170,170,170,170,170,170,170,170,170,170,170,
      180,180,180,180,180,180,180,180,180,180,180,180,
      160,160,160,160,160,160,160,160,160,160,160,160,
      120,120,120,120,120,120,120,120,120,120,120,120,
      90,90,90,90,90,90,90,90,90,90,90,90,
      60,60,60,60,60,60,60,60,60,60,60,60,
      40,40,40,40,40,40,40,40,40,40,40,40
    ]

  - id: supplier_capacity
    kind: const
    values: [
      # H00
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H01
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H02
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H03
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H04
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H05
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H06
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H07
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H08
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H09
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H10
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H11
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H12 (midday shortage)
      100,100,100,100,100,100,100,100,100,100,100,100,
      # H13 (midday shortage)
      100,100,100,100,100,100,100,100,100,100,100,100,
      # H14
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H15
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H16
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H17
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H18 (evening partial shortage)
      140,140,140,140,140,140,140,140,140,140,140,140,
      # H19 (evening partial shortage)
      140,140,140,140,140,140,140,140,140,140,140,140,
      # H20
      180,180,180,180,180,180,180,180,180,180,180,180,
      # H21
      180,180,180,180,180,180,180,180,180,180,180,180,
      # H22
      220,220,220,220,220,220,220,220,220,220,220,220,
      # H23
      220,220,220,220,220,220,220,220,220,220,220,220
    ]

  - id: distributor_capacity
    kind: const
    values: [
      # H00
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H01
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H02
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H03
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H04
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H05
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H06
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H07
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H08
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H09
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H10
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H11
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H12
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H13
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H14
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H15
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H16
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H17
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H18 (bottleneck)
      100,100,100,100,100,100,100,100,100,100,100,100,
      # H19 (bottleneck)
      100,100,100,100,100,100,100,100,100,100,100,100,
      # H20
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H21
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H22
      165,165,165,165,165,165,165,165,165,165,165,165,
      # H23
      165,165,165,165,165,165,165,165,165,165,165,165
    ]

  - id: retailer_capacity
    kind: const
    values: [
      # H00–H06
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      # H07 (morning dip)
      90,90,90,90,90,90,90,90,90,90,90,90,
      # H08 (morning dip)
      90,90,90,90,90,90,90,90,90,90,90,90,
      # H09–H19
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      # H20 (evening dip)
      100,100,100,100,100,100,100,100,100,100,100,100,
      # H21–H23
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120,
      120,120,120,120,120,120,120,120,120,120,120,120
    ]

  # Planning and shipments
  - id: planned_production
    kind: expr
    expr: "MIN(customer_demand * 1.2, supplier_capacity)"

  - id: supplier_shipments
    kind: expr
    expr: "planned_production"
  - id: supplier_processing_time_ms_sum
    kind: expr
    expr: "supplier_shipments * 180"

  # Downstream pull and availability
  - id: downstream_cap
    kind: expr
    expr: "MIN(distributor_capacity, retailer_capacity)"

  - id: requested_shipments
    kind: expr
    expr: "MIN(customer_demand, retailer_capacity)"

  - id: warehouse_shipments
    kind: expr
    expr: "MIN(supplier_shipments, requested_shipments)"
  - id: warehouse_processing_time_ms_sum
    kind: expr
    expr: "warehouse_shipments * 220"

  # Queue between Warehouse and Distributor
  - id: queue_inflow
    kind: expr
    expr: "warehouse_shipments"

  - id: queue_outflow
    kind: expr
    # Serve up to distributor capacity, bounded by available queue + inflow this bin
    expr: "MIN(distributor_capacity, queue_inflow)"

  - id: queue_errors
    kind: expr
    expr: "0"

  # Approximate queue depth at bin(t) without recursion (no SHIFT to avoid cycles)
  # This is not a true backlog accumulation; it's a per-bin proxy
  - id: queue_depth
    kind: expr
    expr: "MAX(0, queue_inflow - queue_outflow)"

  # Surplus this bin that remains in warehouse
  - id: inventory_build
    kind: expr
    expr: "MAX(0, supplier_shipments - warehouse_shipments)"

  # Downstream flows
  - id: distributed_items
    kind: expr
    # Outbound from distributor equals queue outflow
    expr: "queue_outflow"
  - id: distributor_processing_time_ms_sum
    kind: expr
    expr: "distributed_items * 210"

  - id: retail_sales
    kind: expr
    expr: "MIN(distributed_items, retailer_capacity)"
  - id: retailer_processing_time_ms_sum
    kind: expr
    expr: "retail_sales * 260"

  # Diagnostics
  - id: supplier_shortage
    kind: expr
    expr: "MAX(0, customer_demand - supplier_shipments)"

  - id: distributor_backlog
    kind: expr
    # Backlog relative to queue inflow/outflow
    expr: "MAX(0, queue_inflow - queue_outflow)"

  - id: unmet_demand
    kind: expr
    expr: "MAX(0, customer_demand - retail_sales)"

  - id: supply_efficiency
    kind: expr
    expr: "retail_sales / customer_demand"

outputs:
  - series: customer_demand
    as: demand.csv
  - series: planned_production
    as: planned_production.csv
  - series: supplier_shipments
    as: supplier_shipments.csv
  - series: warehouse_shipments
    as: warehouse_shipments.csv
  - series: distributed_items
    as: distributed.csv
  - series: queue_inflow
    as: queue_inflow.csv
  - series: queue_outflow
    as: queue_outflow.csv
  - series: queue_errors
    as: queue_errors.csv
  - series: queue_depth
    as: queue_depth.csv
  - series: retail_sales
    as: sales.csv
  - series: distributor_backlog
    as: distributor_backlog.csv
  - series: supplier_shortage
    as: supplier_shortage.csv
  - series: unmet_demand
    as: stockouts.csv
  - series: supply_efficiency
    as: efficiency.csv
  - series: inventory_build
    as: inventory_build.csv
