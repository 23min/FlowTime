schemaVersion: 1
generator: flowtime-sim
metadata:
  id: 'transportation-basic'
  title: 'Transportation Network with Hub Queue'
  description: 'North/South origins feed a central hub with an outbound queue and airport retries.'
  version: 3.0.0
  captureKey: transportation-network-telemetry
  tags: [transportation, transit, queue, retries]
window:
  start: 2025-01-01T00:00:00Z
  timezone: UTC

parameters:
  - name: bins
    type: integer
    title: "Time Periods"
    description: "Number of 5-minute bins (24h default)"
    default: 288
    minimum: 12
    maximum: 288
  - name: binSize
    type: integer
    title: "Period Duration"
    description: "Minutes per bin"
    default: 5
    minimum: 5
    maximum: 60
  - name: splitAirport
    type: number
    title: "Hub → Airport Split"
    description: "Fraction of hub dispatch routed to Airport"
    default: 0.3
    minimum: 0.0
    maximum: 1.0
  - name: splitIndustrial
    type: number
    title: "Hub → Industrial Split"
    description: "Fraction of hub dispatch routed to Industrial Park"
    default: 0.2
    minimum: 0.0
    maximum: 1.0
  - name: hubRetryRate
    type: number
    title: "Airport Retry Rate"
    description: "Fraction of airport passengers requiring re-boarding"
    default: 0.12
    minimum: 0.0
    maximum: 1.0
  - name: hubRetryFailureRate
    type: number
    title: "Airport Failed Retry Rate"
    description: "Fraction of airport retry attempts that still fail"
    default: 0.25
    minimum: 0.0
    maximum: 1.0
  - name: telemetryDemandNorthSource
    type: string
    title: "Telemetry North demand source"
    description: "Optional file:// URI for North arrivals"
    default: ""
  - name: telemetryDemandSouthSource
    type: string
    title: "Telemetry South demand source"
    description: "Optional file:// URI for South arrivals"
    default: ""

grid:
  bins: ${bins}
  binSize: ${binSize}
  binUnit: minutes

rng:
  kind: pcg32
  seed: 20250327

topology:
  nodes:
    - id: OriginNorth
      kind: service
      semantics:
        arrivals: arrivals_north
        served: served_north
        errors: unmet_north
        processingTimeMsSum: origin_north_processing_time_ms_sum
        servedCount: served_north
        aliases:
          arrivals: "Northbound demand"
          served: "North → hub passengers"
          errors: "Unserved north riders"
    - id: OriginSouth
      kind: service
      semantics:
        arrivals: arrivals_south
        served: served_south
        errors: unmet_south
        processingTimeMsSum: origin_south_processing_time_ms_sum
        servedCount: served_south
        aliases:
          arrivals: "Southbound demand"
          served: "South → hub passengers"
          errors: "Unserved south riders"
    - id: CentralHub
      kind: service
      semantics:
        arrivals: arrivals_hub
        served: served_hub
        errors: unmet_hub
        capacity: cap_hub
        processingTimeMsSum: hub_processing_time_ms_sum
        servedCount: served_hub
        aliases:
          served: "Hub throughput"
          errors: "Hub overflow"
    - id: HubQueue
      kind: queue
      semantics:
        arrivals: hub_queue_inflow
        served: hub_dispatch
        errors: hub_queue_abandon
        queueDepth: hub_queue_depth
        aliases:
          arrivals: "Hub throughput"
          served: "Dispatched riders"
          errors: "Queue attrition"
          queue: "Hub backlog"
      initialCondition:
        queueDepth: 20
    - id: LineAirport
      kind: service
      semantics:
        arrivals: arrivals_airport
        served: served_airport
        errors: errors_airport
        capacity: cap_airport
        attempts: airport_attempts
        failures: airport_retry_failures
        retryEcho: airport_retry_echo
        retryKernel: [0.0, 0.6, 0.3, 0.1]
        processingTimeMsSum: airport_processing_time_ms_sum
        servedCount: served_airport
        aliases:
          arrivals: "Airport-bound riders"
          served: "Airport departures"
          errors: "Failed departures"
          attempts: "Airport attempts"
          failures: "Airport failed retries"
    - id: LineDowntown
      kind: service
      semantics:
        arrivals: arrivals_downtown
        served: served_downtown
        errors: unmet_downtown
        capacity: cap_downtown
        processingTimeMsSum: downtown_processing_time_ms_sum
        servedCount: served_downtown
        aliases:
          served: "Downtown departures"
          errors: "Downtown overflow"
    - id: LineIndustrial
      kind: service
      semantics:
        arrivals: arrivals_industrial
        served: served_industrial
        errors: unmet_industrial
        capacity: cap_industrial
        processingTimeMsSum: industrial_processing_time_ms_sum
        servedCount: served_industrial
        aliases:
          served: "Industrial departures"
          errors: "Industrial overflow"
  edges:
    - id: north_to_hub
      from: OriginNorth:out
      to: CentralHub:in
    - id: south_to_hub
      from: OriginSouth:out
      to: CentralHub:in
    - id: hub_to_queue
      from: CentralHub:out
      to: HubQueue:in
    - id: queue_to_airport
      from: HubQueue:out
      to: LineAirport:in
    - id: queue_to_downtown
      from: HubQueue:out
      to: LineDowntown:in
    - id: queue_to_industrial
      from: HubQueue:out
      to: LineIndustrial:in

nodes:
  - id: arrivals_north
    kind: pmf
    source: ${telemetryDemandNorthSource}
    pmf:
      values: [8, 12, 16, 20, 26]
      probabilities: [0.1, 0.2, 0.3, 0.25, 0.15]
  - id: arrivals_south
    kind: pmf
    source: ${telemetryDemandSouthSource}
    pmf:
      values: [6, 10, 14, 18, 22]
      probabilities: [0.12, 0.24, 0.28, 0.22, 0.14]

  - id: cap_north
    kind: pmf
    pmf:
      values: [12, 15, 18, 22, 26]
      probabilities: [0.08, 0.2, 0.32, 0.25, 0.15]
  - id: cap_south
    kind: pmf
    pmf:
      values: [10, 13, 16, 19, 22]
      probabilities: [0.1, 0.22, 0.3, 0.24, 0.14]
  - id: cap_hub
    kind: pmf
    pmf:
      values: [24, 28, 32, 36, 40]
      probabilities: [0.1, 0.2, 0.3, 0.25, 0.15]
  - id: hub_dispatch_capacity
    kind: pmf
    pmf:
      values: [20, 24, 28, 32, 36]
      probabilities: [0.1, 0.2, 0.3, 0.25, 0.15]
  - id: cap_airport
    kind: pmf
    pmf:
      values: [8, 10, 12, 14]
      probabilities: [0.15, 0.35, 0.3, 0.2]
  - id: cap_downtown
    kind: pmf
    pmf:
      values: [10, 14, 18, 22]
      probabilities: [0.1, 0.25, 0.35, 0.3]
  - id: cap_industrial
    kind: pmf
    pmf:
      values: [6, 8, 10, 12]
      probabilities: [0.15, 0.35, 0.3, 0.2]

  - id: served_north
    kind: expr
    expr: "MIN(arrivals_north, cap_north)"
  - id: served_south
    kind: expr
    expr: "MIN(arrivals_south, cap_south)"
  - id: unmet_north
    kind: expr
    expr: "MAX(0, arrivals_north - cap_north)"
  - id: unmet_south
    kind: expr
    expr: "MAX(0, arrivals_south - cap_south)"
  - id: origin_north_processing_time_ms_sum
    kind: expr
    expr: "served_north * 40"
  - id: origin_south_processing_time_ms_sum
    kind: expr
    expr: "served_south * 40"

  - id: arrivals_hub
    kind: expr
    expr: "served_north + served_south"
  - id: served_hub
    kind: expr
    expr: "MIN(arrivals_hub, cap_hub)"
  - id: unmet_hub
    kind: expr
    expr: "MAX(0, arrivals_hub - cap_hub)"
  - id: hub_processing_time_ms_sum
    kind: expr
    expr: "served_hub * 55"

  - id: hub_queue_inflow
    kind: expr
    expr: "served_hub"
  - id: hub_queue_abandon
    kind: expr
    expr: "0"
  - id: hub_dispatch
    kind: expr
    expr: "MIN(hub_queue_inflow, hub_dispatch_capacity)"

  - id: hub_queue_depth
    kind: backlog
    inflow: hub_queue_inflow
    outflow: hub_dispatch
    loss: hub_queue_abandon

  - id: hub_dispatch_airport
    kind: expr
    expr: "hub_dispatch * ${splitAirport}"
  - id: hub_dispatch_industrial
    kind: expr
    expr: "hub_dispatch * ${splitIndustrial}"
  - id: hub_dispatch_downtown
    kind: expr
    expr: "hub_dispatch - hub_dispatch_airport - hub_dispatch_industrial"

  - id: arrivals_airport
    kind: expr
    expr: "hub_dispatch_airport"
  - id: arrivals_industrial
    kind: expr
    expr: "hub_dispatch_industrial"
  - id: arrivals_downtown
    kind: expr
    expr: "hub_dispatch_downtown"

  - id: airport_retry_attempts
    kind: expr
    expr: "${hubRetryRate} * arrivals_airport"
  - id: airport_attempts
    kind: expr
    expr: "arrivals_airport + airport_retry_attempts"
  - id: airport_capacity_served
    kind: expr
    expr: "MIN(airport_attempts, cap_airport)"
  - id: airport_retry_failures
    kind: expr
    expr: "${hubRetryFailureRate} * airport_retry_attempts"
  - id: served_airport
    kind: expr
    expr: "MIN(arrivals_airport, MAX(0, airport_capacity_served - airport_retry_failures))"
  - id: errors_airport
    kind: expr
    expr: "MAX(0, arrivals_airport - served_airport)"
  - id: airport_retry_echo
    kind: expr
    expr: "CONV(airport_retry_attempts, [0.0, 0.6, 0.3, 0.1])"
  - id: airport_processing_time_ms_sum
    kind: expr
    expr: "served_airport * 75"

  - id: served_downtown
    kind: expr
    expr: "MIN(arrivals_downtown, cap_downtown)"
  - id: unmet_downtown
    kind: expr
    expr: "MAX(0, arrivals_downtown - cap_downtown)"
  - id: downtown_processing_time_ms_sum
    kind: expr
    expr: "served_downtown * 60"

  - id: served_industrial
    kind: expr
    expr: "MIN(arrivals_industrial, cap_industrial)"
  - id: unmet_industrial
    kind: expr
    expr: "MAX(0, arrivals_industrial - cap_industrial)"
  - id: industrial_processing_time_ms_sum
    kind: expr
    expr: "served_industrial * 60"

outputs:
  - series: arrivals_north
    as: north_demand.csv
  - series: arrivals_south
    as: south_demand.csv
  - series: hub_queue_depth
    as: hub_queue_depth.csv
  - series: hub_dispatch
    as: hub_dispatch.csv
  - series: served_airport
    as: airport_served.csv
  - series: airport_attempts
    as: airport_attempts.csv
  - series: airport_retry_failures
    as: airport_retry_failures.csv
  - series: served_downtown
    as: downtown_served.csv
  - series: served_industrial
    as: industrial_served.csv
